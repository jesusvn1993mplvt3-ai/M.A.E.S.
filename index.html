<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cirineo Kit Maker (4x6)</title>
    
    <link rel="icon" href="https://raw.githubusercontent.com/jesusvn1993mplvt3-ai/CIRINEO/refs/heads/main/icon.ico">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.0/dist/JsBarcode.all.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@400;700&family=Roboto+Condensed:wght@400;700&display=swap" rel="stylesheet">

    <style>
        body { background-color: #e2e8f0; font-family: 'Roboto Condensed', sans-serif; overflow: hidden; }
        
        /* --- EL LIENZO 4x6 --- */
        .kit-label-container {
            width: 4in;
            height: 6in;
            background: white;
            border: 1px solid #ccc; /* Borde solo para pantalla */
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            position: relative;
            overflow: hidden;
            page-break-inside: avoid;
        }

        /* En el PDF quitamos el borde visual */
        @media print { .kit-label-container { border: none; } }

        /* Tipografía */
        .txt-model { font-family: 'Oswald'; font-weight: 700; line-height: 0.9; }
        .txt-qty { font-family: 'Oswald'; font-weight: 700; line-height: 1; color: #000; }
        
        /* Tabla del Kit */
        .kit-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        .kit-table th { text-align: left; font-size: 10px; border-bottom: 2px solid #000; color: #555; padding: 2px; }
        .kit-table td { border-bottom: 1px solid #ddd; padding: 4px 2px; vertical-align: middle; }
        .kit-row-even { background-color: #f8fafc; }

        /* Scrollbar del sidebar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 3px; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;
        
        const firebaseConfig = { apiKey: "AIzaSyCngQL1pdqghv2vbjkPycT1Xf0C46f7jYs", authDomain: "cirineo-cec21.firebaseapp.com", projectId: "cirineo-cec21", storageBucket: "cirineo-cec21.firebasestorage.app", messagingSenderId: "620210618284", appId: "1:620210618284:web:482bab9bf74650fff18409" };
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        const Icon = ({ name, size=16 }) => {
            const r = useRef(null);
            useEffect(() => { if (r.current && lucide.icons[name]) r.current.innerHTML = lucide.icons[name].toSvg({ width: size, height: size }); }, [name, size]);
            return <span ref={r} className="inline-flex items-center justify-center"/>;
        };

        // --- SABUESO DE IMÁGENES (Buscador Recursivo) ---
        const SmartImage = ({ modelo, repos }) => {
            const [currentSrc, setCurrentSrc] = useState(null);
            const [attemptIndex, setAttemptIndex] = useState(0);
            
            const candidateUrls = useMemo(() => {
                if (!modelo || !repos || repos.length === 0) return [];
                const candidates = [];
                const extensions = ['png', 'web', 'jpg', 'jpeg'];
                // Prioridad: Exacto -> Minúscula -> Sufijos
                const variations = [
                    modelo, 
                    modelo.toLowerCase(), 
                    `${modelo}FRENTE`, `${modelo.toLowerCase()}frente`,
                    `${modelo}DELANTERO`, `${modelo}ESPALDA`, `${modelo}MANGA`
                ];

                repos.forEach(repo => {
                    const baseUrl = repo.url.endsWith('/') ? repo.url : repo.url + '/';
                    variations.forEach(name => {
                        extensions.forEach(ext => candidates.push(`${baseUrl}${name}.${ext}`));
                    });
                });
                return candidates;
            }, [modelo, repos]);

            useEffect(() => {
                setAttemptIndex(0);
                if(candidateUrls.length > 0) setCurrentSrc(candidateUrls[0]);
                else setCurrentSrc(null);
            }, [candidateUrls]);

            const handleError = () => {
                const next = attemptIndex + 1;
                if (next < candidateUrls.length) { setAttemptIndex(next); setCurrentSrc(candidateUrls[next]); }
                else setCurrentSrc(null);
            };

            if (!currentSrc) return <div className="w-full h-full flex flex-col items-center justify-center text-gray-300 bg-slate-50"><Icon name="image-off" size={32}/><span className="text-[10px] font-bold mt-1">SIN FOTO</span></div>;
            return <img src={currentSrc} onError={handleError} className="w-full h-full object-contain" />;
        };

        // --- COMPONENTE: FICHA TÉCNICA 4x6 ---
        const KitLabel = ({ selectedPackages, groupInfo, repos }) => {
            const svgRef = useRef(null);
            
            // Generar Código Maestro para el Escáner
            const indexes = selectedPackages.map(p => p.paqueteNum).join(',');
            const barcodeValue = `GRP|${groupInfo.modelo}|${groupInfo.partida}|${indexes}`;

            useEffect(() => {
                if (svgRef.current && barcodeValue) {
                    try {
                        JsBarcode(svgRef.current, barcodeValue, { 
                            format: "CODE128", width: 2, height: 60, displayValue: false, margin: 5, fontSize: 12
                        });
                    } catch (e) {}
                }
            }, [barcodeValue]);

            return (
                <div className="kit-label-container">
                    {/* ENCABEZADO: MODELO Y PARTIDA (OCUPA 15%) */}
                    <div className="h-[15%] bg-black text-white p-2 flex justify-between items-center border-b-4 border-yellow-400">
                        <div className="flex flex-col">
                            <span className="text-[10px] text-gray-400 font-bold uppercase tracking-widest">MODELO</span>
                            <span className="txt-model text-5xl">{groupInfo.modelo}</span>
                        </div>
                        <div className="flex flex-col items-end">
                            <span className="text-[10px] text-gray-400 font-bold">PARTIDA</span>
                            <span className="font-bold text-xl text-yellow-400">{groupInfo.partida}</span>
                        </div>
                    </div>

                    {/* CUERPO CENTRAL (OCUPA 65%) */}
                    <div className="h-[65%] flex">
                        {/* COLUMNA IZQUIERDA: IMAGEN (40%) */}
                        <div className="w-[40%] border-r border-black p-2 flex flex-col justify-center bg-white">
                            <div className="flex-1 overflow-hidden relative">
                                <SmartImage modelo={groupInfo.modelo} repos={repos} />
                            </div>
                            <div className="mt-2 text-[10px] text-center text-gray-500 font-bold">
                                {selectedPackages.length} PAQUETES EN KIT
                            </div>
                        </div>

                        {/* COLUMNA DERECHA: LISTA DE CONTENIDO (60%) */}
                        <div className="w-[60%] p-2 flex flex-col bg-white overflow-hidden relative">
                            <div className="text-xs font-black uppercase border-b border-black mb-1 pb-1 flex justify-between">
                                <span>CONTENIDO DEL KIT</span>
                                <span className="text-gray-400">{groupInfo.cliente}</span>
                            </div>
                            
                            {/* TABLA DE CONTENIDO PRIORIZANDO CANTIDAD */}
                            <div className="flex-1">
                                <table className="kit-table">
                                    <thead>
                                        <tr>
                                            <th className="w-[25%] text-center">CANT.</th>
                                            <th className="w-[50%]">PIEZA</th>
                                            <th className="w-[25%] text-right">#PQT</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {selectedPackages.map((pkg, idx) => (
                                            <tr key={idx} className={idx % 2 === 0 ? "kit-row-even" : ""}>
                                                <td className="text-center">
                                                    {/* LA CANTIDAD ES LA PRIORIDAD VISUAL */}
                                                    <span className="txt-qty text-3xl">{pkg.cantidad}</span>
                                                </td>
                                                <td>
                                                    <span className="font-bold text-sm leading-tight block uppercase">
                                                        {pkg.fullPiezaName?.split(' ')[0] || "PIEZA"}
                                                    </span>
                                                    {pkg.fullPiezaName?.split(' ').length > 1 && (
                                                        <span className="text-[9px] text-gray-400 block truncate">
                                                            {pkg.fullPiezaName?.substring(pkg.fullPiezaName?.indexOf(' '))}
                                                        </span>
                                                    )}
                                                </td>
                                                <td className="text-right">
                                                    <span className="bg-black text-white px-2 py-0.5 rounded text-xs font-bold">
                                                        {pkg.paqueteNum}
                                                    </span>
                                                </td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    {/* PIE DE PAGINA: CÓDIGO DE BARRAS (20%) */}
                    <div className="h-[20%] border-t-2 border-black flex flex-col items-center justify-center bg-white p-2">
                        <svg ref={svgRef} className="w-full h-full"></svg>
                        <div className="text-[8px] font-mono text-center w-full mt-1 truncate">
                            {barcodeValue}
                        </div>
                    </div>
                </div>
            );
        };

        // --- APP PRINCIPAL ---
        const App = () => {
            const [groupedOrders, setGroupedOrders] = useState({});
            const [selectedGroupKey, setSelectedGroupKey] = useState(null);
            const [checkedPackages, setCheckedPackages] = useState({});
            const [repos, setRepos] = useState([]);
            const [isGenerating, setIsGenerating] = useState(false);
            const [filterText, setFilterText] = useState("");
            const pdfRef = useRef(null);

            useEffect(() => {
                db.collection('app_config').doc('imagenes').onSnapshot(d => setRepos(d.data()?.sources || []));
                
                db.collection('orders').where('status', '!=', 'ARCHIVADO').onSnapshot(s => {
                     const groups = {};
                     s.docs.forEach(doc => {
                         const data = doc.data();
                         // Agrupar por MODELO + PARTIDA
                         const key = `${data.codigo}|${data.partida || 'SN'}`;
                         if (!groups[key]) {
                             groups[key] = {
                                 key: key,
                                 modelo: data.codigo,
                                 partida: data.partida || 'SN',
                                 cliente: data.cliente,
                                 subOrders: [] 
                             };
                         }
                         groups[key].subOrders.push({ ...data, id: doc.id });
                     });
                     setGroupedOrders(groups);
                 });
            }, []);

            // Obtener paquetes combinados de todas las sub-órdenes
            const activePackages = useMemo(() => {
                if (!selectedGroupKey || !groupedOrders[selectedGroupKey]) return [];
                const group = groupedOrders[selectedGroupKey];
                let allPkgs = [];
                
                group.subOrders.forEach(order => {
                    if (order.progreso) {
                        order.progreso.forEach(p => {
                            // Guardamos todo lo necesario
                            allPkgs.push({ 
                                ...p, 
                                originOrderId: order.id, 
                                fullPiezaName: p.piezaNombre,
                                cantidad: p.cantidad || 0 // Aseguramos que exista cantidad
                            });
                        });
                    }
                });
                return allPkgs.sort((a,b) => a.paqueteNum - b.paqueteNum);
            }, [selectedGroupKey, groupedOrders]);

            useEffect(() => { setCheckedPackages({}); }, [selectedGroupKey]);

            const togglePackage = (pkg) => {
                setCheckedPackages(prev => ({...prev, [pkg.codigoUnico]: !prev[pkg.codigoUnico]}));
            };

            const selectedList = useMemo(() => {
                return activePackages.filter(p => checkedPackages[p.codigoUnico]);
            }, [activePackages, checkedPackages]);

            const filteredGroups = useMemo(() => {
                if(!filterText) return Object.values(groupedOrders);
                return Object.values(groupedOrders).filter(g => 
                    g.modelo.toUpperCase().includes(filterText.toUpperCase()) || 
                    g.cliente.toUpperCase().includes(filterText.toUpperCase())
                );
            }, [groupedOrders, filterText]);

            const downloadPDF = async () => {
                if(selectedList.length === 0) return;
                setIsGenerating(true);
                await new Promise(r => setTimeout(r, 500));
                
                const element = pdfRef.current;
                const opt = {
                    margin: 0,
                    filename: `KIT_${groupedOrders[selectedGroupKey].modelo}_${selectedList.length}PZS.pdf`,
                    image: { type: 'jpeg', quality: 1.0 },
                    html2canvas: { scale: 2, useCORS: true, logging: false },
                    // AQUÍ ESTÁ LA MAGIA: 4x6 PULGADAS
                    jsPDF: { unit: 'in', format: [4, 6], orientation: 'portrait' }
                };
                
                try { await html2pdf().set(opt).from(element).save(); } catch(e){ console.error(e); alert("Error PDF"); }
                setIsGenerating(false);
            };

            return (
                <div className="flex h-screen overflow-hidden bg-slate-100">
                    {/* SIDEBAR */}
                    <div className="w-80 bg-slate-900 text-white flex flex-col shrink-0 shadow-2xl z-20">
                        <div className="p-5 bg-slate-800 border-b border-slate-700">
                            <h1 className="text-2xl font-black text-green-400 flex items-center gap-2 italic tracking-tighter">
                                <Icon name="package" size={24}/> KIT MAKER <span className="text-xs bg-green-500 text-black px-1 rounded not-italic">4x6"</span>
                            </h1>
                            <input type="text" placeholder="Buscar modelo..." 
                                onChange={e => setFilterText(e.target.value)}
                                className="w-full mt-4 bg-slate-700/50 border border-slate-600 rounded p-2 text-sm focus:outline-none focus:border-green-400 transition-colors"/>
                        </div>
                        <div className="flex-1 overflow-y-auto p-3 space-y-2">
                            {filteredGroups.sort((a,b) => b.modelo.localeCompare(a.modelo)).map(group => (
                                <div key={group.key} onClick={() => setSelectedGroupKey(group.key)} 
                                     className={`p-3 rounded-lg cursor-pointer border-l-4 transition-all group
                                         ${selectedGroupKey === group.key ? 'border-green-400 bg-white/10' : 'border-transparent hover:bg-white/5'}`}>
                                    <div className="flex justify-between items-center">
                                        <span className="font-bold text-lg group-hover:text-green-200">{group.modelo}</span>
                                        <span className="text-[10px] font-mono bg-black/40 px-2 py-0.5 rounded text-slate-300">{group.partida}</span>
                                    </div>
                                    <div className="flex justify-between mt-1 items-end">
                                        <span className="text-xs text-slate-400 truncate w-32">{group.cliente}</span>
                                        <span className="text-[10px] text-blue-300 bg-blue-900/30 px-2 rounded">{group.subOrders.length} fuentes</span>
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>

                    {/* MAIN AREA */}
                    <div className="flex-1 flex flex-col relative overflow-hidden">
                        {selectedGroupKey ? (
                            <>
                                {/* HEADER DE ACCIÓN */}
                                <div className="bg-white p-4 border-b shadow-sm z-10 flex flex-col gap-4">
                                    <div className="flex justify-between items-center">
                                        <div>
                                            <h2 className="text-3xl font-black text-slate-800 flex items-center gap-3">
                                                {groupedOrders[selectedGroupKey].modelo}
                                            </h2>
                                            <p className="text-sm text-slate-500 font-bold">Selecciona las partes para armar el KIT</p>
                                        </div>
                                        <button onClick={downloadPDF} disabled={selectedList.length === 0 || isGenerating}
                                                className={`px-6 py-3 rounded-xl font-black text-white flex items-center gap-2 shadow-lg transition-transform active:scale-95
                                                    ${selectedList.length === 0 ? 'bg-slate-300 cursor-not-allowed' : 'bg-green-600 hover:bg-green-700'}`}>
                                            {isGenerating ? 'GENERANDO...' : <><Icon name="printer"/> IMPRIMIR FICHA 4x6"</>}
                                        </button>
                                    </div>
                                    
                                    {/* SELECTOR DE PAQUETES */}
                                    <div className="flex flex-wrap gap-2 max-h-40 overflow-y-auto p-3 bg-slate-50 rounded-xl border border-slate-200 shadow-inner">
                                        {activePackages.map(p => (
                                            <div key={p.codigoUnico} onClick={() => togglePackage(p)}
                                                   className={`flex items-center gap-3 px-3 py-2 rounded border cursor-pointer select-none transition-all text-sm w-52
                                                       ${checkedPackages[p.codigoUnico] ? 'bg-green-600 border-green-600 text-white shadow-md' : 'bg-white border-slate-300 hover:border-green-400 text-slate-600'}`}>
                                                <div className={`w-5 h-5 rounded flex items-center justify-center border ${checkedPackages[p.codigoUnico] ? 'border-white bg-green-500' : 'border-slate-300'}`}>
                                                    {checkedPackages[p.codigoUnico] && <Icon name="check" size={12}/>}
                                                </div>
                                                <div className="flex flex-col overflow-hidden w-full">
                                                    <div className="flex justify-between items-center w-full">
                                                        <span className="font-black text-lg leading-none">#{p.paqueteNum}</span>
                                                        <span className="text-xs font-bold bg-black/20 px-1 rounded">{p.cantidad} pzs</span>
                                                    </div>
                                                    <span className="text-[10px] opacity-90 truncate uppercase mt-0.5">{p.fullPiezaName}</span>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </div>

                                {/* AREA DE VISUALIZACIÓN */}
                                <div className="flex-1 overflow-y-auto p-8 bg-slate-200 flex justify-center items-start">
                                    {selectedList.length > 0 ? (
                                        <div className="shadow-2xl shadow-slate-500/50 bg-white">
                                            {/* ESTE DIV ES EL QUE SE IMPRIME */}
                                            <div ref={pdfRef}>
                                                <KitLabel selectedPackages={selectedList} groupInfo={groupedOrders[selectedGroupKey]} repos={repos} />
                                            </div>
                                        </div>
                                    ) : (
                                        <div className="flex flex-col items-center justify-center text-slate-400 mt-20 select-none opacity-60">
                                            <Icon name="layers" size={80} strokeWidth={1}/>
                                            <p className="font-bold mt-4 text-xl">Arma tu kit arriba</p>
                                        </div>
                                    )}
                                </div>
                            </>
                        ) : (
                            <div className="flex-1 flex flex-col items-center justify-center text-slate-300 select-none">
                                <Icon name="arrow-left-circle" size={80} strokeWidth={1}/>
                                <p className="font-black text-2xl mt-4">SELECCIONA UN MODELO</p>
                            </div>
                        )}
                    </div>
                </div>
            );
        };
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>