<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Producción Textil v3.0 - MultiPieza</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* Estilos EXCLUSIVOS para Impresión */
        @media print {
            body { background: white; -webkit-print-color-adjust: exact; }
            .no-print { display: none !important; }
            .print-only { display: block !important; }
            .page-break { page-break-before: always; }
            /* Asegura bordes negros definidos para que el tejedor escriba */
            table, th, td { border-color: #000 !important; }
        }
        .print-only { display: none; } /* Oculto en pantalla normal */
    </style>
</head>
<body class="bg-slate-100 text-slate-800 font-sans">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        // --- FUNCIONES AUXILIARES ---

        /** 
         * Genera el ID compuesto: [Inicial Cliente]-[Consecutivo]-[Sufijo Pieza]
         * Ej: O-00000001-bl
         */
        const generateID = (clientName, sequence, pieceName) => {
            const clientInitial = clientName ? clientName.charAt(0).toUpperCase() : 'X';
            const seqString = String(sequence).padStart(8, '0');
            
            // Lógica para abreviación (toma las primeras 2 letras o mapeo manual)
            let suffix = 'xx';
            if (pieceName) {
                const lower = pieceName.toLowerCase();
                if (lower.includes('manga') && lower.includes('larga')) suffix = 'ml'; // Caso especial Manga Larga
                else if (lower.includes('manga') && lower.includes('corta')) suffix = 'mc'; 
                else suffix = lower.substring(0, 2);
            }
            
            return `${clientInitial}-${seqString}-${suffix}`;
        };

        const getGithubImageUrl = (repoBase, codigo) => {
            if (!repoBase || !codigo) return null;
            // Asegurar que termine en /
            const cleanBase = repoBase.endsWith('/') ? repoBase : repoBase + '/';
            // Asume extensión .jpg (puedes cambiarlo si usas png)
            return `${cleanBase}${codigo}.jpg`;
        };

        // --- ICONOS ---
        const Icon = ({ name, size = 20, className }) => {
            return <i data-lucide={name} width={size} height={size} className={className}></i>;
        };

        // --- COMPONENTE: MODAL CONFIGURACIÓN ---
        const SettingsModal = ({ config, onSave, onClose }) => {
            const [localConfig, setLocalConfig] = useState(config);

            return (
                <div className="fixed inset-0 bg-black/60 flex items-center justify-center z-50">
                    <div className="bg-white p-6 rounded-xl w-full max-w-lg shadow-2xl">
                        <h2 className="text-xl font-bold mb-4 flex items-center gap-2">
                            <Icon name="settings" /> Configuración del Sistema
                        </h2>
                        
                        <div className="mb-4">
                            <label className="block text-sm font-bold text-slate-700 mb-1">URL Base de Fotos (GitHub RAW)</label>
                            <input 
                                type="text" 
                                className="w-full border p-2 rounded text-sm font-mono bg-slate-50" 
                                placeholder="https://raw.githubusercontent.com/usuario/repo/main/fotos/"
                                value={localConfig.repoUrl}
                                onChange={e => setLocalConfig({...localConfig, repoUrl: e.target.value})}
                            />
                            <p className="text-xs text-slate-500 mt-1">
                                El sistema buscará: <code>URL_BASE</code> + <code>CODIGO</code> + <code>.jpg</code>
                            </p>
                        </div>

                        <div className="mb-4">
                            <label className="block text-sm font-bold text-slate-700 mb-1">Consecutivo de Lote Actual</label>
                            <input 
                                type="number" 
                                className="w-full border p-2 rounded text-sm" 
                                value={localConfig.sequenceCounter}
                                onChange={e => setLocalConfig({...localConfig, sequenceCounter: parseInt(e.target.value) || 1})}
                            />
                            <p className="text-xs text-slate-500 mt-1">Número central del ID (Ej: el '1' en O-00000001-bl)</p>
                        </div>

                        <div className="flex justify-end gap-2 border-t pt-4">
                            <button onClick={onClose} className="px-4 py-2 text-slate-600 hover:bg-slate-100 rounded">Cancelar</button>
                            <button onClick={() => onSave(localConfig)} className="px-4 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700 font-bold">Guardar Cambios</button>
                        </div>
                    </div>
                </div>
            );
        };

        // --- COMPONENTE: FORMULARIO MULTI-ORDEN (LOTE) ---
        const MultiOrderForm = ({ config, onSave, onCancel }) => {
            // Datos compartidos (Lote)
            const [header, setHeader] = useState({
                cliente: '',
                maquina: '',
                fechaInicio: new Date().toISOString().split('T')[0],
                fechaEntrega: ''
            });

            // Lista de piezas individuales
            const [pieces, setPieces] = useState([
                { id: 1, codigo: '', pieza: 'Blusa', talla: 'Unitalla', totalPedido: '', materiales: [] }
            ]);

            // Función para añadir otra pieza al mismo lote
            const addPiece = () => {
                setPieces([...pieces, { 
                    id: Date.now(), 
                    codigo: pieces.length > 0 ? pieces[0].codigo : '', // Copia el código anterior por comodidad
                    pieza: '', 
                    talla: 'Unitalla', 
                    totalPedido: '', 
                    materiales: [] 
                }]);
            };

            const updatePiece = (id, field, value) => {
                setPieces(pieces.map(p => p.id === id ? { ...p, [field]: value } : p));
            };

            const removePiece = (id) => {
                if(pieces.length > 1) setPieces(pieces.filter(p => p.id !== id));
            };

            const handleSubmit = () => {
                if(!header.cliente || !header.maquina) return alert("Falta Cliente o Máquina");

                // Generar objetos de orden final
                const newOrders = pieces.map((p, index) => {
                    const uniqueID = generateID(header.cliente, config.sequenceCounter, p.pieza);
                    
                    return {
                        id: Date.now() + index, // ID interno React
                        displayId: uniqueID,    // ID Visual (O-000001-bl)
                        batchSequence: config.sequenceCounter, // Para agrupar lógicamente
                        
                        // Datos Header
                        cliente: header.cliente,
                        maquina: header.maquina,
                        fechaInicio: header.fechaInicio,
                        fechaFin: header.fechaEntrega,
                        
                        // Datos Pieza
                        codigo: p.codigo,
                        pieza: p.pieza,
                        talla: p.talla,
                        totalPedido: p.totalPedido,
                        materiales: p.materiales, // (Simplificado para el demo)
                        
                        // Estado
                        enhebrado: '', 
                        progreso: [],
                        status: 'En Proceso'
                    };
                });

                onSave(newOrders);
            };

            // Previsualización del ID mientras escribes
            const previewID = generateID(header.cliente, config.sequenceCounter, "Ejemplo");

            return (
                <div className="max-w-5xl mx-auto bg-white rounded-xl shadow-lg my-6 overflow-hidden">
                    <div className="bg-slate-800 p-4 flex justify-between items-center text-white">
                        <div>
                            <h2 className="text-xl font-bold flex items-center gap-2"><Icon name="plus-circle" /> Crear Nuevo Lote de Producción</h2>
                            <p className="text-xs text-slate-400 mt-1">Lote #{config.sequenceCounter} | ID Base: {previewID.split('-')[0]}-{previewID.split('-')[1]}-??</p>
                        </div>
                        <button onClick={onCancel} className="text-slate-300 hover:text-white px-3 py-1 border border-slate-600 rounded">Cancelar</button>
                    </div>
                    
                    <div className="p-6">
                        {/* 1. DATOS GENERALES (Header) */}
                        <div className="bg-indigo-50 p-4 rounded-lg mb-6 border border-indigo-100">
                            <h3 className="text-xs font-bold text-indigo-800 uppercase mb-3 border-b border-indigo-200 pb-1">Datos del Cliente y Máquina</h3>
                            <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
                                <div>
                                    <label className="block text-xs font-bold text-slate-600 mb-1">Cliente *</label>
                                    <input 
                                        list="clientesSugeridos"
                                        value={header.cliente} 
                                        onChange={e => setHeader({...header, cliente: e.target.value})} 
                                        className="w-full p-2 border border-slate-300 rounded focus:border-indigo-500 outline-none" 
                                        placeholder="Ej: Optima" 
                                    />
                                    <datalist id="clientesSugeridos">
                                        <option value="Optima" />
                                        <option value="Zara" />
                                        <option value="Shein" />
                                    </datalist>
                                </div>
                                <div>
                                    <label className="block text-xs font-bold text-slate-600 mb-1">Máquina *</label>
                                    <input value={header.maquina} onChange={e => setHeader({...header, maquina: e.target.value})} className="w-full p-2 border border-slate-300 rounded" placeholder="#5" />
                                </div>
                                <div>
                                    <label className="block text-xs font-bold text-slate-600 mb-1">Fecha Inicio</label>
                                    <input type="date" value={header.fechaInicio} onChange={e => setHeader({...header, fechaInicio: e.target.value})} className="w-full p-2 border border-slate-300 rounded" />
                                </div>
                                <div>
                                    <label className="block text-xs font-bold text-slate-600 mb-1">Entrega Estimada</label>
                                    <input type="date" value={header.fechaEntrega} onChange={e => setHeader({...header, fechaEntrega: e.target.value})} className="w-full p-2 border border-slate-300 rounded" />
                                </div>
                            </div>
                        </div>

                        {/* 2. LISTA DE PIEZAS */}
                        <div className="space-y-4">
                            {pieces.map((piece, idx) => (
                                <div key={piece.id} className="border border-slate-200 rounded-lg p-4 bg-white shadow-sm relative hover:border-indigo-300 transition">
                                    <div className="absolute top-0 left-0 bg-slate-100 text-slate-500 px-2 py-1 text-xs font-bold rounded-br border-b border-r">
                                        Pieza #{idx + 1}
                                    </div>
                                    <button onClick={() => removePiece(piece.id)} className="absolute top-2 right-2 text-red-300 hover:text-red-500" title="Eliminar pieza">
                                        <Icon name="trash-2" size={18} />
                                    </button>

                                    <div className="grid grid-cols-1 md:grid-cols-12 gap-4 mt-4">
                                        <div className="md:col-span-3">
                                            <label className="text-xs font-bold text-slate-500 block">Tipo Pieza</label>
                                            <input 
                                                list="tiposPieza" 
                                                value={piece.pieza} 
                                                onChange={e => updatePiece(piece.id, 'pieza', e.target.value)} 
                                                className="w-full p-2 border rounded bg-slate-50 font-medium text-slate-900" 
                                                placeholder="Ej: Blusa" 
                                            />
                                            <datalist id="tiposPieza">
                                                <option value="Blusa" />
                                                <option value="Manga Larga" />
                                                <option value="Manga Corta" />
                                                <option value="Cuello" />
                                                <option value="Tirante" />
                                                <option value="Espalda" />
                                            </datalist>
                                            <p className="text-[10px] text-indigo-500 mt-1 font-mono">
                                                ID Generado: ...-{generateID("X", 0, piece.pieza).split('-')[2]}
                                            </p>
                                        </div>
                                        <div className="md:col-span-3">
                                            <label className="text-xs font-bold text-slate-500 block">Código Diseño</label>
                                            <input value={piece.codigo} onChange={e => updatePiece(piece.id, 'codigo', e.target.value)} className="w-full p-2 border rounded" placeholder="Ej: M026BL01" />
                                        </div>
                                        <div className="md:col-span-3">
                                            <label className="text-xs font-bold text-slate-500 block">Talla</label>
                                            <input value={piece.talla} onChange={e => updatePiece(piece.id, 'talla', e.target.value)} className="w-full p-2 border rounded" />
                                        </div>
                                        <div className="md:col-span-3">
                                            <label className="text-xs font-bold text-slate-500 block">Pedido Total (Pzs)</label>
                                            <input type="number" value={piece.totalPedido} onChange={e => updatePiece(piece.id, 'totalPedido', e.target.value)} className="w-full p-2 border rounded font-bold text-slate-800" />
                                        </div>
                                    </div>
                                </div>
                            ))}
                        </div>

                        {/* BOTONES ACCIÓN */}
                        <div className="mt-8 flex flex-col md:flex-row gap-4 items-center border-t pt-6">
                            <button onClick={addPiece} className="text-indigo-600 font-bold flex items-center gap-2 hover:bg-indigo-50 px-4 py-2 rounded transition border border-dashed border-indigo-200 w-full md:w-auto justify-center">
                                <Icon name="plus" size={18} /> Agregar Otra Pieza (Mismo Lote)
                            </button>
                            <div className="flex-grow"></div>
                            <button onClick={handleSubmit} className="bg-slate-900 text-white px-8 py-3 rounded-lg shadow-lg hover:bg-slate-800 font-bold flex items-center justify-center gap-2 w-full md:w-auto transition transform hover:scale-105">
                                <Icon name="save" /> Generar {pieces.length} Órdenes de Producción
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // --- COMPONENTE: DETALLE DE ORDEN (CON VISTA DE IMPRESIÓN) ---
        const OrderView = ({ order, config, onBack, onUpdateStatus, onUpdateProgress, onUpdateNotes }) => {
            const [entry, setEntry] = useState({ fecha: new Date().toISOString().split('T')[0], tejedor: '', produccion: '', defectos: '' });
            const [notes, setNotes] = useState(order.enhebrado || '');
            
            // Construir URL de imagen
            const imageUrl = getGithubImageUrl(config.repoUrl, order.codigo);

            const addProgress = () => {
                if(!entry.produccion || !entry.tejedor) return alert("Falta producción o tejedor");
                const newProgress = [...(order.progreso || []), { ...entry, produccion: Number(entry.produccion), id: Date.now() }];
                onUpdateProgress(order.id, newProgress);
                setEntry({ ...entry, produccion: '', defectos: '' });
            };

            const totalProd = order.progreso?.reduce((acc, curr) => acc + Number(curr.produccion), 0) || 0;
            const porcentaje = order.totalPedido ? Math.min(100, ((totalProd / Number(order.totalPedido)) * 100)).toFixed(1) : 0;

            return (
                <div className="max-w-5xl mx-auto my-4 bg-white shadow-xl min-h-screen">
                    {/* BARRA SUPERIOR (NO IMPRIMIR) */}
                    <div className="no-print p-4 border-b bg-slate-50 flex justify-between items-center sticky top-0 z-20 shadow-sm">
                        <button onClick={onBack} className="text-slate-600 flex items-center gap-2 font-bold hover:text-indigo-600 transition">
                            <Icon name="arrow-left" /> Regresar
                        </button>
                        <div className="flex gap-2">
                            {order.status !== 'Archivado' ? (
                                <button onClick={() => onUpdateStatus(order.id, 'Archivado')} className="bg-white border border-amber-500 text-amber-600 px-3 py-2 rounded flex items-center gap-2 hover:bg-amber-50 transition font-bold text-xs">
                                    <Icon name="archive" size={16} /> Archivar
                                </button>
                            ) : (
                                <span className="bg-gray-200 text-gray-500 px-3 py-2 rounded font-bold text-xs">ARCHIVADO</span>
                            )}
                            <button onClick={() => window.print()} className="bg-slate-800 text-white px-4 py-2 rounded flex items-center gap-2 hover:bg-slate-900 transition font-bold text-xs">
                                <Icon name="printer" size={16} /> Imprimir Hoja
                            </button>
                        </div>
                    </div>

                    <div className="p-8 print:p-0">
                        {/* ENCABEZADO ORDEN */}
                        <div className="flex justify-between items-start border-b-4 border-slate-800 pb-4 mb-6">
                            <div>
                                <h1 className="text-4xl font-black text-slate-800 tracking-tight uppercase">{order.cliente}</h1>
                                <div className="text-2xl text-slate-600 mt-1 font-mono font-bold">{order.displayId}</div>
                                <div className="text-sm text-slate-400 mt-1">Lote Seq: {order.batchSequence}</div>
                            </div>
                            <div className="text-right">
                                <div className="bg-slate-900 text-white px-6 py-2 text-sm font-bold uppercase mb-1 rounded-t inline-block">Máquina</div>
                                <div className="text-6xl font-black text-slate-900 leading-none">{order.maquina}</div>
                            </div>
                        </div>

                        <div className="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-6">
                            {/* INFO IZQUIERDA */}
                            <div className="lg:col-span-2">
                                <div className="grid grid-cols-2 md:grid-cols-3 gap-6 text-sm mb-6 p-4 rounded bg-white border border-slate-200">
                                    <div>
                                        <span className="block text-[10px] font-bold text-slate-500 uppercase tracking-wider">Código Diseño</span>
                                        <span className="text-xl font-bold text-slate-800">{order.codigo}</span>
                                    </div>
                                    <div>
                                        <span className="block text-[10px] font-bold text-slate-500 uppercase tracking-wider">Pieza</span>
                                        <span className="text-xl font-bold text-slate-800">{order.pieza}</span>
                                    </div>
                                    <div>
                                        <span className="block text-[10px] font-bold text-slate-500 uppercase tracking-wider">Talla</span>
                                        <span className="text-xl font-bold text-slate-800">{order.talla}</span>
                                    </div>
                                    <div className="col-span-2 md:col-span-3 border-t pt-3 mt-1 flex justify-between items-center">
                                        <div>
                                            <span className="block text-[10px] font-bold text-slate-500 uppercase">Total Pedido</span>
                                            <span className="text-3xl font-black text-slate-800">{order.totalPedido} <span className="text-sm font-normal text-slate-500">pzs</span></span>
                                        </div>
                                        <div className="text-right">
                                            <span className="block text-[10px] font-bold text-slate-500 uppercase">Restante</span>
                                            <span className="text-xl font-bold text-red-600">{order.totalPedido - totalProd}</span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            {/* IMAGEN DERECHA */}
                            <div className="lg:col-span-1">
                                <div className="border-2 border-slate-900 bg-slate-50 p-2 flex items-center justify-center min-h-[200px]">
                                    {imageUrl ? (
                                        <img src={imageUrl} alt="Ref" className="max-w-full max-h-[250px] object-contain"
                                            onError={(e) => {
                                                e.target.style.display = 'none';
                                                e.target.parentElement.innerHTML = `<div class="text-center p-4"><p class="text-xs font-bold text-slate-400">IMAGEN NO ENCONTRADA</p><p class="text-[10px] text-slate-300 font-mono mt-1">${order.codigo}.jpg</p></div>`;
                                            }}
                                        />
                                    ) : (
                                        <div className="text-center text-slate-400">
                                            <Icon name="image" size={48} className="mx-auto mb-2 opacity-50" />
                                            <span className="text-xs font-bold">SIN REFERENCIA</span>
                                        </div>
                                    )}
                                </div>
                            </div>
                        </div>

                        {/* NOTAS / ENHEBRADO */}
                        <div className="mb-6">
                            <label className="text-xs font-bold text-slate-900 uppercase block mb-1 bg-slate-200 px-2 py-1 inline-block">Instrucciones de Tejido / Enhebrado</label>
                            <textarea 
                                className="w-full p-3 border-2 border-slate-300 rounded text-sm font-mono focus:border-indigo-500 outline-none no-print" 
                                rows="3" 
                                value={notes}
                                onChange={e => setNotes(e.target.value)}
                                onBlur={() => onUpdateNotes(order.id, notes)}
                                placeholder="Escribe aquí notas técnicas para el tejedor..."
                            ></textarea>
                            {/* Versión solo impresión de notas */}
                            <div className="print-only border border-black p-2 min-h-[80px] text-sm font-mono whitespace-pre-wrap">
                                {notes}
                            </div>
                        </div>

                        {/* --- TABLA DE CAPTURA MANUAL (SOLO IMPRESIÓN) --- */}
                        <div className="print-only mt-8">
                            <h3 className="text-center font-bold uppercase text-lg mb-2 border-b-2 border-black pb-1">Control de Producción (Llenado Manual)</h3>
                            <table className="w-full text-sm border-collapse border border-black">
                                <thead>
                                    <tr className="bg-slate-200">
                                        <th className="border border-black p-2 w-24">Fecha</th>
                                        <th className="border border-black p-2 w-20">Turno</th>
                                        <th className="border border-black p-2">Tejedor</th>
                                        <th className="border border-black p-2 w-24">Cant. (Pzs)</th>
                                        <th className="border border-black p-2 w-24">Defectos</th>
                                        <th className="border border-black p-2">Firma / Observaciones</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {[...Array(20)].map((_, i) => (
                                        <tr key={i} className="h-12">
                                            <td className="border border-black"></td>
                                            <td className="border border-black"></td>
                                            <td className="border border-black"></td>
                                            <td className="border border-black"></td>
                                            <td className="border border-black"></td>
                                            <td className="border border-black"></td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                            <div className="mt-4 flex justify-between text-xs font-bold">
                                <span>Sistema v3.0</span>
                                <span>{new Date().toLocaleDateString()}</span>
                            </div>
                        </div>

                        {/* --- CAPTURA DIGITAL (SOLO PANTALLA) --- */}
                        <div className="no-print mt-10 bg-slate-50 p-6 rounded-xl border border-slate-200">
                            <h3 className="font-bold text-slate-800 mb-4 flex items-center gap-2">
                                <Icon name="monitor" className="text-indigo-600" /> Captura Digital
                            </h3>
                            
                            <div className="flex flex-col sm:flex-row gap-2 mb-6 items-end">
                                <div className="flex-1">
                                    <label className="text-xs text-slate-500 font-bold ml-1">Fecha</label>
                                    <input type="date" className="p-2 border rounded w-full text-sm" value={entry.fecha} onChange={e=>setEntry({...entry, fecha: e.target.value})} />
                                </div>
                                <div className="flex-1">
                                    <label className="text-xs text-slate-500 font-bold ml-1">Tejedor</label>
                                    <input type="text" className="p-2 border rounded w-full text-sm" placeholder="Nombre" value={entry.tejedor} onChange={e=>setEntry({...entry, tejedor: e.target.value})} />
                                </div>
                                <div className="w-32">
                                    <label className="text-xs text-green-600 font-bold ml-1">Producción</label>
                                    <input type="number" className="p-2 border border-green-300 rounded w-full text-sm font-bold text-center" placeholder="0" value={entry.produccion} onChange={e=>setEntry({...entry, produccion: e.target.value})} />
                                </div>
                                <div className="flex-1">
                                    <label className="text-xs text-slate-500 font-bold ml-1">Defectos/Notas</label>
                                    <input type="text" className="p-2 border rounded w-full text-sm" placeholder="..." value={entry.defectos} onChange={e=>setEntry({...entry, defectos: e.target.value})} />
                                </div>
                                <button onClick={addProgress} className="bg-indigo-600 text-white p-2 rounded w-12 flex justify-center items-center hover:bg-indigo-700">
                                    <Icon name="plus" />
                                </button>
                            </div>

                            {/* Historial Digital */}
                            <div className="overflow-hidden rounded border border-slate-200">
                                <table className="w-full text-sm bg-white">
                                    <thead className="bg-slate-100 text-slate-600 font-bold uppercase text-xs">
                                        <tr>
                                            <th className="p-3 text-left">Fecha</th>
                                            <th className="p-3 text-left">Tejedor</th>
                                            <th className="p-3 text-center text-green-700">Pzs</th>
                                            <th className="p-3 text-left">Notas</th>
                                        </tr>
                                    </thead>
                                    <tbody className="divide-y divide-slate-100">
                                        {order.progreso?.slice().reverse().map((p) => (
                                            <tr key={p.id}>
                                                <td className="p-3 text-slate-500">{p.fecha}</td>
                                                <td className="p-3 font-medium">{p.tejedor}</td>
                                                <td className="p-3 text-center font-bold text-green-600 bg-green-50">{p.produccion}</td>
                                                <td className="p-3 text-slate-400 italic">{p.defectos}</td>
                                            </tr>
                                        ))}
                                        {(!order.progreso || order.progreso.length === 0) && (
                                            <tr><td colSpan="4" className="p-4 text-center text-slate-400 italic">Sin registros digitales</td></tr>
                                        )}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // --- COMPONENTE PRINCIPAL ---
        const MainApp = () => {
            const [view, setView] = useState('list');
            const [orders, setOrders] = useState([]);
            const [selectedOrder, setSelectedOrder] = useState(null);
            
            // Filtros
            const [filterClient, setFilterClient] = useState('ALL');
            const [searchTerm, setSearchTerm] = useState('');
            const [config, setConfig] = useState({ repoUrl: '', sequenceCounter: 1 });
            const [showSettings, setShowSettings] = useState(false);

            // Cargar datos
            useEffect(() => {
                const savedOrders = localStorage.getItem('v3_prod_orders');
                const savedConfig = localStorage.getItem('v3_prod_config');
                if (savedOrders) setOrders(JSON.parse(savedOrders));
                if (savedConfig) setConfig(JSON.parse(savedConfig));
                
                // Inicializar iconos lucide
                setTimeout(() => lucide.createIcons(), 100);
            }, []);

            useEffect(() => {
                lucide.createIcons();
            });

            // Guardar datos
            const saveData = (newOrders, newConfig) => {
                if(newOrders) {
                    setOrders(newOrders);
                    localStorage.setItem('v3_prod_orders', JSON.stringify(newOrders));
                }
                if(newConfig) {
                    setConfig(newConfig);
                    localStorage.setItem('v3_prod_config', JSON.stringify(newConfig));
                }
            };

            const handleNewBatch = (newOrdersList) => {
                const updatedOrders = [...newOrdersList, ...orders];
                const updatedConfig = { ...config, sequenceCounter: config.sequenceCounter + 1 };
                saveData(updatedOrders, updatedConfig);
                setView('list');
            };

            const handleUpdateOrder = (id, field, value) => {
                const updated = orders.map(o => o.id === id ? { ...o, [field]: value } : o);
                saveData(updated, null);
                if (selectedOrder && selectedOrder.id === id) {
                    setSelectedOrder({ ...selectedOrder, [field]: value });
                }
            };

            // Derivar clientes únicos para las "Carpetas"
            const clients = useMemo(() => {
                const c = [...new Set(orders.map(o => o.cliente))];
                return c.sort();
            }, [orders]);

            // Filtrado
            const filteredOrders = orders.filter(o => {
                const matchClient = filterClient === 'ALL' || o.cliente === filterClient;
                const matchSearch = 
                    o.displayId.toLowerCase().includes(searchTerm.toLowerCase()) || 
                    o.codigo.toLowerCase().includes(searchTerm.toLowerCase());
                
                // Si estamos filtrando por cliente, mostramos activos y archivados de ese cliente.
                // Si estamos en "Todos", solo activos (opcional, aquí muestro todo y uso estado visual)
                return matchClient && matchSearch;
            });

            return (
                <div className="min-h-screen flex flex-col">
                    {/* NAV */}
                    <nav className="bg-slate-900 text-white p-4 no-print shadow-lg z-30">
                        <div className="max-w-7xl mx-auto flex justify-between items-center">
                            <div className="flex items-center gap-3">
                                <div className="bg-indigo-600 p-2 rounded-lg">
                                    <Icon name="layers" className="text-white" />
                                </div>
                                <h1 className="font-bold text-xl tracking-tight">Control Producción <span className="text-indigo-400 font-light">v3.0</span></h1>
                            </div>
                            <div className="flex items-center gap-4">
                                <div className="relative">
                                    <Icon name="search" size={16} className="absolute left-3 top-2.5 text-slate-500" />
                                    <input 
                                        type="text" 
                                        placeholder="Buscar ID u Orden..." 
                                        className="bg-slate-800 border border-slate-700 rounded-full pl-9 pr-4 py-2 text-sm focus:outline-none focus:border-indigo-500 transition w-64"
                                        value={searchTerm}
                                        onChange={e => setSearchTerm(e.target.value)}
                                    />
                                </div>
                                <button onClick={() => setShowSettings(true)} className="p-2 hover:bg-slate-800 rounded-full transition">
                                    <Icon name="settings" />
                                </button>
                            </div>
                        </div>
                    </nav>

                    {/* CONTENIDO */}
                    <main className="flex-grow bg-slate-100 p-6">
                        {view === 'list' && (
                            <div className="max-w-7xl mx-auto">
                                {/* BARRA DE ACCIONES Y FILTROS DE CLIENTE (CARPETAS) */}
                                <div className="flex flex-col md:flex-row justify-between items-end mb-6 gap-4">
                                    <div className="w-full md:w-auto overflow-x-auto">
                                        <div className="flex gap-2 pb-2">
                                            <button 
                                                onClick={() => setFilterClient('ALL')}
                                                className={`px-5 py-2 rounded-t-lg font-bold text-sm transition border-b-2 ${filterClient === 'ALL' ? 'bg-white text-indigo-600 border-indigo-600 shadow-sm' : 'bg-slate-200 text-slate-500 border-transparent hover:bg-slate-300'}`}
                                            >
                                                Todas
                                            </button>
                                            {clients.map(c => (
                                                <button 
                                                    key={c}
                                                    onClick={() => setFilterClient(c)}
                                                    className={`px-5 py-2 rounded-t-lg font-bold text-sm transition border-b-2 whitespace-nowrap flex items-center gap-2 ${filterClient === c ? 'bg-white text-indigo-600 border-indigo-600 shadow-sm' : 'bg-slate-200 text-slate-500 border-transparent hover:bg-slate-300'}`}
                                                >
                                                    <Icon name="folder" size={14} /> {c}
                                                </button>
                                            ))}
                                        </div>
                                        {/* Línea decorativa para simular carpeta */}
                                        <div className="h-1 bg-white shadow-sm w-full -mt-2 rounded-b-lg"></div>
                                    </div>
                                    
                                    <button onClick={() => setView('create')} className="bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-2 rounded-lg font-bold shadow-lg flex items-center gap-2 transition transform hover:-translate-y-1">
                                        <Icon name="plus" /> Nuevo Lote
                                    </button>
                                </div>

                                {/* GRID DE ÓRDENES */}
                                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                                    {filteredOrders.map(order => {
                                        const totalProd = order.progreso?.reduce((acc, curr) => acc + Number(curr.produccion), 0) || 0;
                                        const pct = order.totalPedido ? Math.min(100, (totalProd / order.totalPedido) * 100) : 0;
                                        const isArchived = order.status === 'Archivado';

                                        return (
                                            <div 
                                                key={order.id} 
                                                onClick={() => { setSelectedOrder(order); setView('detail'); }}
                                                className={`group relative bg-white rounded-xl border-2 cursor-pointer transition-all hover:shadow-xl hover:-translate-y-1 overflow-hidden ${isArchived ? 'border-slate-200 opacity-75' : 'border-white shadow-md'}`}
                                            >
                                                {isArchived && (
                                                    <div className="absolute top-2 right-2 bg-slate-100 text-slate-500 text-[10px] font-bold px-2 py-1 rounded uppercase flex items-center gap-1">
                                                        <Icon name="archive" size={10} /> Archivado
                                                    </div>
                                                )}
                                                
                                                <div className={`h-1.5 w-full ${isArchived ? 'bg-slate-300' : 'bg-gradient-to-r from-indigo-500 to-purple-500'}`}></div>
                                                
                                                <div className="p-5">
                                                    <div className="flex justify-between items-baseline mb-2">
                                                        <span className="font-mono text-xs font-bold text-slate-400">{order.displayId}</span>
                                                        <span className="text-xs font-bold bg-slate-100 text-slate-600 px-2 py-1 rounded">MQ-{order.maquina}</span>
                                                    </div>
                                                    
                                                    <h3 className="font-bold text-lg text-slate-800 leading-tight mb-1">{order.pieza}</h3>
                                                    <p className="text-sm font-medium text-slate-500 mb-4">{order.codigo}</p>
                                                    
                                                    {/* Barra Progreso Mini */}
                                                    <div className="mb-4">
                                                        <div className="flex justify-between text-[10px] font-bold uppercase text-slate-400 mb-1">
                                                            <span>Progreso</span>
                                                            <span>{Math.round(pct)}%</span>
                                                        </div>
                                                        <div className="h-2 w-full bg-slate-100 rounded-full overflow-hidden">
                                                            <div className={`h-full rounded-full ${isArchived ? 'bg-slate-400' : 'bg-green-500'}`} style={{width: `${pct}%`}}></div>
                                                        </div>
                                                    </div>

                                                    <div className="pt-3 border-t flex justify-between items-center">
                                                        <div className="flex items-center gap-2">
                                                            <div className="w-6 h-6 rounded bg-indigo-50 text-indigo-700 flex items-center justify-center text-xs font-bold">
                                                                {order.cliente.charAt(0)}
                                                            </div>
                                                            <span className="text-xs font-bold text-slate-600">{order.cliente}</span>
                                                        </div>
                                                        <span className="text-[10px] text-slate-400">{order.fechaInicio}</span>
                                                    </div>
                                                </div>
                                            </div>
                                        );
                                    })}
                                </div>
                                
                                {filteredOrders.length === 0 && (
                                    <div className="flex flex-col items-center justify-center py-20 text-slate-300">
                                        <Icon name="inbox" size={64} className="mb-4" />
                                        <p className="text-lg font-medium">No se encontraron órdenes</p>
                                        <p className="text-sm">Prueba cambiando el filtro de cliente o creando un nuevo lote.</p>
                                    </div>
                                )}
                            </div>
                        )}

                        {view === 'create' && (
                            <MultiOrderForm 
                                config={config} 
                                onSave={handleNewBatch} 
                                onCancel={() => setView('list')} 
                            />
                        )}

                        {view === 'detail' && selectedOrder && (
                            <OrderView 
                                order={selectedOrder}
                                config={config}
                                onBack={() => { setView('list'); setSelectedOrder(null); }}
                                onUpdateStatus={(id, st) => handleUpdateOrder(id, 'status', st)}
                                onUpdateProgress={(id, prog) => handleUpdateOrder(id, 'progreso', prog)}
                                onUpdateNotes={(id, n) => handleUpdateOrder(id, 'enhebrado', n)}
                            />
                        )}

                        {showSettings && (
                            <SettingsModal 
                                config={config} 
                                onClose={() => setShowSettings(false)} 
                                onSave={(newConf) => { saveData(null, newConf); setShowSettings(false); }} 
                            />
                        )}
                    </main>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<MainApp />);
    </script>
</body>
</html>
