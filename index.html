<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <title>MAES26 Control + Planeación</title>

    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#0f172a">

    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        @media print {
            .no-print { display: none !important; }
            body { background: white !important; color: black !important; }
            .report-page { 
                margin: 0; 
                padding: 10mm;
                color: black !important;
                background: white !important;
                min-height: 297mm; /* A4 height */
            }
        }

        .custom-scrollbar::-webkit-scrollbar { height: 6px; width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #0f172a; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }
        .slot-input {
            background: transparent; border: none; outline: none; text-align: center; width: 100%;
            font-weight: bold; padding: 0; z-index: 1; position: relative;
        }
        .slot-input:focus { background: #1e293b; color: #60a5fa; }
        .slot-input::placeholder { color: #475569; font-weight: normal; font-size: 8px; }
        .password-mask { -webkit-text-security: disc; text-security: disc; }
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes zoomIn { from { transform: scale(0.5); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        .animate-zoom-in { animation: zoomIn 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .machine-circle { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .machine-circle.selected { transform: scale(1.1); box-shadow: 0 0 15px rgba(34, 197, 94, 0.6); }
        .planning-info { color: #facc15; background-color: rgba(120, 53, 15, 0.1); border-radius: 4px; padding: 1px 3px; font-weight: bold; font-size: 8px; }
        
        /* Report Modal Styles */
        .report-page {
            background-color: #f8fafc;
            color: #1e293b;
            padding: 30px;
            font-family: sans-serif;
        }
        .report-header h1 { font-size: 24px; font-weight: bold; border-bottom: 2px solid #e2e8f0; padding-bottom: 5px; margin-bottom: 10px; }
        .report-section { margin-bottom: 20px; border: 1px solid #e2e8f0; padding: 15px; border-radius: 8px; }
        .report-section h2 { font-size: 18px; font-weight: bold; color: #1e40af; margin-bottom: 10px; }
        .report-data div { display: flex; justify-content: space-between; padding: 4px 0; border-bottom: 1px dotted #cbd5e1; font-size: 14px; }
        .report-label { font-weight: 500; color: #475569; }
        .report-value { font-weight: 700; }
        .report-material-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        .report-material-table th, .report-material-table td { border: 1px solid #e2e8f0; padding: 8px; text-align: left; font-size: 13px; }
        .report-material-table th { background-color: #f1f5f9; color: #1e293b; }
    </style>
</head>
<body class="bg-slate-900 text-slate-200 font-sans fixed inset-0 overflow-hidden">

    <div id="root" class="h-full"></div>

    <script type="text/babel" data-type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, signInAnonymously, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, collection, doc, setDoc, deleteDoc, onSnapshot, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        const { useState, useEffect, useMemo } = React;

        const firebaseConfig = {
            apiKey: "AIzaSyBqHgV4vDat1-VmZfKbiPg7nuiX-ROcexw",
            authDomain: "cirineo-cec21.firebaseapp.com",
            projectId: "cirineo-cec21",
            storageBucket: "cirineo-cec21.firebasestorage.app",
            messagingSenderId: "620210618284",
            appId: "1:620210618284:web:482bab9bf74650fff18409",
            measurementId: "G-B7YLM78RVW"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const ROLES = { 
            ADMIN: 'admin', 
            COMMENTATOR: 'commentator', 
            OBSERVER: 'observer', 
            DEVELOPMENT: 'development',
            OPERATOR: 'operator'
        };
        
        // La lista de usuarios inicial se ha movido a Firestore
        const DEFAULT_USERS = {
            '1111': { name: 'Marco Espinoza', role: ROLES.ADMIN, area: 'Administración', canManageOrders: true },
            '0000': { name: 'Prisciliano Espinoza', role: ROLES.COMMENTATOR, area: 'Comentarios' },
            '2222': { name: 'Susana', role: ROLES.OBSERVER, area: 'Observación', canManageOrders: true, canViewGraph: true }, 
            '1352': { name: 'Vallejo', role: ROLES.DEVELOPMENT, area: 'Desarrollo', canManageOrders: true, canViewGraph: true, canManageUsers: true }, 
            '3333': { name: 'Tejido', role: ROLES.OPERATOR, area: 'Operadores Gral' },
            '1392': { name: 'Andrés', role: ROLES.OPERATOR, area: 'Tejido (A)', allowedSlots: [0] },
            '7914': { name: 'Balta', role: ROLES.OPERATOR, area: 'Tejido (B)', allowedSlots: [1] }
        };

        const CHESS_ICONS = {
            king: '♔',
            queen: '♕',
            rook: '♖',
            bishop: '♗',
            knight: '♘',
            pawn: '♙'
        };

        const MACHINES = [
            { id: 'm35', name: 'MAQ 35', type: 'SANTONI SM8' }, { id: 'm39', name: 'MAQ 39', type: 'SANTONI SM8' },
            { id: 'm40', name: 'MAQ 40', type: 'SANTONI SM8' }, { id: 'm36', name: 'MAQ 36', type: 'CIXING GE82' },
            { id: 'm38', name: 'MAQ 38', type: 'SANTONI SM8' }, { id: 'm37', name: 'MAQ 37', type: 'SANTONI SM8' },
            { id: 'm29', name: 'MAQ 29', type: 'SANTONI EVO4' }, { id: 'm28', name: 'MAQ 28', type: 'SANTONI EVO4' },
            { id: 'm27', name: 'MAQ 27', type: 'SANTONI EVO4' }, { id: 'm33', name: 'MAQ 33', type: 'SANTONI EVO4' },
            { id: 'm1',  name: 'MAQ 1',  type: 'CIXING' }, { id: 'm30', name: 'MAQ 30', type: 'CIXING GE82' },
            { id: 'm31', name: 'MAQ 31', type: 'CIXING GE82' }, { id: 'm6',  name: 'MAQ 6',  type: 'CIXING GE82' },
            { id: 'm32', name: 'MAQ 32', type: 'CIXING GE82' }, { id: 'm13', name: 'MAQ 13', type: 'SANTONI EVO4' },
            { id: 'm12', name: 'MAQ 12', type: 'SANTONI EVO4' }, { id: 'm24', name: 'MAQ 24', type: 'SANTONI EVO4' },
            { id: 'm8',  name: 'MAQ 8',  type: 'SANTONI TOP2' },
        ];

        const generateCalendar = () => {
            const dates = [];
            const months = ['ENE', 'FEB', 'MAR', 'ABR', 'MAY', 'JUN', 'JUL', 'AGO', 'SEP', 'OCT', 'NOV', 'DIC'];
            // Covering a period, e.g., 2025 to 2026 for flexibility
            const start = new Date(2025, 8, 1); 
            const end = new Date(2026, 11, 31);
            let idx = 0;
            for (let d = start; d <= end; d.setDate(d.getDate() + 1)) {
                dates.push({
                    index: idx++,
                    id: `${['DOMINGO','LUNES','MARTES','MIERCOLES','JUEVES','VIERNES','SABADO'][d.getDay()]} ${d.getDate()} ${months[d.getMonth()]} ${d.getFullYear()}`,
                    shortDay: ['DOM', 'LUN', 'MAR', 'MIE', 'JUE', 'VIE', 'SAB'][d.getDay()],
                    dateNum: d.getDate(),
                    month: months[d.getMonth()],
                    monthIndex: d.getMonth(),
                    year: d.getFullYear(), 
                    isoDate: d.toISOString().split('T')[0] 
                });
            }
            return dates;
        };

        const ALL_ROWS = generateCalendar();
        const INITIAL_STATE = (() => {
            const todayISO = new Date().toISOString().split('T')[0];
            const foundIndex = ALL_ROWS.findIndex(r => r.isoDate === todayISO);
            // Default to start of the calendar if today is not found or index is too small
            const safeIndex = foundIndex !== -1 ? foundIndex : 0;
            return { weekOffset: Math.floor(safeIndex / 7), selectedDayIndex: safeIndex % 7 };
        })();

        const getWeekLabel = (weekRows) => {
            if (!weekRows || weekRows.length === 0) return '';
            const f = weekRows[0], l = weekRows[weekRows.length - 1];
            return f.month === l.month ? `${f.month} ${f.year}` : `${f.month} - ${l.month} ${l.year}`;
        };

        const calculateConsumptionDetails = (order, producedQty = 0) => {
            if (!order || !order.totalQty || !order.pieceWeightGrams) return { totalNeeded: 0, consumption: [], totalYarnKilos: 0, producedYarnKilos: 0 };

            const totalQty = Number(order.totalQty);
            const pieceWeightGrams = Number(order.pieceWeightGrams);
            const materials = order.materials || [];
            const waste = 1 + (Number(order.wastePercentage) / 100);

            // 1. Total Needed (with waste)
            const totalYarnGramsNeeded = totalQty * pieceWeightGrams * waste;
            const totalYarnKilos = totalYarnGramsNeeded / 1000;

            // 2. Produced (Consumed) Yarn
            const producedYarnGrams = producedQty * pieceWeightGrams * waste;
            const producedYarnKilos = producedYarnGrams / 1000;
            
            // 3. Detailed Consumption (with waste)
            const consumption = materials
                .filter(m => m.name && m.percentage)
                .map(m => {
                    const percent = Number(m.percentage) / 100;
                    const kilosNeeded = (totalYarnKilos * percent);
                    const kilosConsumed = (producedYarnKilos * percent);
                    return { 
                        name: m.name, 
                        percentage: m.percentage, 
                        kilosNeeded: kilosNeeded,
                        kilosConsumed: kilosConsumed
                    };
                });
            
            return { totalNeeded: totalQty, consumption, totalYarnKilos, producedYarnKilos };
        };


        // --- CÁLCULO PROYECCIÓN Y DESVIACIÓN ---
        const calculateOrderMetrics = (machineId, order, allProductionData, allRows, globalHiddenDays) => {
            const metrics = { 
                isPlanned: false, finishDate: null, totalNeeded: 0, progress: 0, produced: 0, 
                dailyCapacity: 0, plannedToDate: 0, deviation: 0, status: 'OK'
            };
            
            if (!order || !order.totalQty || !order.timePerPieceMin || !order.startDate) return metrics;
            
            const totalQty = Number(order.totalQty);
            let dailyHours = order.operators && Array.isArray(order.operators) ? order.operators.length * 12 : Number(order.dailyHours || 12);
            const timePerPieceMin = Number(order.timePerPieceMin);
            const disabledDates = order.disabledDates || []; 
            
            metrics.dailyCapacity = Math.floor((dailyHours * 60) / timePerPieceMin);
            
            // 1. Producción Real y Progreso
            let produced = 0;
            let plannedToDate = 0;
            const todayISO = new Date().toISOString().split('T')[0];
            const startIndex = allRows.findIndex(r => r.isoDate === order.startDate);
            const todayIndex = allRows.findIndex(r => r.isoDate === todayISO);
            
            if (startIndex !== -1) {
                // Production: Sum all 'actual' quantities from start date up to now
                for (let i = startIndex; i < allRows.length; i++) {
                    const row = allRows[i];
                    produced += Number(allProductionData[row.id]?.[machineId]?.actual || 0);

                    // Calculate planned production up to *Yesterday*
                    if (i < todayIndex) {
                        if (!globalHiddenDays.includes(row.id) && !disabledDates.includes(row.isoDate)) {
                            plannedToDate += metrics.dailyCapacity;
                        }
                    }
                    
                    // Stop production sum after today, but allow past days to be included
                    if (new Date(row.isoDate) >= new Date(todayISO) && new Date(row.isoDate).getDate() === new Date(todayISO).getDate()) break; 
                }
            }
            
            metrics.produced = produced;
            metrics.plannedToDate = plannedToDate;
            metrics.deviation = produced - plannedToDate; // Negative means behind schedule
            metrics.progress = totalQty > 0 ? Math.min(100, (produced / totalQty) * 100) : 0;
            metrics.isPlanned = true;

            // Set deviation status
            if (metrics.deviation < -metrics.dailyCapacity * 1.5) { // Behind by more than 1.5 days
                metrics.status = 'ATRASO CRÍTICO';
            } else if (metrics.deviation < 0) { // Behind by some quantity
                metrics.status = 'ATRASO LEVE';
            }

            const remainingQty = Math.max(0, totalQty - produced);
            
            if (remainingQty <= 0) {
                metrics.finishDate = todayISO; // Usamos la fecha de hoy o la última fecha de producción
                metrics.progress = 100;
                metrics.status = 'COMPLETADO';
                return metrics;
            }
            
            metrics.totalNeeded = remainingQty;
            
            // 2. Proyección Futura (starts from today or startDate if in future)
            let projRemaining = remainingQty;
            let currentIdx = startIndex !== -1 ? startIndex : 0;
            
            // If the start date is in the past, start the projection from today
            if (todayIndex > currentIdx) currentIdx = todayIndex;

            if (currentIdx === -1) { metrics.finishDate = todayISO; return metrics; } // Fallback

            for (let i = currentIdx; i < allRows.length; i++) {
                const row = allRows[i];
                if (globalHiddenDays.includes(row.id) || disabledDates.includes(row.isoDate)) continue;
                
                projRemaining -= metrics.dailyCapacity; 
                if (projRemaining <= 0) {
                    metrics.finishDate = row.isoDate; 
                    return metrics;
                }
            }

            metrics.finishDate = null; // Indica que se necesita más de 60 días
            return metrics;
        };

        const ProductionSlot = ({ slotData, index, disabled, onUpdate }) => {
            const [localModel, setLocalModel] = useState(slotData?.model || '');
            const [localQty, setLocalQty] = useState('');
            const [isDirty, setIsDirty] = useState(false);

            useEffect(() => {
                if (!isDirty) { 
                    setLocalModel(slotData?.model || ''); 
                    setLocalQty(slotData?.qty ?? ''); 
                }
            }, [slotData, isDirty]);

            const handleSave = (e) => {
                e?.preventDefault();
                if (localModel !== (slotData?.model || '')) onUpdate(index, 'model', localModel);
                if (String(localQty) !== String(slotData?.qty ?? '')) onUpdate(index, 'qty', localQty);
                setIsDirty(false);
            };

            const handleChange = (f, v) => { if (f==='model') setLocalModel(v); else setLocalQty(v); setIsDirty(true); };
            const handleKeyDown = (e) => { if (e.key === 'Enter') { e.preventDefault(); handleSave(); e.target.blur(); } };

            return (
                <div className={`flex flex-col border border-slate-700/50 rounded overflow-hidden h-full relative ${disabled ? 'bg-slate-900/20 opacity-40' : 'bg-slate-800'} ${isDirty ? 'border-yellow-500/50' : ''}`}>
                    <input type="text" placeholder="MOD" value={localModel} onChange={(e) => handleChange('model', e.target.value)} onKeyDown={handleKeyDown} disabled={disabled} className="slot-input text-[8px] text-yellow-500 uppercase border-b border-slate-700/50 h-1/2" />
                    <input type="number" placeholder="CANT" value={localQty} onChange={(e) => handleChange('qty', e.target.value)} onKeyDown={handleKeyDown} disabled={disabled} className="slot-input text-[10px] text-white h-1/2" />
                    {isDirty && !disabled && (<div className="absolute inset-y-0 right-0 w-8 flex items-center justify-center bg-gradient-to-l from-slate-900 via-slate-900/80 to-transparent z-10 animate-zoom-in"><button onClick={handleSave} className="bg-green-600 text-white rounded-full p-1 shadow-lg hover:scale-110"><i data-lucide="check" className="w-3 h-3"></i></button></div>)}
                </div>
            );
        };

        // --- GESTIÓN DE USUARIOS MODAL ---
        const UserManagementModal = ({ onClose, users, onSaveUser, onDeleteUser }) => {
            const [editingUser, setEditingUser] = useState(null); // { id: pin, name: '', role: '', area: '', ... }
            const [pin, setPin] = useState('');
            const [icon, setIcon] = useState('');
            const [name, setName] = useState('');
            const [role, setRole] = useState(ROLES.OPERATOR);
            const [area, setArea] = useState('');

            const allUsersArray = Object.entries(users).map(([pin, data]) => ({ pin, ...data }));
            const availableRoles = Object.values(ROLES);

            const startEdit = (user) => {
                setEditingUser(user);
                setPin(user.pin);
                setName(user.name);
                setRole(user.role);
                setArea(user.area || '');
                setIcon(user.icon || '');
            };

            const handleSave = () => {
                if (!pin || !name || !role) {
                    alert('Todos los campos son obligatorios (PIN, Nombre, Rol)');
                    return;
                }
                if (pin.length !== 4 || isNaN(Number(pin))) {
                    alert('El PIN debe ser un número de 4 dígitos.');
                    return;
                }
                if (!editingUser && users[pin]) {
                    alert('El PIN ya existe. Usa un PIN diferente o edita el usuario existente.');
                    return;
                }

                const payload = { 
                    name, 
                    role, 
                    area,
                    // Mantener permisos existentes si se edita, o usar valores por defecto
                    canManageOrders: editingUser ? editingUser.canManageOrders : role === ROLES.ADMIN || role === ROLES.OBSERVER || role === ROLES.DEVELOPMENT,
                    canViewGraph: editingUser ? editingUser.canViewGraph : role === ROLES.ADMIN || role === ROLES.OBSERVER || role === ROLES.DEVELOPMENT,
                    canManageUsers: editingUser ? editingUser.canManageUsers : role === ROLES.DEVELOPMENT,
                    icon: editingUser ? (editingUser.icon || '') : '',
                };
                
                // CORRECCIÓN: Evitar enviar 'undefined' a Firestore.
                if (role === ROLES.OPERATOR) {
                    // Si es operador, el campo allowedSlots debe existir como array (vacío o con datos)
                    payload.allowedSlots = editingUser?.allowedSlots || [];
                } 
                // Si el rol NO es OPERATOR, el campo allowedSlots simplemente no se incluye en el payload (no se usa 'undefined').

                onSaveUser(pin, payload);
                setEditingUser(null);
                setPin('');
                setName('');
                setRole(ROLES.OPERATOR);
                setArea('');
                setIcon('');
            };

            return (
                <div className="fixed inset-0 bg-black/90 backdrop-blur-sm flex items-center justify-center z-50 p-4 fade-in" onClick={onClose}>
                    <div className="bg-slate-800 rounded-2xl shadow-2xl w-full max-w-4xl h-[90vh] flex flex-col border border-slate-700 overflow-hidden" onClick={e => e.stopPropagation()}>
                        <div className="p-4 border-b border-slate-700 flex justify-between items-center bg-slate-900 no-print">
                            <h3 className="font-bold text-white uppercase tracking-wider text-sm flex items-center gap-2">
                                <i data-lucide="users" className="w-5 h-5 text-yellow-400"></i>
                                Gestión de Usuarios
                            </h3>
                            <button onClick={onClose} className="p-1.5 bg-slate-700 hover:bg-slate-600 rounded"><i data-lucide="x" className="text-slate-400 w-5 h-5"></i></button>
                        </div>

                        <div className="flex-1 overflow-y-auto p-6 custom-scrollbar flex gap-6">
                            
                            {/* Formulario de Creación/Edición */}
                            <div className="w-1/3 shrink-0 bg-slate-900 p-4 rounded-xl border border-slate-700 h-fit sticky top-0">
                                <h4 className="text-lg font-bold text-white mb-4 border-b border-slate-700 pb-2">{editingUser ? `Editar: ${editingUser.name}` : 'Crear Nuevo Usuario'}</h4>
                                <div className="space-y-3">
                                    <div>
                                        <label className="block text-xs font-bold text-blue-400 mb-1">PIN (4 Dígitos)</label>
                                        <input type="number" value={pin} onChange={e => setPin(e.target.value.slice(0, 4))} disabled={!!editingUser} placeholder="Ej: 1352" className="w-full bg-slate-700 text-white p-2 rounded text-lg font-bold outline-none disabled:bg-slate-700/50 disabled:text-slate-400" />
                                        {!!editingUser && <p className="text-[10px] text-red-400 mt-1">El PIN no se puede cambiar.</p>}
                                    </div>
                                    <div>
                                        <label className="block text-xs font-bold text-blue-400 mb-1">Nombre</label>
                                        <input type="text" value={name} onChange={e => setName(e.target.value)} placeholder="Ej: Vallejo" className="w-full bg-slate-700 text-white p-2 rounded outline-none" />
                                    </div>
                                    <div>
                                        <label className="block text-xs font-bold text-blue-400 mb-1">Área (Opcional)</label>
                                        <input type="text" value={area} onChange={e => setArea(e.target.value)} placeholder="Ej: Desarrollo" className="w-full bg-slate-700 text-white p-2 rounded outline-none" />
                                    </div>
                                    <div>
                                        <label className="block text-xs font-bold text-blue-400 mb-1">Rol</label>
                                        <select value={role} onChange={e => setRole(e.target.value)} className="w-full bg-slate-700 text-white p-2 rounded outline-none">
                                            {availableRoles.map(r => (<option key={r} value={r} className="uppercase">{r}</option>))}
                                        </select>
                                    </div>
{/* Selector de íconos */}
                                    <div>
                                        <label className="block text-xs font-bold text-blue-400 mb-1">
                                            Ícono (pieza de ajedrez)
                                        </label>
                                        <div className="flex flex-wrap gap-2">
                                            {Object.keys(CHESS_ICONS).map(key => {
                                                const selected = icon === key;
                                                return (
                                                    <button
                                                        key={key}
                                                        type="button"
                                                        onClick={() => {
                                                            setIcon(key);
                                                            setEditingUser(prev => prev ? ({ ...prev, icon: key }) : prev);
                                                        }}
                                                        className={`px-2 py-1 rounded text-lg ${
                                                            selected
                                                                ? "bg-green-600 text-white"
                                                                : "bg-slate-700 text-slate-300"
                                                        }`}
                                                    >
                                                        {CHESS_ICONS[key]}
                                                    </button>
                                                );
                                            })}
                                        </div>
                                    </div>

                                    <button 
                                        onClick={handleSave}
                                        className="w-full bg-green-600 hover:bg-green-500 text-white p-2 rounded-lg font-bold shadow mt-4"
                                    >
                                        Guardar Usuario
                                    </button>
                                </div>
                            </div>

                            {/* Lista de Usuarios */}
                            <div className="flex-1 bg-slate-900 p-4 rounded-xl border border-slate-700">
                                <h4 className="text-lg font-bold text-white mb-4 border-b border-slate-700 pb-2">
                                    Usuarios Registrados
                                </h4>
                                <div className="space-y-2">
                                    {allUsersArray.map(user => (
                                        <div 
                                            key={user.pin}
                                            className="flex justify-between items-center p-3 bg-slate-800 rounded-lg border border-slate-700"
                                        >
                                            <div className="flex items-center gap-3">
                                                <span className="text-2xl">{CHESS_ICONS[user.icon] || "•"}</span>
                                                <div>
                                                    <p className="text-white font-bold text-sm">{user.name}</p>
                                                    <p className="text-xs text-blue-300">{user.role.toUpperCase()}</p>
                                                    {user.area && <p className="text-[10px] text-slate-400">{user.area}</p>}
                                                </div>
                                            </div>

                                            <div className="flex items-center gap-2">
                                                <button
                                                    onClick={() => startEdit(user)}
                                                    className="p-2 bg-yellow-500 text-black rounded hover:bg-yellow-400"
                                                >
                                                    <i data-lucide="pencil" className="w-4 h-4"></i>
                                                </button>
                                                <button
                                                    onClick={() => {
                                                        if (confirm("¿Eliminar este usuario?")) onDeleteUser(user.pin);
                                                    }}
                                                    className="p-2 bg-red-600 text-white rounded hover:bg-red-500"
                                                >
                                                    <i data-lucide="trash" className="w-4 h-4"></i>
                                                </button>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };
// --- ACTUALIZAR SLOTS (CORREGIDO PARA 4 SLOTS) ---
        const handleUpdateSlot = async (rowId, machineId, slotIndex, field, value) => {
            const ref = doc(db, "production", rowId);

            const current =
                allProductionData[rowId]?.[machineId]?.slots || [{}, {}, {}, {}];

            const updatedSlots = [...current];
            if (!updatedSlots[slotIndex]) updatedSlots[slotIndex] = {};

            updatedSlots[slotIndex] = {
                ...updatedSlots[slotIndex],
                [field]: field === "qty" ? Number(value || 0) : value
            };

            // Normalizar: siempre 4 slots
            for (let i = 0; i < 4; i++) {
                if (!updatedSlots[i]) updatedSlots[i] = { qty: 0, model: "" };
                updatedSlots[i].qty = Number(updatedSlots[i].qty || 0);
            }

            const newTotalActual = updatedSlots.reduce(
                (acc, s) => acc + (Number(s.qty) || 0),
                0
            );

            await setDoc(
                ref,
                {
                    [machineId]: {
                        slots: updatedSlots,
                        actual: newTotalActual
                    }
                },
                { merge: true }
            );
        };

        // --- ELIMINAR PEDIDO (CORREGIDO PARA MANTENER HISTORIAL) ---
        const handleDeleteOrder = async (machineId) => {
            await setDoc(
                doc(db, "settings", "orders"),
                {
                    [machineId]: {
                        status: "CANCELLED",
                        lastUpdated: serverTimestamp()
                    }
                },
                { merge: true }
            );
        };

        // --- GUARDAR PEDIDO ---
        const handleSaveOrder = async (machineId, order) => {
            await setDoc(
                doc(db, "settings", "orders"),
                {
                    [machineId]: {
                        ...order,
                        status: "ACTIVE",
                        lastUpdated: serverTimestamp()
                    }
                },
                { merge: true }
            );
        };

        // --- TABLA PRINCIPAL ---
        const CalendarTable = ({
            allRows,
            weekOffset,
            selectedDayIndex,
            handleUpdateSlot,
            allProductionData,
            canEditSlot,
            ordersData,
            globalHiddenDays
        }) => {
            const weekRows = allRows.slice(weekOffset * 7, weekOffset * 7 + 7);

            return (
                <div className="w-full overflow-x-auto custom-scrollbar">
                    <table className="w-full border-collapse text-[10px]">
                        <thead>
                            <tr className="bg-slate-800 text-slate-300">
                                <th className="p-1 border border-slate-700">DÍA</th>
                                {MACHINES.map((m) => (
                                    <th
                                        key={m.id}
                                        className="p-1 border border-slate-700 text-center whitespace-nowrap"
                                    >
                                        {m.name}
                                    </th>
                                ))}
                            </tr>
                        </thead>

                        <tbody>
                            {weekRows.map((row) => {
                                const isHiddenDay = globalHiddenDays.includes(row.id);

                                return (
                                    <tr key={row.id} className="border border-slate-800">
                                        {/* Columna del Día */}
                                        <td
                                            className={`border border-slate-800 p-1 text-center font-bold ${
                                                isHiddenDay
                                                    ? "bg-slate-900/40 text-slate-600"
                                                    : "bg-slate-700 text-white"
                                            }`}
                                        >
                                            {row.shortDay}
                                            <br />
                                            {row.dateNum}
                                        </td>

                                        {/* Celdas por máquina */}
                                        {MACHINES.map((m) => {
                                            const slots =
                                                allProductionData[row.id]?.[m.id]?.slots ||
                                                [{}, {}, {}, {}];

                                            return (
                                                <td
                                                    key={m.id}
                                                    className={`border border-slate-800 p-1`}
                                                >
                                                    <div className="grid grid-cols-2 gap-1">
                                                        {(slots || [{}, {}, {}, {}]).map(
                                                            (slot, idx) => (
                                                                <ProductionSlot
                                                                    key={idx}
                                                                    slotData={slot}
                                                                    index={idx}
                                                                    disabled={
                                                                        !canEditSlot(m.id, idx) ||
                                                                        isHiddenDay
                                                                    }
                                                                    onUpdate={(
                                                                        slotIndex,
                                                                        field,
                                                                        val
                                                                    ) =>
                                                                        handleUpdateSlot(
                                                                            row.id,
                                                                            m.id,
                                                                            slotIndex,
                                                                            field,
                                                                            val
                                                                        )
                                                                    }
                                                                />
                                                            )
                                                        )}
                                                    </div>
                                                </td>
                                            );
                                        })}
                                    </tr>
                                );
                            })}
                        </tbody>
                    </table>
                </div>
            );
        };

        // --- BOTÓN DE MÁQUINAS ---
        const MachineSelector = ({ selected, setSelected }) => {
            return (
                <div className="flex gap-2 overflow-x-auto custom-scrollbar p-2 bg-slate-900/40 rounded-lg">
                    {MACHINES.map((m) => (
                        <button
                            key={m.id}
                            onClick={() => setSelected(m.id)}
                            className={`px-3 py-1 text-xs rounded-lg shadow font-bold whitespace-nowrap ${
                                selected === m.id
                                    ? "bg-green-600 text-white"
                                    : "bg-slate-700 text-slate-300"
                            }`}
                        >
                            {m.name}
                        </button>
                    ))}
                </div>
            );
        };

        // --- PANEL DE DETALLE DEL PEDIDO ---
        const MachineOrderPanel = ({ machineId, order, metrics, onDelete, onNewOrder }) => {
            if (!order) return null;

            return (
                <div className="bg-slate-800 p-4 rounded-xl border border-slate-700 shadow-lg mt-4 fade-in">
                    <h3 className="text-yellow-400 text-sm font-bold mb-2">
                        Detalles del Pedido – {machineId.toUpperCase()}
                    </h3>

                    <div className="text-xs space-y-1">
                        <p>
                            <b>Modelo:</b> {order.model}
                        </p>
                        <p>
                            <b>Fecha Inicio:</b> {order.startDate}
                        </p>
                        <p>
                            <b>Cantidad Total:</b> {order.totalQty}
                        </p>
                        <p>
                            <b>Producido:</b> {metrics.produced}
                        </p>
                        <p>
                            <b>Avance:</b> {metrics.progress.toFixed(1)}%
                        </p>

                        {metrics.finishDate && (
                            <p>
                                <b>Fecha Estimada de Finalización:</b> {metrics.finishDate}
                            </p>
                        )}

                        <p>
                            <b>Estado:</b>{" "}
                            <span
                                className={`${
                                    metrics.status === "COMPLETADO"
                                        ? "text-green-400"
                                        : metrics.status.includes("ATRASO")
                                        ? "text-red-400"
                                        : "text-blue-300"
                                }`}
                            >
                                {metrics.status}
                            </span>
                        </p>
                    </div>

                    <div className="flex gap-2 mt-3">
                        <button
                            onClick={onNewOrder}
                            className="px-3 py-1 bg-blue-600 text-white rounded text-xs font-bold"
                        >
                            Programar Siguiente
                        </button>

                        <button
                            onClick={onDelete}
                            className="px-3 py-1 bg-red-600 text-white rounded text-xs font-bold"
                        >
                            Cancelar Pedido
                        </button>
                    </div>
                </div>
            );
        };
// --- LISTA DE PEDIDOS ACTIVOS (CORREGIDO PARA USAR status) ---
        const ActiveOrdersList = ({ ordersData }) => {
            const ordersArray = MACHINES
                .map((m) => ({
                    machineId: m.id,
                    ...ordersData[m.id],
                }))
                .filter(
                    (o) =>
                        o &&
                        o.machineId &&
                        (o.status === "ACTIVE" || !o.status) &&
                        Number(o.totalQty) > 0
                );

            return (
                <div className="bg-slate-800 p-4 rounded-xl border border-slate-700 shadow-lg mt-4">
                    <h3 className="text-yellow-400 text-sm font-bold mb-2">
                        Pedidos Activos
                    </h3>

                    {ordersArray.length === 0 ? (
                        <p className="text-slate-400 text-xs">No hay pedidos activos.</p>
                    ) : (
                        <ul className="text-xs text-white space-y-1">
                            {ordersArray.map((o) => (
                                <li
                                    key={o.machineId}
                                    className="p-2 bg-slate-700 rounded flex justify-between"
                                >
                                    <span>
                                        <b>{o.machineId.toUpperCase()}</b> — {o.model}
                                    </span>
                                    <span className="text-blue-300">
                                        {o.totalQty} piezas
                                    </span>
                                </li>
                            ))}
                        </ul>
                    )}
                </div>
            );
        };

        // --- APLICACIÓN PRINCIPAL ---
        const App = () => {
            const [userPin, setUserPin] = useState("");
            const [currentUser, setCurrentUser] = useState(null);
            const [users, setUsers] = useState(DEFAULT_USERS);
            const [ordersData, setOrdersData] = useState({});
            const [globalHiddenDays, setGlobalHiddenDays] = useState([]);
            const [allProductionData, setAllProductionData] = useState({});
            const [weekOffset, setWeekOffset] = useState(INITIAL_STATE.weekOffset);

            // Cargar usuarios
            useEffect(
                () =>
                    onSnapshot(doc(db, "settings", "users"), (snap) => {
                        if (snap.exists()) setUsers(snap.data());
                    }),
                []
            );

            // Cargar pedidos
            useEffect(
                () =>
                    onSnapshot(doc(db, "settings", "orders"), (snap) => {
                        if (snap.exists()) setOrdersData(snap.data());
                    }),
                []
            );

            // Cargar días ocultos
            useEffect(
                () =>
                    onSnapshot(doc(db, "settings", "hiddenDays"), (snap) => {
                        if (snap.exists()) setGlobalHiddenDays(snap.data().days || []);
                    }),
                []
            );

            // Cargar producción
            useEffect(
                () =>
                    onSnapshot(collection(db, "production"), (snapshot) => {
                        const data = {};
                        snapshot.forEach((doc) => (data[doc.id] = doc.data()));
                        setAllProductionData(data);
                    }),
                []
            );

            // Iniciar sesión por PIN
            const handleLogin = () => {
                if (users[userPin]) {
                    setCurrentUser(users[userPin]);
                } else {
                    alert("PIN incorrecto.");
                }
            };

            const handleLogout = () => setCurrentUser(null);

            if (!currentUser) {
                return (
                    <div className="flex items-center justify-center h-screen bg-slate-900">
                        <div className="p-6 bg-slate-800 rounded-xl shadow-xl border border-slate-700 text-center">
                            <h1 className="text-white font-bold text-lg mb-4">
                                MAES26 — Ingresar PIN
                            </h1>
                            <input
                                type="password"
                                className="p-2 w-40 bg-slate-700 rounded text-center text-white text-xl tracking-widest password-mask"
                                value={userPin}
                                maxLength={4}
                                onChange={(e) => setUserPin(e.target.value)}
                                onKeyDown={(e) => e.key === "Enter" && handleLogin()}
                            />
                            <button
                                onClick={handleLogin}
                                className="block w-full bg-green-600 text-white py-2 mt-4 rounded font-bold"
                            >
                                Entrar
                            </button>
                        </div>
                    </div>
                );
            }

            const canEditSlot = (machineId, slotIndex) => {
                if (currentUser.role === ROLES.ADMIN) return true;
                if (currentUser.role === ROLES.DEVELOPMENT) return true;
                if (currentUser.role !== ROLES.OPERATOR) return false;

                return currentUser.allowedSlots?.includes(slotIndex);
            };

            return (
                <div className="h-screen flex flex-col">
                    {/* Header */}
                    <div className="p-3 bg-slate-900 border-b border-slate-700 flex justify-between items-center">
                        <h1 className="text-white font-bold text-lg">
                            MAES26 CONTROL + PLANEACIÓN
                        </h1>

                        <div className="flex items-center gap-4 text-white text-sm">
                            <span className="flex items-center gap-2">
                                <span className="text-xl">
                                    {CHESS_ICONS[currentUser.icon] || "•"}
                                </span>
                                {currentUser.name}
                            </span>

                            <button
                                onClick={handleLogout}
                                className="bg-red-600 px-3 py-1 rounded text-white text-xs"
                            >
                                Salir
                            </button>
                        </div>
                    </div>

                    {/* Contenido principal */}
                    <div className="flex-1 overflow-y-auto bg-slate-900 p-4 custom-scrollbar">
                        <ActiveOrdersList ordersData={ordersData} />

                        <CalendarTable
                            allRows={ALL_ROWS}
                            weekOffset={weekOffset}
                            selectedDayIndex={INITIAL_STATE.selectedDayIndex}
                            handleUpdateSlot={handleUpdateSlot}
                            allProductionData={allProductionData}
                            canEditSlot={canEditSlot}
                            ordersData={ordersData}
                            globalHiddenDays={globalHiddenDays}
                        />
                    </div>

                    {/* Navegación semanal */}
                    <div className="bg-slate-900 p-3 border-t border-slate-700 flex justify-between">
                        <button
                            onClick={() => setWeekOffset(Math.max(0, weekOffset - 1)))}
                            className="px-3 py-1 bg-slate-700 text-white rounded"
                        >
                            ◀ Semana anterior
                        </button>
                        <button
                            onClick={() => setWeekOffset(weekOffset + 1)}
                            className="px-3 py-1 bg-slate-700 text-white rounded"
                        >
                            Semana siguiente ▶
                        </button>
                    </div>
                </div>
            );
        };

        // Render
        ReactDOM.render(<App />, document.getElementById("root"));
    </script>
</body>
</html>