<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sweaters Liliana Base de datos 2026 v01</title>
    
    <link id="appIcon" rel="icon" href="https://raw.githubusercontent.com/jesusvn1993mplvt3-ai/CIRINEO/refs/heads/main/icon.ico">
    <link id="appAppleIcon" rel="apple-touch-icon" href="https://raw.githubusercontent.com/jesusvn1993mplvt3-ai/CIRINEO/refs/heads/main/icon.ico">
    <meta name="theme-color" content="#1e293b">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    
    <style>
        /* Estilos base para la tipograf√≠a y el fondo (Responsive) */
        .dashboard-grid {
            display: flex;
            flex-direction: column; /* M√≥vil: Apilado Verticalmente */
            min-height: 100vh;
        }
        
        /* Layout para Escritorio (lg: 1024px o m√°s) */
        @media (min-width: 1024px) {
            .dashboard-grid {
                display: grid;
                grid-template-columns: 1fr 320px; /* Contenido principal y barra lateral de 320px */
                height: 100vh;
                overflow: hidden; /* Evita scroll en el layout principal de escritorio */
            }
            .main-content, .sidebar {
                height: 100vh;
                overflow-y: auto; /* Permite scroll en cada secci√≥n si el contenido es largo */
            }
        }
        
        /* Estilos mejorados para el texto din√°mico */
        .status-text {
            font-size: 2.5rem; /* 40px en m√≥vil */
            font-weight: 800;
            line-height: 1.3;
            text-align: center;
            text-shadow: 0 0 10px rgba(0,0,0,0.8);
            min-height: 120px;
        }
        @media (min-width: 768px) {
            .status-text {
                font-size: 3.5rem; /* 56px en escritorio */
                min-height: 150px;
            }
        }
        
        /* Animaci√≥n de Transici√≥n del Texto */
        .status-enter { opacity: 0; transform: scale(0.9) translateY(20px); }
        .status-enter-active { opacity: 1; transform: scale(1) translateY(0); transition: opacity 0.5s, transform 0.5s; }
        .status-exit { opacity: 1; transform: scale(1) translateY(0); }
        .status-exit-active { opacity: 0; transform: scale(1.1) translateY(-20px); transition: opacity 0.4s, transform 0.4s; }
        
        /* Estilos del Radio y Scrollbars */
        .radio-list { max-height: 180px; overflow-y: auto; }
        .radio-list::-webkit-scrollbar { width: 6px; background-color: transparent; }
        .radio-list::-webkit-scrollbar-thumb { background: var(--accent-color); border-radius: 3px; }

    </style>
</head>
<body class="font-sans">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;
        const Icon = ({ name, size = 20, className }) => {
            useEffect(() => { lucide.createIcons(); }, [name]);
            return <i data-lucide={name} width={size} height={size} className={className}></i>;
        };

        // --- Configuraci√≥n de Firebase (Mant√©n esto en un lugar seguro y privado) ---
        const firebaseConfig = {
            apiKey: "AIzaSyBqHgV4vDat1-VmZfKbiPg7nuiX-ROcexw",
            authDomain: "cirineo-cec21.firebaseapp.com",
            projectId: "cirineo-cec21",
            storageBucket: "cirineo-cec21.firebasestorage.app",
            messagingSenderId: "620210618284",
            appId: "1:620210618284:web:482bab9bf74650fff18409",
            measurementId: "G-B7YLM78RVW"
        };

        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // --- DEFINICI√ìN DE TEMAS ---
        const themeConfig = {
            darkIndustrial: {
                id: 'darkIndustrial',
                name: "Industrial Oscuro",
                primaryBg: "bg-slate-900",
                secondaryBg: "bg-slate-800",
                accentColor: "text-sky-400",
                warningColor: "text-red-400",
                textColor: "text-white",
                navBtnColor: "bg-indigo-600 hover:bg-indigo-700",
                widgetBg: "bg-slate-700/50 backdrop-blur-sm",
                clockBg: "bg-slate-700"
            },
            cleanLight: {
                id: 'cleanLight',
                name: "Claro Limpio",
                primaryBg: "bg-gray-100",
                secondaryBg: "bg-white",
                accentColor: "text-teal-600",
                warningColor: "text-red-600",
                textColor: "text-gray-800",
                navBtnColor: "bg-teal-600 hover:bg-teal-700",
                widgetBg: "bg-white border border-gray-200",
                clockBg: "bg-teal-100 text-teal-800"
            }
        };

        // --- UTILS (Mantienes las funciones de l√≥gica de negocio) ---
        const calculateTimeDiff = (timestamp) => {
            // ... (L√≥gica de calculateTimeDiff se mantiene igual)
            if (!timestamp) return { days: 0, hours: 0 };
            const now = Date.now();
            let date = timestamp;
            if (typeof date === 'string') {
                date = new Date(date);
            } else if (timestamp.toDate) {
                date = timestamp.toDate();
            }

            const diffMs = now - date.getTime();
            const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
            const diffHours = Math.floor((diffMs % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            return { days: diffDays, hours: diffHours };
        };

        const calculateOrderStatus = (order) => {
            // ... (L√≥gica de calculateOrderStatus se mantiene igual, adaptada para ser m√°s robusta)
            const finishedPackages = order.progreso.filter(p => p.finished).length;
            const totalPackages = order.progreso.length;
            const piecesLeft = order.totalPedido - order.progreso.filter(p => p.finished).reduce((sum, p) => sum + p.cantidad, 0);
            const efficiency = totalPackages > 0 ? (finishedPackages / totalPackages) * 100 : 0;
            
            const lastUpdateDate = order.progreso.reduce((latest, p) => {
                const date = p.fecha ? new Date(p.fecha) : new Date(0);
                return date > latest ? date : latest;
            }, new Date(0));
            
            const lastUpdateTime = lastUpdateDate.getTime() > 0 ? lastUpdateDate.getTime() : order.createdAt.toDate().getTime();

            const timeSinceCreation = calculateTimeDiff(order.createdAt);
            const timeSinceLastUpdate = calculateTimeDiff(lastUpdateTime);
            
            // C√°lculo del tiempo restante (simplificado y mejorado para el display)
            let totalMinutesLeft = 0;
            order.subPiecesData.forEach(p => {
                const packagesToFinish = order.progreso.filter(pkg => pkg.piezaNombre === p.pieza && !pkg.finished);
                const totalPiecesInRemainingPackages = packagesToFinish.reduce((sum, pkg) => sum + pkg.cantidad, 0);
                const pieceTime = Number(p.tiempo) || 0;
                totalMinutesLeft += (totalPiecesInRemainingPackages * pieceTime);
            });

            const totalHoursLeft = totalMinutesLeft / 60;
            const daysLeft = Math.floor(totalHoursLeft / 24);
            const hoursLeft = Math.round(totalHoursLeft % 24);
            
            let statusMessage = '';
            let isWarning = false;

            if (piecesLeft <= 0) {
                statusMessage = `‚úÖ Orden ${order.codigo} (M√°quina #${order.maquina}) TERMINADA.`;
            } else if (timeSinceLastUpdate.days >= 3) {
                statusMessage = `üî¥ Maq #${order.maquina}: Modelo ${order.codigo}. La orden se ingres√≥ hace ${timeSinceCreation.days} d√≠as y no ha habido **actualizaci√≥n** en ${timeSinceLastUpdate.days} d√≠as.`;
                isWarning = true;
            } else if (totalHoursLeft > 0) {
                 statusMessage = `‚è±Ô∏è M√°quina #${order.maquina}: Faltan ${daysLeft} d√≠as y ${hoursLeft} hrs para terminar el modelo ${order.codigo}. Eficiencia: ${efficiency.toFixed(0)}%.`;
                 if (efficiency < 50) isWarning = true;
            } else {
                 statusMessage = `M√°quina #${order.maquina}: Modelo ${order.codigo}. En proceso.`;
            }

            return { statusMessage, isWarning, maquina: order.maquina, codigo: order.codigo };
        };

        // --- COMPONENTES ---

        const Clock = ({ theme }) => {
            const [time, setTime] = useState(new Date());
            useEffect(() => {
                const timer = setInterval(() => setTime(new Date()), 1000);
                return () => clearInterval(timer);
            }, []);
            
            const accentColor = theme.accentColor.replace('text-', 'text-');
            
            return (
                <div className={`text-center font-mono p-4 rounded-lg shadow-2xl transition-colors ${theme.clockBg} ${theme.textColor === 'text-white' ? 'text-white' : 'text-gray-800'}`}>
                    <div className="text-6xl lg:text-7xl font-black">{time.toLocaleTimeString('es-MX', { hour: '2-digit', minute: '2-digit', second: '2-digit' })}</div>
                    <div className={`text-sm font-semibold mt-1 ${accentColor}`}>{time.toLocaleDateString('es-MX', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}</div>
                </div>
            );
        };
        
        const NavButtons = ({ theme }) => {
            const buttons = [
                { name: "Inventario", url: "https://jesusvn1993mplvt3-ai.github.io/Doc/", icon: "warehouse", color: theme.navBtnColor.replace('indigo', 'orange') },
                { name: "Santoni", url: "https://jesusvn1993mplvt3-ai.github.io/CIRINEO/", icon: "socks", color: theme.navBtnColor.replace('indigo', 'sky') },
                { name: "Calcet√≠n", url: "https://sweaters-liliana.github.io/MAES26/", icon: "shoe", color: theme.navBtnColor.replace('indigo', 'green') },
            ];
            const headerColor = theme.textColor.replace('text-', 'text-');
            const dividerColor = theme.textColor === 'text-white' ? 'border-slate-700' : 'border-slate-300';

            return (
                <div className={`mt-8 pt-4 border-t ${dividerColor}`}>
                    <h3 className={`font-extrabold text-xl mb-4 flex items-center gap-2 ${headerColor}`}><Icon name="link" size={20} className={theme.accentColor.replace('text-', '')}/> Accesos R√°pidos</h3>
                    <div className="space-y-4">
                        {buttons.map((btn) => (
                            <a key={btn.name} href={btn.url} target="_blank" rel="noopener noreferrer" className={`w-full flex items-center justify-between p-4 rounded-xl font-bold text-white shadow-xl transition-all transform hover:scale-[1.03] ${btn.color}`}>
                                <span className="text-lg">{btn.name}</span>
                                <Icon name={btn.icon} size={28}/>
                            </a>
                        ))}
                    </div>
                </div>
            );
        };

        const RadioPlayer = ({ theme }) => {
            const [stations, setStations] = useState([]);
            const [searchUrl, setSearchUrl] = useState('');
            const [name, setName] = useState('');
            const [currentStation, setCurrentStation] = useState(null);
            const audioRef = useRef(new Audio());
            
            useEffect(() => {
                const unsubscribe = db.collection('radioStations').onSnapshot(s => {
                    setStations(s.docs.map(d => ({ id: d.id, ...d.data() })));
                });
                audioRef.current.volume = 0.5;
                return () => { unsubscribe(); audioRef.current.pause(); };
            }, []);

            const playStation = (station) => {
                if (currentStation && currentStation.id === station.id) {
                    audioRef.current.pause();
                    setCurrentStation(null);
                } else {
                    audioRef.current.src = station.url;
                    audioRef.current.play().catch(e => console.error("Error al reproducir:", e));
                    setCurrentStation(station);
                }
            };

            const addStation = async () => {
                if (name && searchUrl) {
                    await db.collection('radioStations').add({ name, url: searchUrl, addedAt: firebase.firestore.FieldValue.serverTimestamp() });
                    setName('');
                    setSearchUrl('');
                }
            };
            
            const deleteStation = async (id) => {
                if (window.confirm("¬øSeguro que quieres eliminar esta estaci√≥n?")) {
                    await db.collection('radioStations').doc(id).delete();
                    if (currentStation && currentStation.id === id) {
                         audioRef.current.pause();
                         setCurrentStation(null);
                    }
                }
            };
            
            const accentTextClass = theme.accentColor;
            const stationBg = theme.textColor === 'text-white' ? 'bg-slate-700 hover:bg-slate-600' : 'bg-gray-200 hover:bg-gray-300';
            const playingBg = theme.accentColor.replace('text-', 'bg-').replace('-400', '-200');
            const playingText = theme.accentColor.replace('text-', 'text-');
            const inputBg = theme.textColor === 'text-white' ? 'bg-slate-900 border-slate-600 text-white' : 'bg-white border-gray-300 text-gray-800';
            const saveBtnColor = theme.navBtnColor;

            return (
                <div className={`mt-6 p-4 rounded-xl shadow-lg transition-colors ${theme.widgetBg} ${theme.textColor}`} style={{ '--accent-color': theme.accentColor.replace('text-', '#') }}>
                    <h3 className={`font-bold text-xl mb-3 flex items-center gap-2 ${accentTextClass}`}><Icon name="radio" size={20}/> Radio FM/Internet</h3>
                    
                    <div className="flex items-center gap-2 mb-3">
                        <input type="range" min="0" max="1" step="0.01" defaultValue="0.5" onChange={(e) => audioRef.current.volume = e.target.value} className={`flex-1 accent-current ${theme.accentColor.replace('text-', '')}`} />
                        <Icon name="volume-2" size={18} className="text-current"/>
                    </div>

                    <div className="radio-list space-y-2 mb-3 border-b border-current/30 pb-3">
                        {stations.map(s => (
                            <div key={s.id} className={`flex items-center justify-between text-sm p-2 rounded transition-colors ${stationBg} ${currentStation?.id === s.id ? `${playingBg} ${playingText} font-bold` : ''}`}>
                                <div className="truncate">{s.name}</div>
                                <div className="flex gap-1 shrink-0">
                                    <button onClick={() => playStation(s)} className={`p-1 rounded transition-colors text-white ${currentStation?.id === s.id ? 'bg-red-500 hover:bg-red-600' : 'bg-green-500 hover:bg-green-600'}`}>
                                        <Icon name={currentStation?.id === s.id ? "pause" : "play"} size={16}/>
                                    </button>
                                    <button onClick={() => deleteStation(s.id)} className="p-1 bg-red-500/10 text-red-400 rounded hover:bg-red-500/20">
                                         <Icon name="trash-2" size={16}/>
                                    </button>
                                </div>
                            </div>
                        ))}
                        {stations.length === 0 && <p className="text-sm text-current/70 text-center">No hay estaciones guardadas.</p>}
                    </div>
                    
                    <p className="text-sm font-bold text-current/80 mb-1">AGREGAR ESTACI√ìN:</p>
                    <input type="text" placeholder="Nombre (Ej: La Zeta)" value={name} onChange={(e) => setName(e.target.value)} className={`w-full p-2 mb-1 text-sm border rounded ${inputBg}`} />
                    <input type="url" placeholder="URL de Stream (.mp3, .m3u, .m3u8)" value={searchUrl} onChange={(e) => setSearchUrl(e.target.value)} className={`w-full p-2 mb-2 text-sm border rounded ${inputBg}`} />
                    <button onClick={addStation} disabled={!name || !searchUrl} className={`w-full text-white font-bold p-3 rounded-lg text-sm transition-all shadow-md ${saveBtnColor} disabled:opacity-50 disabled:cursor-not-allowed`}>
                        <Icon name="save" size={18} className="inline mr-1"/> Guardar Estaci√≥n
                    </button>
                </div>
            );
        };

        const WeatherWidget = ({ theme }) => {
            // Datos simulados (Puedes reemplazar esto con una API de clima real m√°s adelante)
            const city = "LE√ìN, GTO.";
            const temp = "25¬∞C";
            const icon = "sun";
            const desc = "Soleado";

            const accentTextClass = theme.accentColor;

            return (
                <div className={`p-4 rounded-xl shadow-lg transition-colors ${theme.widgetBg} ${theme.textColor}`}>
                    <h3 className={`font-bold text-xl mb-3 flex items-center gap-2 ${accentTextClass}`}><Icon name="cloud-lightning" size={20}/> Clima de la Zona</h3>
                    <div className="flex justify-between items-center p-2">
                        <div>
                            <div className={`text-5xl font-black ${accentTextClass}`}>{temp}</div>
                            <div className="text-base font-semibold text-current/80">{desc}</div>
                        </div>
                        <Icon name={icon} size={64} className="text-yellow-400 drop-shadow-lg"/>
                    </div>
                    <div className="text-xs mt-3 text-current/60 font-bold border-t border-current/30 pt-2">Ubicaci√≥n: {city} (Simulado)</div>
                </div>
            );
        };
        
        const ThemeSwitcher = ({ theme, setTheme }) => {
            const themesArray = Object.values(themeConfig);
            
            return (
                <div className="p-4 rounded-xl shadow-lg bg-slate-700/50 backdrop-blur-sm text-white mt-6">
                    <h3 className="font-bold text-xl mb-3 flex items-center gap-2 text-white"><Icon name="palette" size={20}/> Temas</h3>
                    <div className="flex space-x-3">
                        {themesArray.map((t) => (
                            <button 
                                key={t.id} 
                                onClick={() => setTheme(t.id)} 
                                className={`flex-1 p-2 rounded-lg text-sm font-semibold transition-all shadow-md ${t.id === theme.id ? 'ring-4 ring-offset-2 ring-sky-500' : 'hover:opacity-80'}`}
                                style={{backgroundColor: t.secondaryBg.replace('bg-', ''), color: t.textColor.includes('white') ? 'white' : 'black'}}
                            >
                                {t.name}
                            </button>
                        ))}
                    </div>
                </div>
            )
        }

        // --- COMPONENTE PRINCIPAL DE LA P√ÅGINA ---

        const App = () => {
            const [orders, setOrders] = useState([]);
            const [inventory, setInventory] = useState([]);
            const [dynamicText, setDynamicText] = useState("Cargando datos...");
            const [textKey, setTextKey] = useState(0); 
            const [isWarning, setIsWarning] = useState(false);
            const [currentThemeId, setCurrentThemeId] = useState('darkIndustrial'); // Tema por defecto
            
            const theme = themeConfig[currentThemeId];

            useEffect(() => {
                const u1 = db.collection('orders').where('status', '!=', 'ARCHIVADO').onSnapshot(s => setOrders(s.docs.map(d=>d.data()).filter(d=>d.progreso && d.progreso.length > 0)));
                const u2 = db.collection('inventory').doc('main').onSnapshot(d => setInventory(d.data()?.items || []));
                return () => { u1(); u2(); };
            }, []);

            const allStatuses = useMemo(() => {
                const statuses = [];
                const inventoryCopy = [...inventory];
                
                // 1. Agregar estados de Inventario (M√°ximo 3, seleccionados al azar si hay muchos)
                for (let i = 0; i < Math.min(3, inventoryCopy.length); i++) {
                    const randomIndex = Math.floor(Math.random() * inventoryCopy.length);
                    const item = inventoryCopy.splice(randomIndex, 1)[0]; // Saca el item para no repetirlo
                    
                    const text = `üìä INVENTARIO: ${item.material} ${item.calibre || ''} Stock ${Number(item.stock).toFixed(1)} kg.`;
                    const isWarn = Number(item.stock) < Number(item.minStock);
                    
                    statuses.push({ text: isWarn ? `‚ö†Ô∏è ${text}` : text, isWarning: isWarn, type: 'inventory' });
                }

                // 2. Agregar estados de √ìrdenes (Solo √≥rdenes con problemas o relevantes)
                const relevantOrders = orders.map(calculateOrderStatus).filter(s => s.isWarning || s.statusMessage.includes('Faltan'));
                relevantOrders.forEach(status => {
                    statuses.push({
                        text: status.statusMessage,
                        isWarning: status.isWarning,
                        type: 'order',
                    });
                });
                
                // Si no hay problemas, o pocas √≥rdenes, agregar un mensaje gen√©rico.
                if (statuses.length < 3) {
                     statuses.push({ text: "Operaci√≥n en L√≠nea. Revisando el flujo de producci√≥n...", isWarning: false, type: 'idle' });
                }

                return statuses.length > 0 ? statuses : [{ text: "Bienvenido a Sweaters Liliana. Sistema en l√≠nea.", isWarning: false, type: 'welcome' }];
            }, [orders, inventory]);
            
            // L√≥gica del timer para alternar el texto
            useEffect(() => {
                if (allStatuses.length === 0) return;

                let currentIndex = 0;
                const updateStatus = () => {
                    const status = allStatuses[currentIndex % allStatuses.length];
                    setDynamicText(status.text);
                    setIsWarning(status.isWarning);
                    setTextKey(prev => prev + 1);

                    currentIndex++;
                };

                updateStatus(); // Ejecutar inmediatamente al cargar
                const interval = setInterval(updateStatus, 6000); // Cambiar cada 6 segundos

                return () => clearInterval(interval);
            }, [allStatuses]);

            // Aplicar el tema al <body>
            useEffect(() => {
                document.body.className = theme.primaryBg;
            }, [theme]);
            
            // Determinar la clase para el texto din√°mico (Advertencia o Acento)
            const dynamicTextColorClass = isWarning ? theme.warningColor : theme.accentColor;

            return (
                <div className="dashboard-grid">
                    {/* --- Contenido Principal (Visualizaci√≥n de Datos) --- */}
                    <div className={`main-content p-8 lg:p-12 flex items-center justify-center transition-colors ${theme.primaryBg}`}>
                        <div className="text-center w-full max-w-4xl mx-auto">
                            <h1 className={`text-5xl lg:text-7xl font-extrabold ${theme.accentColor} mb-4 tracking-tighter`}>
                                SWEATERS LILIANA
                            </h1>
                            <h2 className={`text-xl lg:text-2xl font-bold ${theme.textColor} opacity-70 mb-10`}>
                                DASHBOARD PRINCIPAL <span className="text-yellow-500">2026 v01</span>
                            </h2>
                            
                            {/* Visualizador de Estado Din√°mico */}
                            <div key={textKey} className={`status-text mx-auto status-enter status-enter-active ${dynamicTextColorClass}`}>
                                {dynamicText}
                            </div>
                            
                            <div className="mt-12 w-full max-w-lg mx-auto">
                                <Clock theme={theme} />
                            </div>
                            
                        </div>
                    </div>
                    
                    {/* --- Barra Lateral (Widgets y Navegaci√≥n) --- */}
                    <div className={`sidebar p-6 lg:p-8 transition-colors ${theme.secondaryBg} ${theme.textColor}`}>
                        <WeatherWidget theme={theme} />
                        <RadioPlayer theme={theme} />
                        <ThemeSwitcher theme={theme} setTheme={setCurrentThemeId} />
                        <NavButtons theme={theme} />
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>