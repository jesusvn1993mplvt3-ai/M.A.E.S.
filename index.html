<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agrupador de Papeletas Cirineo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.0/dist/JsBarcode.all.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@400;700&family=Roboto+Condensed:wght@400;700&display=swap" rel="stylesheet">

    <style>
        body { background-color: #f1f5f9; font-family: 'Roboto Condensed', sans-serif; }
        /* Estilos para la etiqueta apilada */
        .stacked-label-container {
            width: 6in; /* Ancho fijo para PDF */
            display: flex;
            background: white;
            border: 2px solid black;
            box-sizing: border-box;
            height: auto; 
            min-height: 4in;
        }
        .stack-left-col { width: 25%; border-right: 2px solid black; display: flex; flex-direction: column; }
        .stack-mid-col { width: 60%; border-right: 2px solid black; display: flex; flex-direction: column; }
        .stack-right-col { width: 15%; display: flex; align-items: center; justify-content: center; background: #fff; overflow: hidden; }
        
        .mini-label-row { display: flex; height: 25%; border-bottom: 2px solid black; box-sizing: border-box;}
        .mini-label-row:last-child { border-bottom: none; }
        
        .mini-img { width: 100%; height: 100%; object-fit: contain; padding: 2px; }
        .lbl-data-row { display: flex; border-bottom: 1px solid #000; height: 33.33%; }
        .lbl-data-col { padding: 1px 4px; border-right: 1px solid #000; display: flex; flex-direction: column; justify-content: center;}
        .lbl-title { font-size: 8px; font-weight: 700; color: #555; text-transform: uppercase; line-height: 1; }
        .lbl-val { font-family: 'Oswald'; font-weight: 700; font-size: 16px; line-height: 1; color: black;}
        .lbl-val-big { font-family: 'Oswald'; font-weight: 700; font-size: 24px; line-height: 0.9; color: black;}
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;
        const firebaseConfig = { apiKey: "AIzaSyCngQL1pdqghv2vbjkPycT1Xf0C46f7jYs", authDomain: "cirineo-cec21.firebaseapp.com", projectId: "cirineo-cec21", storageBucket: "cirineo-cec21.firebasestorage.app", messagingSenderId: "620210618284", appId: "1:620210618284:web:482bab9bf74650fff18409" };
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        const Icon = ({ name }) => {
            const r = useRef(null);
            useEffect(() => { if (r.current && lucide.icons[name]) r.current.innerHTML = lucide.icons[name].toSvg({ width: 16, height: 16 }); }, [name]);
            return <span ref={r} className="inline-block"/>;
        };

        // --- Componente de una fila de etiqueta (sin barcode individual) ---
        const MiniLabelRow = ({ pkgData, orderData, imgSrc }) => (
            <div className="mini-label-row" style={{height: '1.2in'}}> 
                {/* Izquierda: Imagen */}
                <div className="w-1/4 border-r-2 border-black p-1 flex items-center justify-center">
                     {imgSrc ? <img src={imgSrc} className="mini-img"/> : <span className="text-xs text-gray-400">Sin img</span>}
                </div>
                {/* Centro: Datos */}
                <div className="w-3/4 flex flex-col">
                    <div className="lbl-data-row">
                        <div className="w-2/3 lbl-data-col bg-black text-white"><span className="lbl-title text-gray-300">MODELO</span><span className="lbl-val-big text-white">{orderData.codigo}</span></div>
                        <div className="w-1/3 lbl-data-col text-center"><span className="lbl-title">PAQUETE</span><span className="lbl-val-big">{pkgData.paqueteNum}/{pkgData.paquetesDePieza}</span></div>
                    </div>
                    <div className="lbl-data-row bg-gray-100">
                         <div className="w-full lbl-data-col flex items-center justify-center"><span className="lbl-val-big" style={{fontSize:'32px'}}>{pkgData.piezaNombre?.split(' ')[0]}</span></div>
                    </div>
                    <div className="lbl-data-row" style={{borderBottom:'none'}}>
                        <div className="w-2/3 lbl-data-col"><span className="lbl-title">CLIENTE</span><span className="lbl-val truncate text-xs">{orderData.cliente}</span></div>
                        <div className="w-1/3 lbl-data-col text-center bg-red-50 text-red-900"><span className="lbl-title text-red-700">PARTIDA</span><span className="lbl-val text-sm">{orderData.partida}</span></div>
                    </div>
                </div>
            </div>
        );

        // --- Componente Principal de la Etiqueta Agrupada ---
        const StackedLabel = ({ selectedPackages, order, imageSources }) => {
            const svgRef = useRef(null);
            const [imgSrc, setImgSrc] = useState(null);

            // 1. Generar el "Súper Código"
            const indexes = selectedPackages.map(p => p.paqueteNum).join(',');
            // Formato mágico: GRP|MODELO|PARTIDA|INDICES
            const groupBarcodeValue = `GRP|${order.codigo}|${order.partida || 'SN'}|${indexes}`;

            useEffect(() => {
                if(imageSources?.length > 0 && order.codigo) setImgSrc(`${imageSources[0].url}/${order.codigo}.jpg`);
                else setImgSrc(null);
            }, [order.codigo, imageSources]);

            useEffect(() => {
                if (svgRef.current && groupBarcodeValue) {
                    try {
                        // Usamos CODE128 que permite caracteres alfanuméricos
                        JsBarcode(svgRef.current, groupBarcodeValue, { 
                            format: "CODE128", width: 1.5, height: 80, displayValue: false, margin: 5 
                        });
                    } catch (e) { console.error("Barcode error", e); }
                }
            }, [groupBarcodeValue]);

            // Calculamos la altura total basada en cuántos paquetes hay
            const totalHeight = `${selectedPackages.length * 1.2}in`;

            return (
                <div className="stacked-label-container" style={{height: totalHeight}}>
                    <div className="w-10/12 flex flex-col border-r-2 border-black">
                        {selectedPackages.map((pkg, idx) => (
                            <MiniLabelRow key={idx} pkgData={pkg} orderData={order} imgSrc={imgSrc} />
                        ))}
                    </div>
                    {/* Barra lateral derecha con el código maestro */}
                    <div className="w-2/12 flex items-center justify-center bg-white overflow-hidden relative">
                         <div style={{ 
                             transform: 'rotate(90deg)', 
                             whiteSpace: 'nowrap',
                             display: 'flex', flexDirection: 'column', alignItems: 'center'
                         }}>
                            <svg ref={svgRef}></svg>
                            {/* Mostramos el código "humano" para debug, en producción se puede quitar */}
                            <span className="text-[8px] font-mono mt-1">{groupBarcodeValue}</span>
                        </div>
                    </div>
                </div>
            );
        };

        const App = () => {
            const [orders, setOrders] = useState([]);
            const [selectedOrder, setSelectedOrder] = useState(null);
            const [availablePackages, setAvailablePackages] = useState([]);
            const [checkedPackages, setCheckedPackages] = useState({});
            const [imageSources, setImageSources] = useState([]);
            const pdfRef = useRef(null);
            const [isGenerating, setIsGenerating] = useState(false);

            useEffect(() => {
                 db.collection('app_config').doc('imagenes').onSnapshot(d => setImageSources(d.data()?.sources || []));
                 db.collection('orders').where('status', '!=', 'ARCHIVADO').onSnapshot(s => {
                     setOrders(s.docs.map(d => ({...d.data(), id: d.id})).sort((a,b)=>b.id - a.id));
                 });
            }, []);

            useEffect(() => {
                if(selectedOrder && selectedOrder.progreso) {
                    // Filtrar solo paquetes únicos y ordenarlos
                    const unique = [];
                    const map = new Map();
                    selectedOrder.progreso.forEach(p => {
                        if(!map.has(p.paqueteNum)) {
                            map.set(p.paqueteNum, true);
                            unique.push(p);
                        }
                    });
                    setAvailablePackages(unique.sort((a,b) => a.paqueteNum - b.paqueteNum));
                    setCheckedPackages({}); // Resetear selección
                } else {
                    setAvailablePackages([]);
                }
            }, [selectedOrder]);

            const handleCheck = (pkgNum) => {
                setCheckedPackages(prev => ({...prev, [pkgNum]: !prev[pkgNum]}));
            };

            const selectedPackagesList = useMemo(() => {
                return availablePackages.filter(p => checkedPackages[p.paqueteNum]);
            }, [availablePackages, checkedPackages]);

            const downloadPDF = async () => {
                if(selectedPackagesList.length === 0) return;
                setIsGenerating(true);
                await new Promise(r => setTimeout(r, 500));
                const opt = {
                    margin: 0,
                    filename: `GRUPO_${selectedOrder.codigo}_${selectedPackagesList.length}pzs.pdf`,
                    image: { type: 'jpeg', quality: 0.98 },
                    html2canvas: { scale: 2, useCORS: true },
                    jsPDF: { unit: 'in', format: [6, selectedPackagesList.length * 1.2], orientation: 'portrait' } // Altura dinámica
                };
                try { await html2pdf().set(opt).from(pdfRef.current).save(); } catch(e){console.error(e);}
                setIsGenerating(false);
            };

            return (
                <div className="flex h-screen overflow-hidden">
                    {/* Sidebar de Órdenes */}
                    <div className="w-64 bg-slate-800 text-white p-4 overflow-y-auto shrink-0">
                        <h1 className="text-xl font-bold text-blue-400 mb-4 flex items-center gap-2"><Icon name="layers"/> AGRUPADOR</h1>
                        <div className="space-y-2">
                            {orders.map(o => (
                                <div key={o.id} onClick={() => setSelectedOrder(o)} 
                                     className={`p-3 rounded cursor-pointer border-l-4 ${selectedOrder?.id === o.id ? 'border-blue-400 bg-slate-700' : 'border-transparent hover:bg-slate-700'}`}>
                                    <div className="font-bold">{o.codigo}</div>
                                    <div className="text-xs text-slate-400">{o.cliente}</div>
                                </div>
                            ))}
                        </div>
                    </div>

                    {/* Área Principal */}
                    <div className="flex-1 flex flex-col bg-slate-100 overflow-hidden">
                        {selectedOrder ? (
                            <>
                                {/* Header y Selección de Paquetes */}
                                <div className="bg-white p-4 border-b shadow-sm z-10">
                                    <div className="flex justify-between items-center mb-4">
                                        <div>
                                            <h2 className="text-2xl font-bold text-slate-800">{selectedOrder.codigo}</h2>
                                            <p className="text-sm text-slate-500 font-bold">{selectedOrder.partida}</p>
                                        </div>
                                        <button onClick={downloadPDF} disabled={selectedPackagesList.length === 0 || isGenerating}
                                                className={`px-6 py-3 rounded-lg font-bold text-white flex items-center gap-2 shadow-lg transition-all
                                                    ${selectedPackagesList.length === 0 ? 'bg-slate-400 cursor-not-allowed' : 'bg-blue-600 hover:bg-blue-700 active:scale-95'}`}>
                                            <Icon name="printer"/> {isGenerating ? 'GENERANDO...' : `IMPRIMIR GRUPO (${selectedPackagesList.length})`}
                                        </button>
                                    </div>
                                    <div className="flex flex-wrap gap-2 max-h-32 overflow-y-auto p-2 bg-slate-50 rounded border">
                                        {availablePackages.map(p => (
                                            <label key={p.paqueteNum} 
                                                   className={`flex items-center gap-2 px-3 py-2 rounded border cursor-pointer select-none transition-colors
                                                       ${checkedPackages[p.paqueteNum] ? 'bg-blue-100 border-blue-500 text-blue-800 font-bold' : 'bg-white border-slate-300 hover:bg-slate-100'}`}>
                                                <input type="checkbox" checked={!!checkedPackages[p.paqueteNum]} onChange={() => handleCheck(p.paqueteNum)} className="hidden"/>
                                                <Icon name={checkedPackages[p.paqueteNum] ? "check-square" : "square"}/>
                                                Pqt. {p.paqueteNum}
                                            </label>
                                        ))}
                                    </div>
                                </div>

                                {/* Vista Previa */}
                                <div className="flex-1 overflow-y-auto p-8 bg-slate-200 flex justify-center relative">
                                    {selectedPackagesList.length > 0 ? (
                                        <div className="shadow-2xl bg-white scale-75 origin-top" style={{width: '6in'}}>
                                             {/* Este div es el que se imprime */}
                                            <div ref={pdfRef}>
                                                <StackedLabel selectedPackages={selectedPackagesList} order={selectedOrder} imageSources={imageSources} />
                                            </div>
                                        </div>
                                    ) : (
                                        <div className="flex flex-col items-center justify-center text-slate-400 h-64">
                                            <Icon name="package-plus" size={48}/>
                                            <p className="font-bold mt-2">Selecciona paquetes para agrupar</p>
                                        </div>
                                    )}
                                </div>
                            </>
                        ) : (
                            <div className="flex-1 flex items-center justify-center text-slate-400 font-bold">Selecciona una orden &larr;</div>
                        )}
                    </div>
                </div>
            );
        };
        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>