<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema Textil Cloud - Cirineo</title>
    
    <link id="appIcon" rel="icon" href="https://raw.githubusercontent.com/jesusvn1993mplvt3-ai/CIRINEO/refs/heads/main/icon.ico">
    <link id="appAppleIcon" rel="apple-touch-icon" href="https://raw.githubusercontent.com/jesusvn1993mplvt3-ai/CIRINEO/refs/heads/main/icon.ico">
    <meta name="theme-color" content="#1e293b">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <script>
        const manifest = {
            "name": "Sistema Textil Cloud",
            "short_name": "Cirineo",
            "start_url": ".",
            "display": "standalone",
            "background_color": "#f1f5f9",
            "theme_color": "#1e293b",
            "icons": [{
                "src": "https://raw.githubusercontent.com/jesusvn1993mplvt3-ai/CIRINEO/refs/heads/main/icon.ico",
                "sizes": "192x192",
                "type": "image/ico"
            }]
        };
        const stringManifest = JSON.stringify(manifest);
        const blob = new Blob([stringManifest], {type: 'application/json'});
        const manifestURL = URL.createObjectURL(blob);
        const link = document.createElement('link');
        link.rel = 'manifest';
        link.href = manifestURL;
        document.head.appendChild(link);
    </script>

    <style>
        /* ESTILOS DE IMPRESIÓN - CARTA VERTICAL ESTILO COMPACTO */
        @media print {
            @page { 
                size: letter portrait; /* CARTA NORMAL */
                margin: 1cm; 
            }
            body, html, #root { 
                background: white;
                -webkit-print-color-adjust: exact; 
                width: 100%;
                height: 100%;
                margin: 0;
                padding: 0;
                font-family: sans-serif;
            }
            .no-print, .dashboard-grid { display: none !important; }
            
            .print-visible-wrapper {
                display: block !important;
                width: 100% !important;
                height: auto !important;
                background: white !important;
                overflow: visible !important;
            }

            /* --- TIPOGRAFÍA GRANDE Y BORDES GRUESOS --- */
            h1 { font-size: 36pt !important; line-height: 0.9 !important; margin-bottom: 5px; } /* Cliente Gigante */
            
            table { 
                border-collapse: collapse; 
                width: 100%; 
                border: 3px solid black; /* Bordes muy gruesos */
                table-layout: fixed; 
                margin-bottom: 8px;
            }
            
            th { 
                background-color: #d1d5db !important; /* Gris más visible */
                color: black !important;
                font-weight: 900 !important;
                text-transform: uppercase;
                font-size: 11pt !important; 
                padding: 4px !important;
                border: 2px solid black !important;
                text-align: center;
            }
            
            td { 
                border: 2px solid black !important;
                padding: 4px !important;
                font-size: 12pt !important; /* Letra grande y legible */
                font-weight: 700 !important;
                color: black !important;
                vertical-align: middle;
            }

            /* Estilos específicos */
            .header-info { font-size: 14pt !important; font-weight: 800; }
            
            .machine-number-box { 
                background: black; 
                color: white; 
                font-size: 14pt; 
                font-weight: bold; 
                text-align: center; 
                padding: 4px;
            }
            .machine-number-val { 
                font-size: 60pt !important; /* Número enorme */
                font-weight: 900; 
                line-height: 0.8; 
                text-align: center; 
            }

            /* Tabla de Paquetes Inferior */
            .package-table-print th { font-size: 10pt !important; }
            .package-table-print td { font-size: 11pt !important; height: 24px; } 

            .manual-input { color: transparent !important; }
            .print-only { display: block !important; }
            
            ::-webkit-scrollbar { display: none; }
        }

        .print-only { display: none; }
        .dashboard-grid { display: grid; grid-template-rows: 60vh 1fr; height: 100vh; overflow: hidden; }
        .top-pane { overflow-y: auto; border-bottom: 4px solid #334155; }
        .bottom-pane { overflow-x: auto; background: #1e293b; color: white; display: flex; padding: 10px; gap: 10px; }
        .machine-card { min-width: 320px; background: #334155; border-radius: 8px; padding: 10px; display: flex; flex-direction: column; height: 100%; }
        .pkg-list { overflow-y: auto; flex-grow: 1; margin-top: 10px; padding-right: 4px; }
        .pkg-list::-webkit-scrollbar { width: 6px; }
        .pkg-list::-webkit-scrollbar-thumb { background: #64748b; border-radius: 4px; }
        .obs-input { background: transparent; border: none; color: #cbd5e1; width: 100%; font-size: 10px; border-bottom: 1px solid #475569; }
        .obs-input:focus { outline: none; border-bottom: 1px solid #94a3b8; color: white; }
    </style>
</head>
<body class="bg-slate-100 text-slate-800 font-sans">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;
        
        const firebaseConfig = {
            apiKey: "AIzaSyBqHgV4vDat1-VmZfKbiPg7nuiX-ROcexw",
            authDomain: "cirineo-cec21.firebaseapp.com",
            projectId: "cirineo-cec21",
            storageBucket: "cirineo-cec21.firebasestorage.app",
            messagingSenderId: "620210618284",
            appId: "1:620210618284:web:482bab9bf74650fff18409",
            measurementId: "G-B7YLM78RVW"
        };

        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        const Icon = ({ name, size = 18, className }) => <i data-lucide={name} width={size} height={size} className={className}></i>;
        const toUppercase = (handler) => (e) => { e.target.value = e.target.value.toUpperCase(); handler(e); };
        
        // =======================================================
        // UTILIDADES Y DATA
        // =======================================================

        // Data de colores SPUN (extraída y corregida del PDF)
        const SPUN_COLORS = [
            { num: "01", name: "Rosado Pálido", hex: "#E9D2E0" },
            { num: "02", name: "Rosado Brillante", hex: "#E870A2" },
            { num: "03", name: "Magenta Suave", hex: "#E33A7C" },
            { num: "04", name: "Rosa Intenso", hex: "#DE0A52" },
            { num: "05", name: "Rojo Rosado", hex: "#D00045" },
            { num: "06", name: "Rojo Oscuro", hex: "#A8002D" },
            { num: "07", name: "Vino/Borgona", hex: "#8B0D36" },
            { num: "09", name: "Fucsia Brillante", hex: "#E90065" },
            { num: "10", name: "Magenta Intenso", hex: "#C50047" },
            { num: "14", name: "Morado Oscuro", hex: "#7D0039" },
            { num: "15", name: "Púrpura/Ciruela", hex: "#5F002C" },
            { num: "16", name: "Berenjena Oscuro", hex: "#430029" },
            { num: "19", name: "Azul Marino Oscuro", hex: "#130D29" },
            { num: "20", name: "Negro/Azul muy oscuro", hex: "#0A090F" },
            { num: "21", name: "Púrpura", hex: "#4B0D5D" },
            { num: "22", name: "Violeta Oscuro", hex: "#580D74" },
            { num: "23", name: "Azul Morado", hex: "#6F0C8B" },
            { num: "24", name: "Morado Lavanda", hex: "#920EAA" },
            { num: "25", name: "Violeta Brillante", hex: "#AD00C1" },
            { num: "26", "name": "Púrpura Claro", hex: "#9E3FB0" },
            { num: "27", "name": "Azul Púrpura", hex: "#724089" },
            { num: "28", "name": "Gris Morado", hex: "#544865" },
            { num: "29", "name": "Azul Pizarra Oscuro", hex: "#3B394A" },
            { num: "30", "name": "Verde Azulado Oscuro", hex: "#343940" },
            { num: "31", "name": "Verde Lima Pálido", hex: "#D3EB9B" },
            { num: "33", "name": "Verde Amarillento", hex: "#A1E455" },
            { num: "34", "name": "Verde Brillante", hex: "#6CD126" },
            { num: "35", "name": "Verde Pasto Oscuro", hex: "#459325" },
            { num: "36", "name": "Verde Olivo", hex: "#979A3F" },
            { num: "37", "name": "Verde Seco/Musgo", hex: "#778A3E" },
            { num: "38", "name": "Verde Bosque Oscuro", hex: "#455C2C" },
            { num: "39", "name": "Caqui Oscuro", hex: "#38492C" },
            { num: "40", "name": "Ladrillo/Rojizo", hex: "#9C3833" },
            { num: "41", "name": "Rojo Caliente", hex: "#B93433" },
            { num: "42", "name": "Naranja", hex: "#CD3534" },
            { num: "43", "name": "Coral Claro", hex: "#DB575B" },
            { num: "44", "name": "Rosa Salmón", hex: "#EB8488" },
            { num: "45", "name": "Rosa Pálido", hex: "#F4ADAD" },
            { num: "46", "name": "Rosa muy Pálido", hex: "#F7E4E4" },
            { num: "47", "name": "Azul Bebé", hex: "#B2DDEB" },
            { num: "48", "name": "Celeste Brillante", hex: "#84C8DD" },
            { num: "50", "name": "Turquesa Intenso", hex: "#1A86AA" },
            { num: "51", "name": "Azul Cielo", hex: "#307797" },
            { num: "52", "name": "Azul Rey Oscuro", hex: "#1F4A70" },
            { num: "54", "name": "Verde Menta", hex: "#58B490" },
            { num: "55", "name": "Verde Suave", hex: "#71D5A6" },
            { num: "56", "name": "Verde Neón", hex: "#85E8B3" },
            { num: "57", "name": "Verde Lima Pálido", hex: "#A7EBC5" },
            { num: "58", "name": "Verde Agua Claro", hex: "#C9F7DB" },
            { num: "59", "name": "Verde Esmeralda", hex: "#36C87C" },
            { num: "60", "name": "Verde Pino", hex: "#26A863" },
            { num: "64", "name": "Verde Botella", hex: "#1D794F" },
            { num: "65", "name": "Verde Profundo", hex: "#1D553A" },
            { num: "69", "name": "Verde Oliva Oscuro", hex: "#2D3934" },
            { num: "70", "name": "Caqui", hex: "#7D8D68" },
            { num: "71", "name": "Beige Arena", hex: "#C8C9A3" },
            { num: "72", "name": "Blanco Roto/Hueso", hex: "#E3E1DF" },
            { num: "73", "name": "Beige Claro", hex: "#D4C9BF" },
            { num: "74", "name": "Gris Pálido", hex: "#B8A99C" },
            { num: "75", "name": "Gris Taupe", hex: "#9C8F84" },
            { num: "76", "name": "Marrón Suave", hex: "#7D6F64" },
            { num: "77", "name": "Marrón Tierra", hex: "#5E534A" },
            { num: "78", "name": "Café Oscuro", hex: "#403A35" },
            { num: "79", "name": "Marrón Grisáceo", hex: "#373838" },
            { num: "80", "name": "Gris Oscuro", hex: "#2C2F30" },
            { num: "81", "name": "Azul Acero Oscuro", hex: "#28303C" },
            { num: "82", "name": "Azul Marino", hex: "#1D2D44" },
            { num: "83", name: "Azul Noche", hex: "#132034" },
            { num: "85", name: "Azul Prusia", hex: "#0E1729" },
            { num: "88", name: "Gris muy Oscuro", hex: "#1D1C1B" },
            { num: "89", name: "Gris Grafito", hex: "#252423" },
            { num: "90", name: "Blanco Puro", hex: "#F4F5F4" },
            { num: "101", name: "Gris Claro", hex: "#919396" },
            { num: "169", name: "Azul Tinta Oscuro", hex: "#34465B" },
            { num: "178", name: "Gris Medio", hex: "#605F61" },
            { num: "182", name: "Negro", hex: "#1D1E1F" }
        ];

        // Función para determinar si el color HEX es claro u oscuro (para invertir color de texto)
        const isLightColor = (hex) => {
            const r = parseInt(hex.slice(1, 3), 16);
            const g = parseInt(hex.slice(3, 5), 16);
            const b = parseInt(hex.slice(5, 7), 16);
            const luma = (0.299 * r + 0.587 * g + 0.114 * b) / 255; 
            return luma > 0.6; // Umbral de luminosidad
        };

        // Función de utilidad para registrar cambios de inventario
        const logInventoryChange = async ({ order, action, materialUpdates, totalWeight, isEditing }) => {
            const logId = Date.now() + Math.random();
            const logEntry = {
                id: logId,
                orderId: order.id,
                partida: order.partida,
                codigo: order.codigo,
                maquina: order.maquina,
                totalWeight: totalWeight, // Peso total de la orden (en gramos)
                materialUpdates: materialUpdates, // Lista de materiales, acción y cantidad
                action: action, // 'CREACIÓN', 'EDICIÓN (Devolución)', etc.
                isEditing: isEditing,
                timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                date: new Date().toLocaleString('es-MX')
            };

            try {
                await db.collection('inventoryLogs').doc(String(logId)).set(logEntry);
            } catch(err) {
                console.error("Error al registrar el log de inventario:", err);
            }
        };

        // =======================================================
        // COMPONENTES PRINCIPALES
        // =======================================================

        const generateSmartID = (partida, pieces, maquina) => {
            const piecePrefixes = pieces.map(p => p.pieza.substring(0, 2).toUpperCase()).join('/');
            return `${partida}-${piecePrefixes}-M${maquina}`;
        };

        const generatePackages = (pieces, packageSize, partida) => {
            let packages = [];
            let pkgCounter = 1;
            pieces.forEach(p => {
                const total = Number(p.totalPedido) || 0;
                const size = Number(packageSize) || total;
                const n = Math.ceil(total / size);
                const piecePrefix = p.pieza.substring(0, 3).toUpperCase();

                for (let i = 1; i <= n; i++) {
                    const cantidad = (i === n) ? (total % size || size) : size;
                    const codigoUnico = `${piecePrefix}_${i}_DE_${n}`; 
                    packages.push({ 
                        id: Date.now() + Math.random() + pkgCounter, 
                        piezaNombre: p.pieza, 
                        cantidad: cantidad, 
                        paqueteNum: i, 
                        paquetesDePieza: n, 
                        codigoUnico: codigoUnico, 
                        finished: false 
                    });
                    pkgCounter++;
                }
            });
            return packages;
        };

        // --- COMPONENTE BOTÓN DE INSTALACIÓN ---
        const InstallButton = () => {
            const [deferredPrompt, setDeferredPrompt] = useState(null);
            useEffect(() => {
                const handler = (e) => {
                    e.preventDefault();
                    setDeferredPrompt(e);
                };
                window.addEventListener('beforeinstallprompt', handler);
                return () => window.removeEventListener('beforeinstallprompt', handler);
            }, []);
            const handleInstall = async () => {
                if (!deferredPrompt) return;
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                if (outcome === 'accepted') setDeferredPrompt(null);
            };
            if (!deferredPrompt) return null;
            return (
                <button onClick={handleInstall} className="bg-yellow-500 hover:bg-yellow-600 text-black px-3 py-2 rounded font-bold shadow flex items-center gap-2 text-xs animate-pulse">
                    <Icon name="download-cloud" size={16}/> INSTALAR APP
                </button>
            );
        };

        // --- DASHBOARD COMPONENTS ---
        const MachineCard = ({ maquina, orders }) => {
            const [is24Hours, setIs24Hours] = useState(true);
            const pendingPackages = useMemo(() => {
                let pkgs = [];
                orders.forEach(o => {
                    const incomplete = o.progreso?.filter(p => !p.finished) || [];
                    incomplete.forEach(p => {
                        const pieceData = o.subPiecesData?.find(sp => sp.pieza === p.piezaNombre) || o;
                        const timePerPiece = Number(pieceData.tiempo) || 0;
                        pkgs.push({ ...p, parentOrderId: o.id, orderCode: o.codigo, partida: o.partida, timeTotal: (p.cantidad * timePerPiece) });
                    });
                });
                return pkgs; 
            }, [orders]);

            const updateObs = async (pkgId, parentOrderId, newVal) => {
                const order = orders.find(o => o.id === parentOrderId);
                if(!order) return;
                const newProgreso = order.progreso.map(p => p.id === pkgId ? {...p, observaciones: newVal} : p);
                await db.collection('orders').doc(String(parentOrderId)).update({progreso: newProgreso});
            };

            const totalMinutesLeft = pendingPackages.reduce((sum, p) => sum + p.timeTotal, 0);
            const hoursPerDay = is24Hours ? 24 : 12;
            const daysLeft = totalMinutesLeft > 0 ? (totalMinutesLeft / 60 / hoursPerDay).toFixed(1) : 0;
            const hoursLeft = (totalMinutesLeft / 60).toFixed(1);

            return (
                <div className="machine-card shadow-lg border border-slate-600">
                    <div className="flex justify-between items-center border-b border-slate-500 pb-2 mb-2">
                        <div>
                            <div className="text-xs text-slate-400 font-bold uppercase">Máquina</div>
                            <div className="text-3xl font-black text-yellow-400">#{maquina}</div>
                        </div>
                        <div className="text-right">
                            <button onClick={()=>setIs24Hours(!is24Hours)} className="bg-slate-700 hover:bg-slate-600 px-2 py-1 rounded text-[10px] font-bold mb-1 border border-slate-500 block w-full">
                                {is24Hours ? '24 HORAS' : '12 HORAS'}
                            </button>
                            <div className="text-xs font-bold text-green-400">{daysLeft} días ({hoursLeft}h)</div>
                        </div>
                    </div>
                    <div className="pkg-list space-y-1">
                        {pendingPackages.length === 0 && <div className="text-center text-slate-500 text-xs py-4">Máquina Libre</div>}
                        {pendingPackages.map((p, i) => (
                            <div key={i} className="bg-slate-800 p-2 rounded flex gap-2 items-center text-xs border border-slate-700">
                                <div className="font-black text-white text-lg w-10 text-right shrink-0">{p.cantidad}</div>
                                <div className="w-24 shrink-0 overflow-hidden">
                                    <div className="font-bold text-slate-300 truncate text-[10px]" title={p.piezaNombre}>{p.piezaNombre}</div>
                                    <div className="text-[9px] text-yellow-500 font-black truncate">{p.partida}</div>
                                </div>
                                <div className="flex-grow pl-2 border-l border-slate-600">
                                    <input className="obs-input placeholder-slate-600" placeholder="Observaciones..." defaultValue={p.observaciones || ''} onBlur={(e) => updateObs(p.id, p.parentOrderId, e.target.value)} onKeyDown={(e) => { if(e.key === 'Enter') e.target.blur(); }}/>
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        const DashboardBottom = ({ activeOrders }) => {
            const machineGroups = useMemo(() => {
                const groups = {};
                activeOrders.forEach(o => { if(!groups[o.maquina]) groups[o.maquina] = []; groups[o.maquina].push(o); });
                return Object.keys(groups).sort((a,b) => parseInt(a)-parseInt(b)).map(k => ({ id: k, orders: groups[k] }));
            }, [activeOrders]);

            return (
                <div className="bottom-pane shadow-inner">
                    {machineGroups.map(g => <MachineCard key={g.id} maquina={g.id} orders={g.orders} />)}
                    {machineGroups.length === 0 && <div className="text-slate-500 w-full flex items-center justify-center font-bold">No hay producción activa</div>}
                </div>
            );
        };

        // --- COMPONENTE DE IMPORTACIÓN ---
        const ImportModal = ({ onClose, onImport }) => {
            const [text, setText] = useState('');
            const [error, setError] = useState(null);

            const handleProcess = () => {
                if (!text.trim()) return;
                try {
                    const delimiter = text.includes('\t') ? '\t' : ',';
                    const rows = text.trim().split('\n').map(r => r.split(delimiter));
                    if (rows.length < 2) throw new Error("Datos insuficientes.");
                    const headers = rows[0].map(h => h.trim().toUpperCase().replace(/"/g, ''));
                    const getVal = (row, colName) => { const idx = headers.indexOf(colName); return idx !== -1 && row[idx] ? row[idx].trim().replace(/"/g, '') : ''; };

                    if (headers.indexOf('PARTIDA') === -1) throw new Error("Falta columna 'PARTIDA'");
                    if (headers.indexOf('CODIGO') === -1) throw new Error("Falta columna 'CODIGO'");
                    if (headers.indexOf('PIEZAS') === -1) throw new Error("Falta columna 'PIEZAS'");

                    const predefinedPackages = [];
                    let totalPiezas = 0;
                    const firstRow = rows[1]; 
                    
                    rows.slice(1).forEach((r, i) => {
                        const piezas = parseFloat(getVal(r, 'PIEZAS'));
                        const codigoUnico = getVal(r, 'CODIGO'); 
                        let pkgNum = i + 1;
                        if (!isNaN(piezas)) {
                            totalPiezas += piezas;
                            predefinedPackages.push({ 
                                id: Date.now() + i, 
                                piezaNombre: getVal(r, 'DESCRIPCION') || 'ESTANDAR', 
                                cantidad: piezas, 
                                paqueteNum: pkgNum, 
                                paquetesDePieza: rows.length - 1, 
                                codigoUnico: codigoUnico, 
                                finished: false 
                            });
                        }
                    });

                    const threading = [];
                    const nylon = getVal(firstRow, 'NYLON');
                    const lycra = getVal(firstRow, 'LYCRA');
                    if (nylon) threading.push({ id: 1, guia: '1', material: `NYLON ${nylon}`, sis: '', porcentaje: '' });
                    if (lycra) threading.push({ id: 2, guia: '2', material: `LYCRA ${lycra}`, sis: '', porcentaje: '' });
                    
                    onImport({ 
                        codigo: getVal(firstRow, 'MODELO'), 
                        cliente: getVal(firstRow, 'CLIENTE'), 
                        maquina: getVal(firstRow, 'MAQUINA'), 
                        partida: getVal(firstRow, 'PARTIDA'), 
                        subPiecesData: [{ 
                            id: Date.now(), 
                            pieza: getVal(firstRow, 'DESCRIPCION') || 'ESTANDAR', 
                            programa: '', 
                            talla: getVal(firstRow, 'TALLA') || 'UNITALLA', 
                            totalPedido: totalPiezas, 
                            peso: '', 
                            tiempo: '' 
                        }], 
                        threading: threading, 
                        predefinedPackages: predefinedPackages,
                        createdAt: new Date().toLocaleString('es-MX')
                    });
                } catch (e) { setError(e.message); }
            };
            return (
                <div className="fixed inset-0 bg-black/80 z-[60] flex items-center justify-center p-4">
                    <div className="bg-white p-6 rounded-lg shadow-2xl w-full max-w-2xl relative">
                        <div className="flex justify-between items-center mb-4 border-b pb-2">
                            <h3 className="font-bold text-xl text-green-700 flex items-center gap-2"><Icon name="file-spreadsheet"/> Importar Excel</h3>
                            <button onClick={onClose} className="bg-red-500 hover:bg-red-600 text-white rounded-md p-2 shadow-lg flex items-center gap-1 font-bold text-xs transition-transform hover:scale-105">
                                <Icon name="x" size={18}/> CERRAR
                            </button>
                        </div>
                        <p className="text-xs text-slate-500 mb-2">Copia y pega las celdas desde Excel.</p>
                        <textarea value={text} onChange={(e) => { setText(e.target.value); setError(null); }} className="w-full h-64 p-3 border-2 border-slate-300 rounded font-mono text-xs focus:border-green-500 focus:outline-none" placeholder="Pegar datos..."></textarea>
                        {error && <div className="mt-2 text-red-600 text-xs font-bold bg-red-50 p-2 rounded border border-red-200">Error: {error}</div>}
                        <div className="flex justify-end gap-2 mt-4">
                            <button onClick={handleProcess} className="px-6 py-2 bg-green-600 text-white font-bold rounded shadow hover:bg-green-700 flex items-center gap-2"><Icon name="check-circle" size={18}/> Procesar</button>
                        </div>
                    </div>
                </div>
            );
        };

        // --- COMPONENTE PALETA DE COLORES ---
        const ColorPaletteModal = ({ onClose }) => {
            const [selectedColorName, setSelectedColorName] = useState('');

            return (
                <div className="fixed inset-0 bg-black/80 z-[60] flex items-center justify-center p-4">
                    <div className="bg-white p-6 rounded-lg shadow-2xl w-full max-w-5xl h-[90vh] flex flex-col">
                        <div className="flex justify-between items-center mb-4 border-b pb-2 shrink-0">
                            <h3 className="font-bold text-xl text-fuchsia-700 flex items-center gap-2"><Icon name="palette"/> PALETA DE COLORES SPUN</h3>
                            <button onClick={onClose} className="bg-red-500 hover:bg-red-600 text-white rounded-md p-2 shadow-lg flex items-center gap-1 font-bold text-xs transition-transform hover:scale-105">
                                <Icon name="x" size={18}/> CERRAR
                            </button>
                        </div>
                        
                        {selectedColorName && (
                            <div className="mb-4 p-3 border-2 border-fuchsia-400 bg-fuchsia-50 rounded text-center text-lg font-black text-fuchsia-800 shrink-0">
                                Color Seleccionado: {selectedColorName}
                            </div>
                        )}

                        <div className="flex-grow overflow-y-auto grid grid-cols-5 md:grid-cols-6 lg:grid-cols-8 xl:grid-cols-10 gap-4 p-2">
                            {SPUN_COLORS.map(color => (
                                <div 
                                    key={color.num} 
                                    style={{ backgroundColor: color.hex }}
                                    onClick={() => setSelectedColorName(color.name)}
                                    className="aspect-square border border-gray-300 rounded shadow-md flex items-center justify-center cursor-pointer hover:scale-[1.03] transition-transform relative group"
                                    title={color.name}
                                >
                                    <span 
                                        className="text-4xl font-black absolute"
                                        style={{ color: isLightColor(color.hex) ? 'black' : 'white', textShadow: isLightColor(color.hex) ? '0 0 3px white' : '0 0 3px black' }}
                                    >
                                        {color.num}
                                    </span>
                                    <div className="absolute bottom-0 left-0 right-0 bg-black/50 text-white text-[8px] font-bold text-center p-[2px] truncate opacity-0 transition-opacity group-hover:opacity-100">{color.hex}</div>
                                </div>
                            ))}
                        </div>
                        <div className="mt-4 text-xs text-slate-500 border-t pt-2 shrink-0">
                            Esta paleta es un respaldo basado en la tabla de colores SPUN para referencia visual rápida y no consulta el inventario.
                        </div>
                    </div>
                </div>
            );
        };


        // --- COMPONENTE IMAGEN ---
        const SmartImage = ({ repoUrls, codigo, className }) => {
            const [imgSrc, setImgSrc] = useState(null);
            const [attempt, setAttempt] = useState({ urlIndex: 0, extension: 'jpg' });
            useEffect(() => {
                if (!repoUrls || !repoUrls.length || !codigo) { setImgSrc(null); return; }
                setAttempt({ urlIndex: 0, extension: 'jpg' });
                const base = repoUrls[0].endsWith('/') ? repoUrls[0] : repoUrls[0] + '/';
                setImgSrc(`${base}${codigo}.jpg`);
            }, [repoUrls, codigo]);

            const handleError = () => {
                const { urlIndex, extension } = attempt;
                if (extension === 'jpg') {
                    const base = repoUrls[urlIndex].endsWith('/') ? repoUrls[urlIndex] : repoUrls[urlIndex] + '/';
                    setImgSrc(`${base}${codigo}.png`);
                    setAttempt({ ...attempt, extension: 'png' });
                } else if (urlIndex < repoUrls.length - 1) {
                    const nextIdx = urlIndex + 1;
                    const base = repoUrls[nextIdx].endsWith('/') ? repoUrls[nextIdx] : repoUrls[nextIdx] + '/';
                    setImgSrc(`${base}${codigo}.jpg`);
                    setAttempt({ urlIndex: nextIdx, extension: 'jpg' });
                } else {
                    setAttempt({ ...attempt, extension: 'fail' });
                }
            };
            if (attempt.extension === 'fail' || !imgSrc) return <div className={`bg-slate-100 flex flex-col items-center justify-center text-slate-300 ${className}`}><Icon name="image-off" size={32} className="mb-2"/><span className="text-[10px] text-center px-2">Sin img</span></div>;
            return <img src={imgSrc} onError={handleError} className={className} />;
        };

        // --- FORMULARIO DE ORDEN (CREAR Y EDITAR) ---
        const MultiOrderForm = ({ config, onCancel, initialOrder, clientHistory, inventory, isEditing }) => {
            const [header, setHeader] = useState(initialOrder ? { codigo: initialOrder.codigo, cliente: initialOrder.cliente, maquina: initialOrder.maquina, partida: initialOrder.partida || '', fechaInicio: initialOrder.fechaInicio || new Date().toISOString().split('T')[0] } : { codigo: '', cliente: '', maquina: '', partida: '', fechaInicio: new Date().toISOString().split('T')[0] });
            const [pieces, setPieces] = useState(initialOrder?.subPiecesData || [{ id: 1, pieza: 'BLUSA', programa: '', talla: 'UNITALLA', totalPedido: 100, peso: '150', tiempo: '' }]);
            const [threadingData, setThreadingData] = useState(initialOrder?.threading || []);
            const predefinedPackages = initialOrder?.predefinedPackages || (initialOrder && initialOrder.packageSize === 'VARIO' ? initialOrder.progreso : null);
            const [packageSize, setPackageSize] = useState(initialOrder?.packageSize && initialOrder.packageSize !== 'VARIO' ? initialOrder.packageSize : 50);
            
            const addPiece = () => setPieces([...pieces, { id: Date.now(), pieza: '', talla: 'UNITALLA', totalPedido: '', peso: '', tiempo: '' }]);
            const updatePiece = (id, f, v) => setPieces(pieces.map(p => p.id === id ? { ...p, [f]: v } : p));
            const removePiece = (id) => pieces.length > 1 && setPieces(pieces.filter(p => p.id !== id));
            
            // Calculo de peso total de la orden para validación
            const totalOrderWeight = pieces.reduce((sum, p) => sum + ((Number(p.totalPedido) || 0) * (Number(p.peso) || 0)), 0);

            const handleSubmit = async () => {
                if(!header.codigo || !header.cliente || !header.maquina || !header.partida) return alert("Faltan datos.");
                let finalPackages = initialOrder?.progreso?.filter(p => p.finished) || []; 
                if (predefinedPackages) {
                    if (isEditing) {
                        const newPredefined = initialOrder.progreso.map(p => {
                            const original = initialOrder.progreso.find(op => op.id === p.id);
                            return {...p, finished: original?.finished || false, tejedor: original?.tejedor || '', fecha: original?.fecha || '', defectos: original?.defectos || '', agujas: original?.agujas || ''};
                        });
                        finalPackages = newPredefined;
                    } else {
                        finalPackages = predefinedPackages;
                    }
                } else {
                    const newPackages = generatePackages(pieces, packageSize, header.partida);
                    if(isEditing) {
                         const finishedIds = new Set(finalPackages.map(p=>p.id));
                         finalPackages = [...finalPackages, ...newPackages.filter(p=>!finishedIds.has(p.id))];
                    } else {
                         finalPackages = newPackages;
                    }
                }

                // =======================================================
                // LÓGICA DE INVENTARIO CORREGIDA (EDICIÓN Y CREACIÓN)
                // Y LOGGING
                // =======================================================
                if (inventory && Array.isArray(inventory)) {
                    let updatedInventoryItems = [...inventory]; 
                    let inventoryChanged = false;
                    const logsToRegister = [];

                    // PASO 1: SI ES EDICIÓN, PRIMERO "DEVOLVEMOS" EL MATERIAL DE LA ORDEN ANTERIOR
                    if (isEditing && initialOrder) {
                        // Calcular el peso total que tenía la orden antes de editar
                        const oldTotalWeight = initialOrder.subPiecesData.reduce((sum, p) => sum + ((Number(p.totalPedido)||0) * (Number(p.peso)||0)), 0);
                        const oldTotalKg = oldTotalWeight / 1000;
                        const returnUpdates = [];

                        initialOrder.threading.forEach(row => {
                            const pct = parseFloat(row.porcentaje) || 0;
                            if (pct > 0 && row.material) {
                                // Calcular cuánto se descontó originalmente
                                const consumedKg = oldTotalKg * (pct / 100);
                                
                                // Buscar el item y SUMARLE (devolver) el stock
                                const itemIndex = updatedInventoryItems.findIndex(i => i.material === row.material);
                                if (itemIndex > -1) {
                                    const currentStock = parseFloat(updatedInventoryItems[itemIndex].stock) || 0;
                                    updatedInventoryItems[itemIndex] = {
                                        ...updatedInventoryItems[itemIndex],
                                        stock: (currentStock + consumedKg).toFixed(2)
                                    };
                                    inventoryChanged = true;
                                    returnUpdates.push({
                                        material: row.material,
                                        percent: pct,
                                        quantityKg: consumedKg.toFixed(2),
                                        type: 'DEVOLUCIÓN'
                                    });
                                }
                            }
                        });
                        if (returnUpdates.length > 0) {
                             logsToRegister.push({ order: initialOrder, action: 'EDICIÓN (Devolución)', materialUpdates: returnUpdates, totalWeight: oldTotalWeight, isEditing: true });
                        }
                    }

                    // PASO 2: DESCONTAR EL MATERIAL CON LOS DATOS NUEVOS (SEA EDICIÓN O NUEVA)
                    // Usamos totalOrderWeight (calculado al inicio de la función) que tiene los datos actuales del formulario
                    const newTotalKg = totalOrderWeight / 1000;
                    const discountUpdates = [];

                    threadingData.forEach(row => {
                        const pct = parseFloat(row.porcentaje) || 0;
                        if (pct > 0 && row.material) {
                            // Calcular nuevo consumo
                            const consumedKg = newTotalKg * (pct / 100);
                            
                            // Buscar y RESTAR
                            const itemIndex = updatedInventoryItems.findIndex(i => i.material === row.material);
                            if (itemIndex > -1) {
                                const currentStock = parseFloat(updatedInventoryItems[itemIndex].stock) || 0;
                                const newStock = Math.max(0, currentStock - consumedKg);
                                
                                updatedInventoryItems[itemIndex] = {
                                    ...updatedInventoryItems[itemIndex],
                                    stock: newStock.toFixed(2)
                                };
                                inventoryChanged = true;
                                discountUpdates.push({
                                    material: row.material,
                                    percent: pct,
                                    quantityKg: consumedKg.toFixed(2),
                                    type: 'DESCUENTO'
                                });
                            }
                        }
                    });
                    
                    if (discountUpdates.length > 0) {
                        // El orderPayload se crea después, por eso pasamos los datos necesarios.
                        // Lo registraremos al final.
                    }

                    // PASO 3: GUARDAR CAMBIOS EN FIREBASE y REGISTRAR LOGS
                    if (inventoryChanged) {
                        try {
                            // 1. Guardar inventario
                            await db.collection('inventory').doc('main').update({ items: updatedInventoryItems });
                            console.log("Inventario actualizado (Reajuste realizado).");
                            
                            // 2. Registrar logs (incluyendo el nuevo descuento)
                            logsToRegister.forEach(log => logInventoryChange(log));
                            if(discountUpdates.length > 0) {
                                await logInventoryChange({ 
                                    order: {...header, id: isEditing ? initialOrder.id : Date.now()}, // Usamos datos preliminares/finales
                                    action: isEditing ? 'EDICIÓN (Nuevo Descuento)' : 'CREACIÓN', 
                                    materialUpdates: discountUpdates, 
                                    totalWeight: totalOrderWeight, 
                                    isEditing: isEditing 
                                });
                            }

                        } catch (err) {
                            console.error("Error actualizando inventario:", err);
                            alert("Advertencia: Hubo un error sincronizando el inventario.");
                        }
                    }
                }
                // =======================================================
                
                const displayId = generateSmartID(header.partida, pieces, header.maquina);
                const creationDate = isEditing 
                    ? (initialOrder.createdAt || new Date().toLocaleString('es-MX')) 
                    : (initialOrder?.createdAt || new Date().toLocaleString('es-MX'));

                const orderPayload = { 
                    ...header, 
                    id: isEditing ? initialOrder.id : Date.now(), 
                    displayId, 
                    subPiecesData: pieces.map(p => ({...p, totalPedido: Number(p.totalPedido), peso: Number(p.peso)})), 
                    progreso: finalPackages, 
                    threading: threadingData, 
                    packageSize: predefinedPackages ? 'VARIO' : Number(packageSize), 
                    status: initialOrder?.status || 'EN PROCESO', 
                    totalPedido: pieces.reduce((a,b)=>a+Number(b.totalPedido),0),
                    createdAt: creationDate
                };
                try { 
                    await db.collection('orders').doc(String(orderPayload.id)).set(orderPayload);
                    alert(`Orden ${isEditing ? 'Actualizada' : 'Guardada'} y el Inventario ha sido ajustado.`);
                    onCancel(); 
                } catch(e) { 
                    console.error(e);
                    alert("Error al guardar"); 
                }
            };
            return (
                <div className="bg-white p-6 rounded shadow-xl max-w-4xl mx-auto my-4 overflow-y-auto h-[90vh]">
                    <div className="flex justify-between items-center mb-4 border-b pb-2">
                        <h2 className="font-bold text-xl flex items-center gap-2">
                             <Icon name={isEditing ? "file-edit" : "file-plus"}/> {isEditing ? 'Editar Orden' : 'Nueva Orden'}
                        </h2>
                        <button onClick={onCancel} className="text-red-500 font-bold">Cancelar</button>
                    </div>
                    <div className="grid grid-cols-12 gap-4 mb-4">
                        <div className="col-span-3 bg-yellow-50 p-2 rounded border border-yellow-200"><label className="text-xs font-bold text-yellow-900">PARTIDA</label><input value={header.partida} onChange={toUppercase(e=>setHeader({...header, partida:e.target.value}))} className="w-full text-lg font-black p-1 bg-white border rounded uppercase" placeholder="Ej: 24NOV451" disabled={isEditing}/></div>
                        <div className="col-span-3"><label className="text-xs font-bold">MODELO (FOTO)</label><input value={header.codigo} onChange={toUppercase(e=>setHeader({...header, codigo:e.target.value}))} className="w-full border p-2 rounded font-bold uppercase"/></div>
                        <div className="col-span-4"><label className="text-xs font-bold">CLIENTE</label><input list="clients" value={header.cliente} onChange={toUppercase(e=>setHeader({...header, cliente:e.target.value}))} className="w-full border p-2 rounded font-bold"/><datalist id="clients">{clientHistory.map(c=><option key={c} value={c}/>)}</datalist></div>
                        <div className="col-span-2"><label className="text-xs font-bold bg-slate-200 px-1">MÁQUINA</label><input value={header.maquina} onChange={toUppercase(e=>setHeader({...header, maquina:e.target.value}))} className="w-full border-2 border-slate-400 p-2 rounded font-black text-center"/></div>
                    </div>
                    <div className="mb-4 bg-slate-50 p-3 rounded">
                        <h3 className="font-bold text-sm mb-2 flex items-center gap-2"><Icon name="layers"/> Piezas / Detalles</h3>
                        {pieces.map((p, i) => (
                            <div key={p.id} className="grid grid-cols-12 gap-2 mb-2 items-end border-b pb-2">
                                <div className="col-span-3"><label className="text-[10px] font-bold">Nombre/Desc</label><input value={p.pieza} onChange={toUppercase(e=>updatePiece(p.id,'pieza',e.target.value))} className="w-full border p-1 rounded font-bold text-sm"/></div>
                                <div className="col-span-2"><label className="text-[10px] font-bold">Talla</label><input value={p.talla} onChange={toUppercase(e=>updatePiece(p.id,'talla',e.target.value))} className="w-full border p-1 rounded text-xs"/></div>
                                <div className="col-span-2"><label className="text-[10px] font-bold">Cant. Total</label><input type="number" value={p.totalPedido} onChange={e=>updatePiece(p.id,'totalPedido',e.target.value)} className="w-full border p-1 font-bold text-indigo-700" disabled={!!predefinedPackages}/></div>
                                <div className="col-span-2 bg-indigo-50 px-1 rounded"><label className="text-[10px] font-bold text-indigo-800">Peso (g)</label><input type="number" value={p.peso} onChange={e=>updatePiece(p.id,'peso',e.target.value)} className="w-full border p-1 text-center font-bold" placeholder="Gramos"/></div>
                                <div className="col-span-2"><label className="text-[10px] font-bold">Minutos/Pza</label><input type="number" value={p.tiempo} onChange={e=>updatePiece(p.id,'tiempo',e.target.value)} className="w-full border p-1 bg-yellow-50" placeholder="Calc. Tiempo"/></div>
                                <div className="col-span-1 text-center"><button onClick={()=>removePiece(p.id)} className="text-red-500" disabled={!!predefinedPackages}><Icon name="x"/></button></div>
                            </div>
                        ))}
                        {!predefinedPackages && <button onClick={addPiece} className="text-xs font-bold text-indigo-600">+ Agregar Pieza</button>}
                        {predefinedPackages && <div className="text-xs text-green-600 font-bold mt-2"><Icon name="check"/> Paquetes cargados desde Excel ({predefinedPackages.length} filas)</div>}
                    </div>

                    {/* Editor de Enhebrado con conexión a Inventario y Validación */}
                    <ThreadingEditor 
                        data={threadingData} 
                        onChange={setThreadingData} 
                        inventoryItems={inventory} 
                        totalWeight={totalOrderWeight} 
                    />

                    <div className="flex gap-4 mt-4">
                        {!predefinedPackages && <div className="w-32"><label className="text-xs font-bold">Pzs/Paquete</label><input type="number" value={packageSize} onChange={e=>setPackageSize(e.target.value)} className="border p-2 rounded w-full"/></div>}
                        <button onClick={handleSubmit} className="flex-1 bg-slate-900 text-white font-bold rounded shadow hover:bg-slate-800 py-3">{isEditing ? 'GUARDAR CAMBIOS' : 'CREAR ORDEN Y AJUSTAR INVENTARIO'}</button>
                    </div>
                </div>
            );
        };

        // --- COMPONENTE BITÁCORA DE INVENTARIO ---
        const OrderLogViewer = ({ order }) => {
            const [logs, setLogs] = useState([]);
            const [isLoading, setIsLoading] = useState(true);

            useEffect(() => {
                if (!order || !order.id) return;
                setIsLoading(true);
                // Escuchar solo los logs de esta orden, ordenados por fecha descendente
                const unsubscribe = db.collection('inventoryLogs')
                    .where('orderId', '==', order.id)
                    .orderBy('timestamp', 'desc')
                    .onSnapshot(s => {
                        setLogs(s.docs.map(d => ({ ...d.data(), id: d.id })));
                        setIsLoading(false);
                    }, (error) => {
                        console.error("Error fetching logs:", error);
                        setIsLoading(false);
                    });

                return () => unsubscribe();
            }, [order.id]);

            return (
                <div className="mt-4 p-4 bg-gray-50 border rounded shadow-inner">
                    <h3 className="font-bold text-lg mb-2 text-slate-700 flex items-center gap-2">
                        <Icon name="book-open"/> Bitácora de Inventario
                    </h3>
                    
                    {isLoading && <div className="text-center text-slate-500">Cargando bitácora...</div>}
                    
                    {!isLoading && logs.length === 0 && (
                        <div className="text-center text-slate-500 text-sm">No se encontraron registros de cambios de inventario para esta orden.</div>
                    )}

                    <div className="space-y-3 max-h-64 overflow-y-auto">
                        {logs.map(log => (
                            <div key={log.id} className={`p-3 rounded border ${log.action.includes('Devolución') ? 'bg-yellow-50 border-yellow-300' : 'bg-white border-green-300'}`}>
                                <div className="flex justify-between items-center text-xs border-b pb-1 mb-1">
                                    <span className="font-bold text-sm text-indigo-700">{log.action}</span>
                                    <span className="text-slate-500">{log.date}</span>
                                </div>
                                <div className="text-sm font-bold text-slate-600">
                                     Peso Total Orden ({log.action.includes('Devolución') ? 'Original' : 'Actual'}): <span className="text-black">{(log.totalWeight / 1000).toFixed(2)} Kg</span>
                                </div>
                                <ul className="text-xs list-disc pl-5 mt-1">
                                    {log.materialUpdates.map((update, i) => (
                                        <li key={i} className={update.type === 'DESCUENTO' ? 'text-green-700' : 'text-yellow-700'}>
                                            <span className="font-bold mr-1">{update.type === 'DESCUENTO' ? 'Descontado' : 'Devuelto'}:</span> 
                                            <span className="font-black">{update.quantityKg} Kg</span> ({update.percent}%) de <span className="font-bold">{update.material}</span>
                                        </li>
                                    ))}
                                </ul>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };


        // --- VISUALIZACIÓN E IMPRESIÓN ---
        const OrderView = ({ order, config, onBack, onEdit }) => { 
            const [entry, setEntry] = useState({ tejedor: '', fecha: new Date().toISOString().split('T')[0], defectos: '', agujas: '' });
            
            const markPackage = async (pkgId) => {
                if(!entry.tejedor) return alert("Por favor selecciona un TEJEDOR");
                const newProgreso = order.progreso.map(p => p.id === pkgId ? {...p, finished: true, tejedor: entry.tejedor, fecha: entry.fecha, defectos: entry.defectos, agujas: entry.agujas} : p);
                await db.collection('orders').doc(String(order.id)).update({progreso: newProgreso});
            };

            const unmarkPackage = async (pkgId) => {
                const newProgreso = order.progreso.map(p => p.id === pkgId ? {...p, finished: false, tejedor: '', fecha: '', defectos: '', agujas: ''} : p);
                await db.collection('orders').doc(String(order.id)).update({progreso: newProgreso});
            };

            const toggleArchive = async () => {
                const isArchived = order.status === 'ARCHIVADO';
                const msg = isArchived ? "¿Desarchivar esta orden?" : "¿Marcar orden como TERMINADA y archivarla?";
                if(window.confirm(msg)){
                    await db.collection('orders').doc(String(order.id)).update({
                        status: isArchived ? 'EN PROCESO' : 'ARCHIVADO'
                    });
                    onBack();
                }
            };
            
            // --- CÁLCULOS DE PRODUCCIÓN ---
            const minutosPorPrenda = order.subPiecesData.reduce((acc, curr) => acc + (Number(curr.tiempo) || 0), 0);
            const piezasPorHora = minutosPorPrenda > 0 ? (60 / minutosPorPrenda).toFixed(0) : 0;
            const piezasPorTurno = minutosPorPrenda > 0 ? ((60 / minutosPorPrenda) * 12).toFixed(0) : 0;


            return (
                <div className="bg-white min-h-screen relative">
                    <div className="no-print p-4 border-b flex justify-between bg-slate-50 sticky top-0 z-10 shadow-sm">
                        <button onClick={onBack} className="flex items-center gap-2 text-slate-600 font-bold"><Icon name="arrow-left"/> Volver</button>
                        <div className="flex gap-2">
                             <button onClick={toggleArchive} className={`px-3 py-1 rounded font-bold text-xs flex items-center gap-1 text-white ${order.status === 'ARCHIVADO' ? 'bg-orange-500 hover:bg-orange-600' : 'bg-green-600 hover:bg-green-700'}`}>
                                 <Icon name={order.status === 'ARCHIVADO' ? "refresh-ccw" : "archive"}/> 
                                 {order.status === 'ARCHIVADO' ? 'DESARCHIVAR' : 'ARCHIVAR ORDEN'}
                             </button>

                             <button onClick={() => onEdit(order)} className="bg-indigo-600 text-white px-3 py-1 rounded font-bold text-xs flex items-center gap-1 hover:bg-indigo-700">
                                 <Icon name="file-edit"/> EDITAR
                             </button>
                             <button onClick={() => window.print()} className="bg-slate-900 text-white px-3 py-1 rounded font-bold text-xs flex items-center gap-1 hover:bg-slate-700">
                                 <Icon name="printer"/> IMPRIMIR
                             </button>
                        </div>
                    </div>
                    
                    <div className="p-8 print:p-0">
                        {order.status === 'ARCHIVADO' && <div className="bg-orange-100 border-l-4 border-orange-500 text-orange-700 p-4 mb-4 font-bold text-center no-print">ESTA ORDEN ESTÁ ARCHIVADA / TERMINADA</div>}

                        <div className="print-visible-wrapper">
                             
                             {/* --- ENCABEZADO --- */}
                             <div className="flex justify-between items-start mb-4 border-b-4 border-black pb-2">
                                <div className="w-8/12">
                                    <h1 className="font-black uppercase tracking-tighter">{order.cliente}</h1>
                                    <div className="flex gap-6 items-baseline header-info">
                                        <div className="uppercase">PARTIDA: {order.partida}</div>
                                        <div className="text-slate-700 uppercase">MOD: {order.codigo}</div>
                                    </div>
                                </div>
                                <div className="w-3/12 text-right">
                                    <div className="machine-number-box">MÁQUINA</div>
                                    <div className="machine-number-val">{order.maquina}</div>
                                </div>
                             </div>
                            
                             {/* --- CUERPO (Grid 2 Columnas) --- */}
                             <div className="flex gap-4">
                                {/* Columna Izquierda: Datos */}
                                <div className="w-7/12 flex flex-col gap-2">
                                    
                                    {/* Tabla Piezas */}
                                    <table className="mb-0">
                                        <thead>
                                            <tr><th className="text-left">PIEZA</th><th className="w-20">TALLA</th><th className="w-20">TOTAL</th></tr>
                                        </thead>
                                        <tbody>
                                            {order.subPiecesData.map((p,i)=>(
                                                <tr key={i}>
                                                    <td className="truncate">{p.pieza}</td>
                                                    <td className="text-center">{p.talla}</td>
                                                    <td className="text-center font-black">{p.totalPedido}</td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                    
                                    {/* Tabla Enhebrado */}
                                    <table className="mb-0">
                                        <thead>
                                            <tr>
                                                <th colSpan="3" className="bg-black text-white py-1 text-sm">ENHEBRADO</th>
                                            </tr>
                                            <tr><th className="w-12">#</th><th className="text-left">Material</th><th className="w-16">%</th></tr>
                                        </thead>
                                        <tbody>
                                            {order.threading && order.threading.map((row, i) => (
                                                <tr key={i}>
                                                    <td className="text-center font-bold">{row.guia}</td>
                                                    <td className="truncate">{row.material}</td>
                                                    <td className="text-center font-bold">{row.porcentaje}</td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>

                                    {/* Cajas de Producción */}
                                    <div className="flex gap-2 mt-1">
                                        <div className="w-1/2 border-2 border-black flex flex-col justify-center items-center p-2">
                                            <span className="text-sm font-bold uppercase w-full text-center border-b-2 border-black mb-1">PZS/HR</span>
                                            <span className="text-3xl font-black">{piezasPorHora}</span>
                                        </div>
                                        <div className="w-1/2 border-2 border-black flex flex-col justify-center items-center p-2">
                                            <span className="text-sm font-bold uppercase w-full text-center border-b-2 border-black mb-1">PZS/12H</span>
                                            <span className="text-3xl font-black">{piezasPorTurno}</span>
                                        </div>
                                    </div>
                                </div>

                                {/* Columna Derecha: Imagen */}
                                <div className="w-5/12 border-2 border-black flex items-center justify-center relative bg-white overflow-hidden p-2 h-auto">
                                     <SmartImage repoUrls={config.repoUrls} codigo={order.codigo} className="max-h-64 w-full object-contain"/>
                                </div>
                            </div>
                        

                            {/* --- TABLA INFERIOR (LISTA DE PAQUETES) --- */}
                            <div className="print-section-bottom print-only mt-4">
                                <div className="border-b-4 border-black font-bold mb-1 text-sm flex justify-between items-end">
                                    <span>CONTROL DE TEJIDO</span>
                                    <span>{new Date().toLocaleDateString('es-MX')}</span>
                                </div>
                                <table className="package-table-print">
                                    <colgroup>
                                        <col style={{width: '6%'}} />
                                        <col style={{width: '24%'}} /> 
                                        <col style={{width: '10%'}} />
                                        <col style={{width: '12%'}} />
                                        <col style={{width: '12%'}} />
                                        <col style={{width: '8%'}} />
                                        <col style={{width: '8%'}} />
                                        <col style={{width: '20%'}} /> 
                                    </colgroup>
                                    <thead>
                                        <tr>
                                            <th>#</th>
                                            <th>CÓDIGO</th> 
                                            <th>Cant</th>
                                            <th>Tej</th>
                                            <th>Fec</th>
                                            <th>Def</th>
                                            <th>Agj</th>
                                            <th>OBS</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {order.progreso?.map((p, idx) => (
                                            <tr key={p.id}>
                                                <td className="text-center font-bold">{idx+1}</td>
                                                <td className="pl-1 font-mono truncate" title={p.codigoUnico || p.piezaNombre}>{p.codigoUnico || p.piezaNombre}</td>
                                                <td className="text-center font-bold">{p.cantidad}</td>
                                                <td className="manual-input">{p.finished ? p.tejedor : '_'}</td>
                                                <td className="manual-input">{p.finished ? p.fecha : '_'}</td>
                                                <td className="manual-input">{p.finished ? p.defectos : '_'}</td>
                                                <td className="manual-input">{p.finished ? p.agujas : '_'}</td>
                                                <td className="manual-input">{p.observaciones || '_'}</td> </tr>
                                        ))}
                                    </tbody>
                                </table>
                             </div>
                        </div>

                        {/* --- VISTA NORMAL DE ESCRITORIO --- */}
                        <div className="no-print mt-4">
                            <OrderLogViewer order={order}/> {/* NUEVA BITÁCORA */}
                            <div className="bg-slate-100 p-4 rounded border my-6">
                                <h3 className="font-bold text-lg mb-2 text-slate-700">Registro Digital Simplificado</h3>
                                <div className="flex gap-4 items-end mb-4 bg-white p-3 rounded shadow-sm border">
                                    <div>
                                        <label className="block text-xs font-bold text-slate-500 mb-1">TEJEDOR</label>
                                        <select 
                                            value={entry.tejedor} 
                                            onChange={e=>setEntry({...entry, tejedor: e.target.value})} 
                                            className="border-2 border-slate-300 p-2 rounded w-40 font-bold text-indigo-700 focus:border-indigo-500 outline-none"
                                        >
                                            <option value="">Seleccionar...</option>
                                            <option value="BALTA">BALTA</option>
                                            <option value="ANDRÉS">ANDRÉS</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label className="block text-xs font-bold text-slate-500 mb-1">FECHA</label>
                                        <input 
                                            type="date" 
                                            value={entry.fecha} 
                                            onChange={e=>setEntry({...entry, fecha: e.target.value})} 
                                            className="border-2 border-slate-300 p-2 rounded font-mono cursor-pointer hover:bg-slate-50"
                                        />
                                    </div>
                                </div>
                                <div className="max-h-80 overflow-y-auto bg-white border rounded shadow-inner">
                                    <table className="w-full text-xs text-left">
                                        <thead className="bg-slate-200 sticky top-0 shadow-sm z-0">
                                            <tr>
                                                <th className="p-3">CÓDIGO/PIEZA</th>
                                                <th className="p-3">Pzs</th>
                                                <th className="p-3">Estado</th>
                                                <th className="p-3">Acción</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {order.progreso.map(p=>(
                                                <tr key={p.id} className="border-b hover:bg-slate-50 transition-colors">
                                                    <td className="p-3 font-mono" title={p.codigoUnico || p.piezaNombre}>{p.codigoUnico || p.piezaNombre}</td>
                                                    <td className="p-3 font-bold">{p.cantidad}</td>
                                                    <td className="p-3">{p.finished ? <span className="text-green-600 font-bold bg-green-100 px-2 py-1 rounded-full text-[10px]">LISTO ({p.tejedor})</span> : <span className="text-slate-400 font-medium">PENDIENTE</span>}</td>
                                                    <td className="p-3">{!p.finished 
                                                        ? <button onClick={()=>markPackage(p.id)} disabled={!entry.tejedor} className="bg-indigo-100 text-indigo-700 px-3 py-1 rounded font-bold hover:bg-indigo-200 disabled:opacity-50 disabled:cursor-not-allowed transition">Registrar</button>
                                                        : <button onClick={()=>unmarkPackage(p.id)} className="bg-red-100 text-red-700 px-3 py-1 rounded font-bold hover:bg-red-200 transition">Deshacer</button>}
                                                    </td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const ThreadingEditor = ({ data, onChange, inventoryItems, totalWeight }) => {
            const addRow = () => onChange([...data, { id: Date.now(), guia: '', material: '', sis: '', porcentaje: '0' }]);
            const updateRow = (id, field, val) => onChange(data.map(r => r.id === id ? { ...r, [field]: val } : r));
            const removeRow = (id) => onChange(data.filter(r => r.id !== id));
            
            // Convertimos la lista de inventario en array si no lo es
            const invList = Array.isArray(inventoryItems) ? inventoryItems : [];

            return (
                <div className="border rounded bg-white overflow-hidden my-4 shadow-sm">
                    <div className="bg-slate-200 p-2 text-xs font-bold flex justify-between items-center">
                        <span>TABLA DE ENHEBRADO Y CONSUMO</span>
                        <div className="text-[10px] text-slate-500 font-normal">Peso Total Orden: <b>{(totalWeight/1000).toFixed(2)} Kg</b></div>
                        <button onClick={addRow} className="text-indigo-600 font-bold bg-white px-2 py-1 rounded border shadow-sm">+ Hilo</button>
                    </div>
                    <table className="w-full text-xs text-left">
                        <thead className="bg-slate-50 border-b">
                            <tr>
                                <th className="p-2 w-16">GUÍA</th>
                                <th className="p-2">MATERIAL (INVENTARIO)</th>
                                <th className="p-2 w-16 text-center">%</th>
                                <th className="p-2 w-24 text-center">Requerido</th>
                                <th className="p-2 w-24 text-center">Stock</th>
                                <th className="w-8"></th>
                            </tr>
                        </thead>
                        <tbody>
                            {data.map((row) => {
                                // Lógica de Validación de Inventario
                                const pct = parseFloat(row.porcentaje) || 0;
                                const requiredKg = (totalWeight * (pct / 100)) / 1000; // Gramos a KG
                                const stockItem = invList.find(i => i.material === row.material);
                                const stockAvailable = stockItem ? parseFloat(stockItem.stock) : 0;
                                const isInsufficient = row.material && (requiredKg > stockAvailable);

                                return (
                                    <tr key={row.id} className={`border-b ${isInsufficient ? 'bg-red-50' : ''}`}>
                                        <td className="p-1">
                                            <input className="w-full border rounded p-1 text-center" placeholder="#" value={row.guia} onChange={toUppercase(e=>updateRow(row.id,'guia',e.target.value))} />
                                        </td>
                                        <td className="p-1 relative">
                                            <input list="inv" className={`w-full border rounded p-1 font-bold ${isInsufficient ? 'text-red-600 border-red-300' : 'text-slate-700'}`} value={row.material} onChange={toUppercase(e=>updateRow(row.id,'material',e.target.value))} placeholder="Buscar hilo..."/>
                                            {isInsufficient && <div className="text-[9px] text-red-600 font-black absolute right-2 top-2">⚠ FALTAN {(requiredKg - stockAvailable).toFixed(2)} Kg</div>}
                                        </td>
                                        <td className="p-1">
                                            <input type="number" className="w-full border rounded p-1 text-center" value={row.porcentaje} onChange={e=>updateRow(row.id,'porcentaje',e.target.value)} />
                                        </td>
                                        <td className="p-1 text-center text-slate-500">
                                            {requiredKg > 0 ? requiredKg.toFixed(2) + ' Kg' : '-'}
                                        </td>
                                        <td className="p-1 text-center font-bold">
                                            {stockItem ? (
                                                <span className={stockAvailable < requiredKg ? "text-red-600" : "text-green-600"}>
                                                    {stockAvailable.toFixed(2)} Kg
                                                </span>
                                            ) : <span className="text-slate-300">-</span>}
                                        </td>
                                        <td className="p-1 text-center">
                                            <button onClick={()=>removeRow(row.id)} className="text-red-400 hover:text-red-600"><Icon name="x" size={14}/></button>
                                        </td>
                                    </tr>
                                );
                            })}
                        </tbody>
                    </table>
                    <datalist id="inv">
                        {invList.map((item, idx) => (
                            <option key={idx} value={item.material}>Stock: {item.stock}Kg | {item.color}</option>
                        ))}
                    </datalist>
                </div>
            );
        };

        const SettingsModal = ({ config, onClose }) => {
            const [localUrls, setLocalUrls] = useState(config.repoUrls || []);
            const [newUrl, setNewUrl] = useState('');
            const save = async () => { await db.collection('settings').doc('config').set({ ...config, repoUrls: localUrls }); onClose(); };
            return (<div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center"><div className="bg-white p-6 rounded w-96"><h3 className="font-bold mb-4">Configuración Imágenes</h3><div className="mb-2 max-h-40 overflow-y-auto">{localUrls.map((u,i)=><div key={i} className="text-xs truncate mb-1 border p-1 flex justify-between"><span>{u}</span><button onClick={()=>setLocalUrls(localUrls.filter((_,x)=>x!==i))} className="text-red-500 font-bold">X</button></div>)}</div><div className="flex gap-2 mb-4"><input value={newUrl} onChange={e=>setNewUrl(e.target.value)} className="border p-1 flex-1 text-xs" placeholder="URL GitHub Raw"/><button onClick={()=>{if(newUrl)setLocalUrls([...localUrls,newUrl]);setNewUrl('')}} className="bg-blue-100 text-blue-700 px-2 font-bold">+</button></div><button onClick={save} className="bg-slate-900 text-white w-full py-2 rounded font-bold">Guardar</button></div></div>);
        };

        const ImageGallery = ({ config, onClose, orders }) => {
            const [filter, setFilter] = useState('');
            const allCodes = useMemo(() => {
                const uniqueCodes = new Set(orders.map(o => o.codigo).filter(c => c));
                return Array.from(uniqueCodes).sort();
            }, [orders]);
            const filteredCodes = useMemo(() => {
                if (!filter) return allCodes;
                return allCodes.filter(c => c.toUpperCase().includes(filter.toUpperCase()));
            }, [allCodes, filter]);
            return (
                <div className="fixed inset-0 bg-black/80 z-[60] flex flex-col items-center justify-center p-4">
                    <div className="bg-white p-6 rounded-lg shadow-2xl w-full max-w-4xl h-full flex flex-col">
                        <div className="flex justify-between items-center mb-4 border-b pb-2 shrink-0">
                            <h3 className="font-bold text-xl text-indigo-700 flex items-center gap-2"><Icon name="images"/> Galería de Modelos</h3>
                            <button onClick={onClose} className="bg-red-500 hover:bg-red-600 text-white rounded-md p-2 shadow-lg flex items-center gap-1 font-bold text-xs transition-transform hover:scale-105">
                                <Icon name="x" size={18}/> CERRAR
                            </button>
                        </div>
                        <input type="text" placeholder="Filtrar por código de modelo..." value={filter} onChange={(e) => setFilter(e.target.value)} className="w-full p-2 mb-4 border rounded shadow-sm" />
                        <div className="flex-grow overflow-y-auto grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-4 p-2">
                            {config.repoUrls && config.repoUrls.map((repo, idx) => (
                                <div key={idx} className="col-span-full border-b pb-2 mb-2">
                                    <h4 className="font-bold text-sm text-slate-600 mb-2">Carpeta: <span className="font-mono text-xs">{repo}</span></h4>
                                    <div className="grid grid-cols-subgrid gap-4">
                                        {filteredCodes.map(codigo => (
                                            <div key={`${repo}-${codigo}`} className="aspect-square border rounded shadow overflow-hidden flex flex-col">
                                                <SmartImage repoUrls={[repo]} codigo={codigo} className="w-full h-2/3 object-contain bg-slate-100 p-1" />
                                                <div className="text-center text-xs font-bold p-1 bg-gray-100 h-1/3 flex items-center justify-center">{codigo}</div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            ))}
                            {!config.repoUrls && <div className="text-center text-slate-500 col-span-full">Configura las URLs de los repositorios en Ajustes.</div>}
                        </div>
                    </div>
                </div>
            );
        };

        const App = () => {
            const [view, setView] = useState('dashboard');
            const [orders, setOrders] = useState([]);
            const [config, setConfig] = useState({});
            const [inventory, setInventory] = useState([]); // Array vacio por defecto
            const [selectedOrder, setSelectedOrder] = useState(null);
            const [formProps, setFormProps] = useState({ initialOrder: null, isEditing: false }); 
            const [showSettings, setShowSettings] = useState(false);
            const [showImport, setShowImport] = useState(false);
            const [showGallery, setShowGallery] = useState(false);
            const [showPalette, setShowPalette] = useState(false); // Nuevo estado
            const [viewMode, setViewMode] = useState('active'); 

            useEffect(() => {
                const u1 = db.collection('orders').onSnapshot(s => setOrders(s.docs.map(d=>d.data())));
                const u2 = db.collection('settings').doc('config').onSnapshot(d => setConfig(d.data() || {}));
                
                // --- MODIFICADO: Leer items correctamente ---
                const u3 = db.collection('inventory').doc('main').onSnapshot(d => {
                     const data = d.data();
                     setInventory(data && data.items ? data.items : []);
                });

                setTimeout(()=>lucide.createIcons(), 500);
                return () => { u1(); u2(); u3(); };
            }, []);
            useEffect(()=>lucide.createIcons(), [view, orders, viewMode]);

            const displayedOrders = useMemo(() => {
                if(viewMode === 'active') {
                    return orders.filter(o => o.status !== 'ARCHIVADO');
                } else {
                    return orders.filter(o => o.status === 'ARCHIVADO');
                }
            }, [orders, viewMode]);

            const allClients = [...new Set(orders.map(o => o.cliente))].sort();
            
            const handleImportData = (data) => {
                setFormProps({ initialOrder: data, isEditing: false });
                setShowImport(false);
                setView('create');
            };

            const handleEditOrder = (order) => {
                setFormProps({ initialOrder: order, isEditing: true });
                setView('create');
                setSelectedOrder(null);
            };

            return (
                <div className="h-screen bg-slate-100 overflow-hidden">
                    {view === 'create' && <div className="absolute inset-0 z-50 bg-black/50 flex items-center justify-center"><MultiOrderForm config={config} onCancel={()=>setView('dashboard')} initialOrder={formProps.initialOrder} clientHistory={allClients} inventory={inventory} isEditing={formProps.isEditing}/></div>}
                    
                    {view === 'detail' && selectedOrder && <div className="absolute inset-0 z-40 bg-white overflow-y-auto print-visible-wrapper"><OrderView order={orders.find(o=>o.id===selectedOrder.id) || selectedOrder} config={config} onBack={()=>setView('dashboard')} onEdit={handleEditOrder}/></div>}
                    
                    {showSettings && <SettingsModal config={config} onClose={()=>setShowSettings(false)} />}
                    {showImport && <ImportModal onClose={()=>setShowImport(false)} onImport={handleImportData} />}
                    {showGallery && <ImageGallery config={config} onClose={()=>setShowGallery(false)} orders={orders} />}
                    {showPalette && <ColorPaletteModal onClose={()=>setShowPalette(false)} />} {/* NUEVO MODAL DE PALETA */}

                    <div className="dashboard-grid">
                        <div className="top-pane bg-slate-100 p-4">
                            <div className="flex justify-between items-center mb-4">
                                <h1 className="text-2xl font-black text-slate-800 flex gap-2 items-center">
                                    <Icon name="layout-dashboard"/> 
                                    <span>{viewMode === 'active' ? 'PLANTA' : 'HISTORIAL'}</span>
                                    <span className="text-xs bg-indigo-100 text-indigo-700 px-2 py-1 rounded ml-2">v2.7 LOGS INVENTARIO</span>
                                </h1>
                                <div className="flex gap-2 items-center">
                                    <InstallButton />
                                    
                                    <button onClick={()=>setShowPalette(true)} className="bg-fuchsia-600 hover:bg-fuchsia-700 text-white px-4 py-2 rounded font-bold shadow flex items-center gap-2 text-xs"><Icon name="palette"/> PALETA SPUN</button>

                                    <button onClick={()=>setViewMode(viewMode === 'active' ? 'history' : 'active')} className={`px-4 py-2 rounded font-bold shadow flex items-center gap-2 text-xs transition ${viewMode === 'active' ? 'bg-orange-500 hover:bg-orange-600 text-white' : 'bg-slate-700 text-white'}`}>
                                        <Icon name={viewMode === 'active' ? 'history' : 'activity'}/> 
                                        {viewMode === 'active' ? 'HISTORIAL' : 'VER PLANTA'}
                                    </button>

                                    <button onClick={()=>setShowGallery(true)} className="bg-sky-500 hover:bg-sky-600 text-white px-4 py-2 rounded font-bold shadow flex items-center gap-2 text-xs"><Icon name="image-search"/> GALERÍA</button>
                                    <button onClick={()=>setShowSettings(true)} className="bg-slate-300 hover:bg-slate-400 text-slate-800 p-2 rounded shadow"><Icon name="settings"/></button>
                                    
                                    {viewMode === 'active' && (
                                        <>
                                            <button onClick={()=>{setFormProps({initialOrder:null, isEditing: false}); setView('create')}} className="bg-indigo-600 text-white px-4 py-2 rounded font-bold shadow flex items-center gap-2"><Icon name="plus"/> MANUAL</button>
                                            <button onClick={()=>setShowImport(true)} className="bg-green-600 text-white px-4 py-2 rounded font-bold shadow flex items-center gap-2"><Icon name="file-spreadsheet"/> IMPORTAR</button>
                                        </>
                                    )}
                                </div>
                            </div>
                            
                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                                {displayedOrders.sort((a,b)=>b.id-a.id).map(o => {
                                    const pct = Math.round((o.progreso.filter(p=>p.finished).length / o.progreso.length)*100);
                                    return (
                                        <div key={o.id} onClick={()=>{setSelectedOrder(o); setView('detail')}} className={`p-3 rounded shadow border-l-4 cursor-pointer hover:shadow-lg transition ${o.status === 'ARCHIVADO' ? 'bg-slate-200 border-slate-500 opacity-75' : 'bg-white border-indigo-500'}`}>
                                            <div className="flex justify-between items-start">
                                                <div className="font-bold text-lg">{o.codigo}</div>
                                                <div className="bg-slate-200 text-slate-700 text-xs px-2 py-1 rounded font-bold">MQ-{o.maquina}</div>
                                            </div>
                                            <div className="text-xs font-bold text-indigo-800 mt-1">PARTIDA: {o.partida}</div>
                                            <div className="text-[10px] text-slate-400">Total: {o.totalPedido} pzs</div>
                                            <div className="mt-2 w-full bg-slate-100 h-2 rounded overflow-hidden">
                                                <div className={`${o.status === 'ARCHIVADO' ? 'bg-slate-500' : 'bg-green-500'} h-full`} style={{width:`${pct}%`}}></div>
                                            </div>
                                            {o.status === 'ARCHIVADO' && <div className="text-center text-[10px] font-bold text-slate-500 mt-1">ARCHIVADO</div>}
                                        </div>
                                    );
                                })}
                                {displayedOrders.length === 0 && <div className="col-span-4 text-center text-slate-400 py-10 font-bold">No hay órdenes en esta vista.</div>}
                            </div>
                        </div>
                        
                        {viewMode === 'active' && <DashboardBottom activeOrders={displayedOrders} />}
                        {viewMode === 'history' && <div className="bg-slate-800 text-white flex items-center justify-center p-10 font-bold text-xl opacity-50">MODO HISTORIAL - SOLO LECTURA</div>}
                        
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>