<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sweaters Liliana Base de datos 2026 v01</title>
    
    <link id="appIcon" rel="icon" href="https://raw.githubusercontent.com/jesusvn1993mplvt3-ai/CIRINEO/refs/heads/main/icon.ico">
    <link id="appAppleIcon" rel="apple-touch-icon" href="https://raw.githubusercontent.com/jesusvn1993mplvt3-ai/CIRINEO/refs/heads/main/icon.ico">
    <meta name="theme-color" content="#1e293b">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    
    <style>
        .dashboard-grid {
            display: grid;
            grid-template-columns: 1fr 300px; /* Contenido principal y barra lateral */
            height: 100vh;
        }
        .main-content {
            background: #1e293b; /* Slate-800 oscuro */
            color: white;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            overflow: hidden;
        }
        .sidebar {
            background: #f1f5f9; /* Slate-100 */
            color: #1e293b;
            padding: 24px;
            overflow-y: auto;
        }
        .status-text {
            font-size: 3rem; /* 48px */
            font-weight: 800;
            line-height: 1.2;
            text-align: center;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
            min-height: 150px;
        }
        .status-enter { opacity: 0; transform: translateY(20px); }
        .status-enter-active { opacity: 1; transform: translateY(0); transition: opacity 0.5s, transform 0.5s; }
        .status-exit { opacity: 1; transform: translateY(0); }
        .status-exit-active { opacity: 0; transform: translateY(-20px); transition: opacity 0.5s, transform 0.5s; }
        
        .radio-list { max-height: 150px; overflow-y: auto; }
        .radio-list::-webkit-scrollbar { width: 4px; }
        .radio-list::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 2px; }
    </style>
</head>
<body class="font-sans">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;
        const Icon = ({ name, size = 20, className }) => <i data-lucide={name} width={size} height={size} className={className}></i>;

        // --- Configuraci√≥n de Firebase (debe coincidir con tus otros archivos) ---
        const firebaseConfig = {
            apiKey: "AIzaSyBqHgV4vDat1-VmZfKbiPg7nuiX-ROcexw",
            authDomain: "cirineo-cec21.firebaseapp.com",
            projectId: "cirineo-cec21",
            storageBucket: "cirineo-cec21.firebasestorage.app",
            messagingSenderId: "620210618284",
            appId: "1:620210618284:web:482bab9bf74650fff18409",
            measurementId: "G-B7YLM78RVW"
        };

        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // --- UTILS ---
        
        const calculateTimeDiff = (timestamp) => {
            if (!timestamp) return { days: 0, hours: 0 };
            const now = Date.now();
            let date = timestamp;
            if (typeof date === 'string') {
                // Si es un string de fecha, intentar parsear
                date = new Date(date);
            } else if (timestamp.toDate) {
                // Si es un Timestamp de Firebase
                date = timestamp.toDate();
            }

            const diffMs = now - date.getTime();
            const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
            const diffHours = Math.floor((diffMs % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            return { days: diffDays, hours: diffHours };
        };

        const calculateOrderStatus = (order) => {
            const finishedPackages = order.progreso.filter(p => p.finished).length;
            const totalPackages = order.progreso.length;
            const piecesLeft = order.totalPedido - order.progreso.filter(p => p.finished).reduce((sum, p) => sum + p.cantidad, 0);
            const efficiency = totalPackages > 0 ? (finishedPackages / totalPackages) * 100 : 0;
            const lastUpdateTime = order.progreso.reduce((latest, p) => {
                if (!p.fecha) return latest;
                const date = new Date(p.fecha); // Suponiendo 'fecha' es una fecha ISO/string
                return date > latest ? date : latest;
            }, new Date(0));
            const timeSinceCreation = calculateTimeDiff(order.createdAt);
            const timeSinceLastUpdate = calculateTimeDiff(lastUpdateTime.getTime() > 0 ? lastUpdateTime : order.createdAt);

            // Calcular tiempo restante (simplificado)
            let totalMinutesLeft = 0;
            order.subPiecesData.forEach(p => {
                const totalPiecePackages = order.progreso.filter(pkg => pkg.piezaNombre === p.pieza).length;
                const finishedPiecePackages = order.progreso.filter(pkg => pkg.piezaNombre === p.pieza && pkg.finished).length;
                const packagesLeft = totalPiecePackages - finishedPiecePackages;
                const pieceTime = Number(p.tiempo) || 0;
                
                // Asumiendo que el paquete tiene 'cantidad' de piezas y esa cantidad * tiempo es el tiempo total
                const packagesToFinish = order.progreso.filter(pkg => pkg.piezaNombre === p.pieza && !pkg.finished);
                const totalPiecesInRemainingPackages = packagesToFinish.reduce((sum, pkg) => sum + pkg.cantidad, 0);

                totalMinutesLeft += (totalPiecesInRemainingPackages * pieceTime);
            });

            const totalHoursLeft = totalMinutesLeft / 60;
            const daysLeft = Math.floor(totalHoursLeft / 24);
            const hoursLeft = Math.round(totalHoursLeft % 24);
            
            let statusMessage = '';
            let isWarning = false;

            if (piecesLeft <= 0) {
                statusMessage = `‚úÖ Orden ${order.codigo} (M√°quina #${order.maquina}) TERMINADA.`;
            } else if (timeSinceLastUpdate.days >= 3 && finishedPackages === 0) {
                statusMessage = `üî¥ Maq #${order.maquina} Modelo ${order.codigo}. La orden se ingres√≥ hace ${timeSinceCreation.days} d√≠as y no ha habido **ninguna** actualizaci√≥n.`;
                isWarning = true;
            } else if (totalHoursLeft > 0) {
                 statusMessage = `‚è±Ô∏è M√°quina #${order.maquina}: Faltan ${daysLeft} d√≠as y ${hoursLeft} hrs para terminar el modelo ${order.codigo}. Eficiencia: ${efficiency.toFixed(0)}%.`;
                 if (efficiency < 50) isWarning = true;
            } else {
                 statusMessage = `M√°quina #${order.maquina}: Modelo ${order.codigo}. En proceso.`;
            }

            return { statusMessage, isWarning, totalPackages, finishedPackages, maquina: order.maquina, codigo: order.codigo };
        };

        // --- COMPONENTES ---

        const Clock = () => {
            const [time, setTime] = useState(new Date());
            useEffect(() => {
                const timer = setInterval(() => setTime(new Date()), 1000);
                return () => clearInterval(timer);
            }, []);
            return (
                <div className="text-center font-mono p-4 bg-slate-800 text-white rounded shadow-xl">
                    <div className="text-5xl font-black">{time.toLocaleTimeString('es-MX', { hour: '2-digit', minute: '2-digit', second: '2-digit' })}</div>
                    <div className="text-sm font-semibold text-sky-300 mt-1">{time.toLocaleDateString('es-MX', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}</div>
                </div>
            );
        };
        
        const NavButtons = () => {
            const buttons = [
                { name: "Inventario (Doc)", url: "https://jesusvn1993mplvt3-ai.github.io/Doc/", icon: "warehouse", color: "bg-orange-500 hover:bg-orange-600" },
                { name: "Santoni (Cirineo)", url: "https://jesusvn1993mplvt3-ai.github.io/CIRINEO/", icon: "socks", color: "bg-indigo-600 hover:bg-indigo-700" },
                { name: "Calcet√≠n (MAES26)", url: "https://sweaters-liliana.github.io/MAES26/", icon: "shoe", color: "bg-green-600 hover:bg-green-700" },
            ];
            return (
                <div className="mt-8 pt-4 border-t border-slate-300">
                    <h3 className="font-bold text-lg mb-4 flex items-center gap-2"><Icon name="link" size={18}/> Accesos R√°pidos</h3>
                    <div className="space-y-3">
                        {buttons.map((btn) => (
                            <a key={btn.name} href={btn.url} target="_blank" rel="noopener noreferrer" className={`w-full flex items-center justify-between p-4 rounded-lg font-bold text-white shadow-md transition-transform transform hover:scale-[1.02] ${btn.color}`}>
                                <span>{btn.name}</span>
                                <Icon name={btn.icon} size={24}/>
                            </a>
                        ))}
                    </div>
                </div>
            );
        };

        const RadioPlayer = () => {
            const [stations, setStations] = useState([]);
            const [searchUrl, setSearchUrl] = useState('');
            const [name, setName] = useState('');
            const [currentStation, setCurrentStation] = useState(null);
            const audioRef = useRef(new Audio());
            
            useEffect(() => {
                const unsubscribe = db.collection('radioStations').onSnapshot(s => {
                    setStations(s.docs.map(d => ({ id: d.id, ...d.data() })));
                });
                audioRef.current.volume = 0.5;
                return () => { unsubscribe(); audioRef.current.pause(); };
            }, []);

            const playStation = (station) => {
                if (currentStation && currentStation.id === station.id) {
                    audioRef.current.pause();
                    setCurrentStation(null);
                } else {
                    audioRef.current.src = station.url;
                    audioRef.current.play().catch(e => console.error("Error al reproducir:", e));
                    setCurrentStation(station);
                }
            };

            const addStation = async () => {
                if (name && searchUrl) {
                    await db.collection('radioStations').add({ name, url: searchUrl, addedAt: firebase.firestore.FieldValue.serverTimestamp() });
                    setName('');
                    setSearchUrl('');
                }
            };
            
            const deleteStation = async (id) => {
                if (window.confirm("¬øSeguro que quieres eliminar esta estaci√≥n?")) {
                    await db.collection('radioStations').doc(id).delete();
                    if (currentStation && currentStation.id === id) {
                         audioRef.current.pause();
                         setCurrentStation(null);
                    }
                }
            };

            return (
                <div className="mt-6 p-4 bg-white rounded shadow-lg border border-slate-200">
                    <h3 className="font-bold text-lg mb-3 flex items-center gap-2 text-indigo-700"><Icon name="radio" size={18}/> Radio FM/Internet</h3>
                    
                    <div className="flex items-center gap-2 mb-3">
                        <input type="range" min="0" max="1" step="0.01" defaultValue="0.5" onChange={(e) => audioRef.current.volume = e.target.value} className="flex-1" />
                        <Icon name="volume-2" size={18} className="text-slate-600"/>
                    </div>

                    <div className="radio-list space-y-2 mb-3 border-b pb-3">
                        {stations.map(s => (
                            <div key={s.id} className="flex items-center justify-between text-xs p-2 rounded transition-colors" style={{backgroundColor: currentStation?.id === s.id ? '#e0f2f7' : '#f1f5f9'}}>
                                <div className="font-semibold truncate">{s.name}</div>
                                <div className="flex gap-1 shrink-0">
                                    <button onClick={() => playStation(s)} className={`p-1 rounded transition-colors ${currentStation?.id === s.id ? 'bg-red-500 text-white hover:bg-red-600' : 'bg-green-500 text-white hover:bg-green-600'}`}>
                                        <Icon name={currentStation?.id === s.id ? "pause" : "play"} size={14}/>
                                    </button>
                                    <button onClick={() => deleteStation(s.id)} className="p-1 bg-red-100 text-red-600 rounded hover:bg-red-200">
                                         <Icon name="trash-2" size={14}/>
                                    </button>
                                </div>
                            </div>
                        ))}
                        {stations.length === 0 && <p className="text-xs text-slate-500 text-center">No hay estaciones guardadas.</p>}
                    </div>
                    
                    <p className="text-xs font-bold text-slate-500 mb-1">AGREGAR ESTACI√ìN:</p>
                    <input type="text" placeholder="Nombre (Ej: La Zeta)" value={name} onChange={(e) => setName(e.target.value)} className="w-full p-1 mb-1 text-sm border rounded" />
                    <input type="url" placeholder="URL de Stream (.mp3, .m3u, .pls)" value={searchUrl} onChange={(e) => setSearchUrl(e.target.value)} className="w-full p-1 mb-2 text-sm border rounded" />
                    <button onClick={addStation} disabled={!name || !searchUrl} className="w-full bg-slate-700 text-white font-bold p-2 rounded text-sm hover:bg-slate-800 disabled:opacity-50">
                        <Icon name="save" size={16} className="inline mr-1"/> Guardar Estaci√≥n
                    </button>
                </div>
            );
        };

        const WeatherWidget = ({ city = "LE√ìN, GTO.", temp = "25¬∞C", icon = "sun", desc = "Soleado" }) => (
            <div className="mt-6 p-4 bg-sky-100 rounded shadow-lg border border-sky-300">
                <h3 className="font-bold text-lg mb-3 flex items-center gap-2 text-sky-700"><Icon name="cloud-lightning" size={18}/> Clima de la Zona</h3>
                <div className="flex justify-between items-center">
                    <div>
                        <div className="text-4xl font-black text-sky-800">{temp}</div>
                        <div className="text-sm font-semibold text-slate-600">{desc}</div>
                    </div>
                    <Icon name={icon} size={48} className="text-yellow-500"/>
                </div>
                <div className="text-xs mt-2 text-slate-500 font-bold border-t pt-2">Ubicaci√≥n: {city} (Simulado)</div>
            </div>
        );

        // --- COMPONENTE PRINCIPAL DE LA P√ÅGINA ---

        const App = () => {
            const [orders, setOrders] = useState([]);
            const [inventory, setInventory] = useState([]);
            const [dynamicText, setDynamicText] = useState("Cargando datos...");
            const [textKey, setTextKey] = useState(0); // Para forzar la transici√≥n
            const [isWarning, setIsWarning] = useState(false);

            useEffect(() => {
                const u1 = db.collection('orders').where('status', '!=', 'ARCHIVADO').onSnapshot(s => setOrders(s.docs.map(d=>d.data()).filter(d=>d.progreso && d.progreso.length > 0)));
                const u2 = db.collection('inventory').doc('main').onSnapshot(d => setInventory(d.data()?.items || []));
                return () => { u1(); u2(); };
            }, []);

            const allStatuses = useMemo(() => {
                const statuses = [];
                // 1. Agregar estados de Inventario
                if (inventory.length > 0) {
                    for (let i = 0; i < Math.min(3, inventory.length); i++) { // Mostrar 3 items de inventario al azar
                        const item = inventory[Math.floor(Math.random() * inventory.length)];
                        statuses.push({
                            text: `üìä INVENTARIO: ${item.material} ${item.calibre || ''} Stock ${Number(item.stock).toFixed(1)} kg.`,
                            isWarning: Number(item.stock) < Number(item.minStock),
                            type: 'inventory'
                        });
                    }
                } else {
                     statuses.push({ text: "Inventario cargando o vac√≠o. Presione 'INVENTARIO' para revisar.", isWarning: true, type: 'inventory' });
                }

                // 2. Agregar estados de √ìrdenes
                orders.forEach(order => {
                    const status = calculateOrderStatus(order);
                    statuses.push({
                        text: status.statusMessage,
                        isWarning: status.isWarning,
                        type: 'order',
                        orderId: order.id
                    });
                });
                
                // Si no hay √≥rdenes, agregar un mensaje gen√©rico
                if (orders.length === 0) {
                     statuses.push({ text: "No hay √≥rdenes activas registradas en Cirineo. Todo listo.", isWarning: false, type: 'idle' });
                }

                return statuses.length > 0 ? statuses : [{ text: "Bienvenido a Sweaters Liliana. Sistema en l√≠nea.", isWarning: false, type: 'welcome' }];
            }, [orders, inventory]);
            
            // L√≥gica del timer para alternar el texto
            useEffect(() => {
                if (allStatuses.length === 0) return;

                let currentIndex = 0;
                const updateStatus = () => {
                    const status = allStatuses[currentIndex % allStatuses.length];
                    setDynamicText(status.text);
                    setIsWarning(status.isWarning);
                    setTextKey(prev => prev + 1);

                    currentIndex++;
                };

                updateStatus(); // Ejecutar inmediatamente al cargar
                const interval = setInterval(updateStatus, 6000); // Cambiar cada 6 segundos

                return () => clearInterval(interval);
            }, [allStatuses]);


            useEffect(() => {
                lucide.createIcons();
            }, [textKey]);


            return (
                <div className="dashboard-grid">
                    {/* --- Contenido Principal (Visualizaci√≥n de Datos) --- */}
                    <div className="main-content">
                        <div className="text-center p-10 max-w-4xl mx-auto">
                            <h1 className="text-6xl font-black text-sky-400 mb-8 tracking-tight">
                                Sweaters Liliana
                            </h1>
                            <h2 className="text-2xl font-bold text-slate-300 mb-12">
                                Base de Datos 2026 <span className="text-yellow-400">v01</span>
                            </h2>
                            
                            <div key={textKey} className={`status-text ${isWarning ? 'text-red-400' : 'text-green-400'}`}>
                                {dynamicText}
                            </div>
                            
                            <div className="mt-12">
                                <Clock />
                            </div>
                            
                        </div>
                    </div>
                    
                    {/* --- Barra Lateral (Widgets y Navegaci√≥n) --- */}
                    <div className="sidebar">
                        <WeatherWidget />
                        <RadioPlayer />
                        <NavButtons />
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>