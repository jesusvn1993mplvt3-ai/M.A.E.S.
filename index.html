<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sweaters Liliana Control Profesional</title>

    <link id="appIcon" rel="icon" href="https://ejemplo.com/tu-imagen-industrial-cerebro.ico">
    <link id="appAppleIcon" rel="apple-touch-icon" href="https://ejemplo.com/tu-imagen-industrial-cerebro.ico">
    <meta name="theme-color" content="#1e293b">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <style>
        /* Tipografía */
        body {
            font-family: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif;
            min-height: 100vh;
            overflow-x: hidden;
        }
        .main-container {
            min-height: 100vh;
            padding: 50px 20px;
            /* Fuerza el contenido a estar encima del fondo */
            position: relative; 
            z-index: 10;
        }

        /* Animación de Parpadeo (Flicker) para el efecto neón en los botones */
        @keyframes flicker {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
            52% { opacity: 0.95; }
        }
        
        /* Animación de Parpadeo para las papeletas (súper sutil) */
        @keyframes flicker-low {
            0%, 100% { opacity: 0.05; }
            50% { opacity: 0.03; }
        }

        /* Estilos para el scrollbar (se mantiene para limpieza) */
        .radio-list::-webkit-scrollbar { width: 6px; background-color: transparent; }
        .radio-list::-webkit-scrollbar-thumb { background: #38bdf8; border-radius: 3px; }
        .link-list::-webkit-scrollbar { width: 6px; background-color: transparent; }
        .link-list::-webkit-scrollbar-thumb { background: #38bdf8; border-radius: 3px; }
    </style>
</head>
<body class="font-sans bg-slate-900">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;
        
        const Icon = ({ name, size = 20, className }) => {
            useEffect(() => { lucide.createIcons(); }, [name]);
            return <i data-lucide={name} width={size} height={size} className={className}></i>;
        };

        // --- Configuración de Firebase (Se mantiene) ---
        const firebaseConfig = {
            apiKey: "AIzaSyBqHgV4vDat1-VmZfKbiPg7nuiX-ROcexw",
            authDomain: "cirineo-cec21.firebaseapp.com",
            projectId: "cirineo-cec21",
            storageBucket: "cirineo-cec21.firebasestorage.app",
            messagingSenderId: "620210618284",
            appId: "1:620210618284:web:482bab9bf74650fff18409",
            measurementId: "G-B7YLM78RVW"
        };

        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // --- DEFINICIÓN DE TEMA ÚNICO ---
        const theme = {
            id: 'professionalDark',
            name: "Industrial Profesional",
            primaryBg: "bg-slate-900", 
            overlayBg: "bg-white/5 backdrop-blur-md", 
            accentColor: "text-sky-400", 
            warningColor: "text-red-400",
            textColor: "text-white",
            navBtnColor: "bg-sky-600 hover:bg-sky-700",
        };

        // --- UTILS ---
        const getLinkColorClass = (theme, index) => {
            const darkColors = ['text-red-400', 'text-indigo-400', 'text-cyan-400', 'text-green-400', 'text-yellow-400', 'text-pink-400'];
            const colorIndex = index % darkColors.length;
            return darkColors[colorIndex];
        };

        // --- COMPONENTE: FONDO DINÁMICO DE PAPELETAS ---
        const PaperBackground = ({ orders }) => {
            const paperElements = useMemo(() => {
                // Colores discretos de papel (casi blanco/gris muy claro)
                const colors = ['#f5f5f5', '#e5e5e5', '#f0f0f0', '#d4d4d4']; 

                // 1. Filtrar solo órdenes ACTIVAS (estas son las "papeletas tiradas")
                const activeOrders = orders.filter(order => order.status !== 'ARCHIVADO');
                
                // 2. Si no hay órdenes, mostramos un número fijo de placeholders
                if (activeOrders.length === 0) {
                    return Array(20).fill(null).map((_, i) => ({
                        id: `placeholder-${i}`,
                        text: "ESPERANDO ORDEN",
                        color: colors[i % colors.length],
                        rotation: Math.random() * 360,
                        x: Math.random() * 100,
                        y: Math.random() * 100,
                    }));
                }

                // 3. Generar un elemento visual por cada orden activa (se duplican para mayor densidad visual)
                let elements = [];
                activeOrders.forEach((order, index) => {
                    const progress = order.progreso ? (order.progreso.filter(p => p.finished).length / order.progreso.length) * 100 : 0;
                    const orderText = `ORDEN ${order.codigo || 'N/A'} #\nMAQUINA: ${order.maquina || 'N/A'}\nPROGRESO: ${progress.toFixed(0)}%`;
                    
                    // Genera múltiples "papeletas" por orden
                    for(let i=0; i<3; i++) {
                         elements.push({
                            id: `${order.codigo}-${i}`, 
                            text: orderText,
                            color: colors[(index + i) % colors.length],
                            rotation: Math.random() * 360, 
                            x: Math.random() * 100, 
                            y: Math.random() * 100, 
                            opacity: 0.05 + Math.random() * 0.02, 
                            sizeFactor: 0.8 + Math.random() * 0.4 
                        });
                    }
                });
                
                return elements;
            }, [orders]); 

            return (
                <div className="fixed inset-0 overflow-hidden -z-10">
                    {paperElements.map((paper) => (
                        <div
                            key={paper.id}
                            className="absolute pointer-events-none transition-opacity duration-1000"
                            style={{
                                top: `${paper.y}%`,
                                left: `${paper.x}%`,
                                width: `${40 * paper.sizeFactor}vw`, 
                                height: `${20 * paper.sizeFactor}vh`,
                                backgroundColor: paper.color,
                                opacity: paper.opacity, 
                                transform: `translate(-50%, -50%) rotate(${paper.rotation}deg)`,
                                boxShadow: '0 0 10px rgba(0,0,0,0.1)',
                                whiteSpace: 'pre-wrap',
                                fontSize: '1.5vw',
                                color: '#1f2937', 
                                padding: '10px',
                                fontFamily: 'monospace',
                                border: '1px solid rgba(0,0,0,0.05)',
                                animation: `flicker-low ${Math.random() * (10 - 5) + 5}s infinite alternate`,
                            }}
                        >
                            {paper.text}
                        </div>
                    ))}
                </div>
            );
        };
        
        // --- COMPONENTE: Botón de Enlace Neón ---
        const NeonLinkButton = ({ link, index }) => {
            const randomDuration = useMemo(() => Math.random() * (4 - 1.5) + 1.5, []);
            const colorClass = getLinkColorClass(theme, index);
            const accentBg = colorClass.replace('text-', 'bg-').replace('-400', '-900') + '/80'; 
            const neonShadow = colorClass.replace('text-', '').replace('-400', '-500');
            
            return (
                <a 
                    href={link.url}
                    target="_blank" 
                    rel="noopener noreferrer" 
                    className={`
                        flex flex-col items-center justify-center p-4 rounded-xl transition-all 
                        font-extrabold text-xl lg:text-2xl font-mono text-center
                        border-2 border-current hover:opacity-90 active:scale-[0.98]
                        ${accentBg} ${colorClass} 
                    `}
                    style={{ 
                        animation: `flicker ${randomDuration}s infinite alternate`,
                        borderColor: neonShadow,
                        boxShadow: `0 0 15px ${neonShadow}`
                    }}
                >
                    <Icon name={link.iconName || 'link'} size={32} className="mb-1"/> 
                    <span className="text-lg lg:text-xl">{link.name}</span>
                </a>
            );
        };

        // --- COMPONENTE: Gestor de Enlaces ---
        const LinkManager = ({ links, setLinks }) => {
            const [isAdding, setIsAdding] = useState(false);
            const [newLink, setNewLink] = useState({ name: '', url: '', iconName: 'link' });
            const [editLink, setEditLink] = useState(null); 
            
            const accentTextClass = theme.accentColor;
            const inputBg = 'bg-slate-800 border-slate-700 text-white placeholder-slate-500'; 
            const saveBtnColor = theme.navBtnColor;
            const linkBg = 'bg-slate-800/70 hover:bg-slate-700/80';


            const saveLink = async (linkData) => {
                if (linkData.name && linkData.url) {
                    try {
                        if (linkData.id) {
                            await db.collection('dashboardLinks').doc(linkData.id).update({
                                name: linkData.name,
                                url: linkData.url,
                                iconName: linkData.iconName
                            });
                            setEditLink(null);
                        } else {
                            await db.collection('dashboardLinks').add({
                                name: linkData.name,
                                url: linkData.url,
                                iconName: linkData.iconName,
                                createdAt: firebase.firestore.FieldValue.serverTimestamp()
                            });
                            setIsAdding(false);
                            setNewLink({ name: '', url: '', iconName: 'link' });
                        }
                    } catch (e) {
                        console.error("Error al guardar el enlace:", e);
                        alert("Error al guardar el enlace. Consulta la consola.");
                    }
                }
            };
            
            const deleteLink = async (id) => {
                if (window.confirm("¿Seguro que quieres eliminar este acceso directo?")) {
                    try {
                        await db.collection('dashboardLinks').doc(id).delete();
                    } catch (e) {
                        console.error("Error al eliminar el enlace:", e);
                        alert("Error al eliminar el enlace. Consulta la consola.");
                    }
                }
            };
            
            const renderLinkForm = (data, setData, isEdit = false) => (
                <div className={`p-3 rounded-lg border border-current/30 bg-slate-800`}>
                    <p className="text-sm font-bold mb-1 text-white">{isEdit ? 'EDITAR' : 'AGREGAR'} ENLACE:</p>
                    <input type="text" placeholder="Nombre (Ej: Generador)" value={data.name} onChange={(e) => setData({ ...data, name: e.target.value })} className={`w-full p-2 mb-1 text-sm border rounded ${inputBg}`} />
                    <input type="url" placeholder="URL (Ej: https://...)" value={data.url} onChange={(e) => setData({ ...data, url: e.target.value })} className={`w-full p-2 mb-1 text-sm border rounded ${inputBg}`} />
                    <div className="flex gap-2">
                        <input type="text" placeholder="Icono (Ej: boxes o link)" value={data.iconName} onChange={(e) => setData({ ...data, iconName: e.target.value })} className={`flex-1 p-2 mb-2 text-sm border rounded ${inputBg}`} />
                        <button onClick={() => saveLink(data)} disabled={!data.name || !data.url} className={`text-white font-bold p-2 rounded-lg text-sm transition-all shadow-md ${saveBtnColor} disabled:opacity-50 disabled:cursor-not-allowed`}>
                            <Icon name="save" size={18} className="inline"/>
                        </button>
                    </div>
                </div>
            );


            return (
                <div className={`mt-8 p-4 rounded-xl shadow-2xl transition-colors bg-slate-900/50 ${theme.textColor}`} style={{ '--accent-color': theme.accentColor.replace('text-', '#') }}>
                    <h3 className={`font-bold text-xl mb-3 flex items-center justify-between gap-2 ${accentTextClass}`}>
                        <span><Icon name="link" size={20}/> Administrar Accesos</span>
                        <button onClick={() => { setIsAdding(!isAdding); setEditLink(null); }} className={`text-sm font-semibold p-1 rounded transition-colors ${theme.navBtnColor.replace('bg-', 'bg-').replace('-600', '-500').replace('-700', '-600')} text-white`}>
                           <Icon name={isAdding ? "x" : "plus"} size={18}/>
                        </button>
                    </h3>
                    
                    {isAdding && renderLinkForm(newLink, setNewLink)}
                    {editLink && renderLinkForm(editLink, setEditLink, true)}

                    <div className="link-list space-y-2 mt-3 pt-3 border-t border-current/30">
                        {links.map((link, index) => (
                            <div key={link.id} className={`flex items-center justify-between text-sm p-2 rounded transition-colors ${linkBg}`}>
                                <a href={link.url} target="_blank" rel="noopener noreferrer" className={`flex items-center gap-2 truncate ${accentTextClass} hover:underline`}>
                                    <Icon name={link.iconName || 'link'} size={16}/>
                                    <span className="font-bold">{link.name}</span>
                                </a>
                                <div className="flex gap-1 shrink-0">
                                     <button onClick={() => { setEditLink(link); setIsAdding(false); }} className={`p-1 rounded transition-colors bg-blue-500/10 text-blue-400 hover:bg-blue-500/20`}>
                                        <Icon name="pencil" size={16}/>
                                    </button>
                                    <button onClick={() => deleteLink(link.id)} className="p-1 bg-red-500/10 text-red-400 rounded hover:bg-red-500/20">
                                         <Icon name="trash-2" size={16}/>
                                    </button>
                                </div>
                            </div>
                        ))}
                         {links.length === 0 && <p className="text-sm text-current/70 text-center">No hay accesos directos guardados.</p>}
                    </div>
                </div>
            );
        };

        // --- COMPONENTE PRINCIPAL DE LA PÁGINA ---

        const App = () => {
            const [orders, setOrders] = useState([]);
            const [links, setLinks] = useState([]); 

            // 1. Enlaces por defecto 
            const defaultLinks = useMemo(() => ([
                { id: 'default-santoni', name: "SANTONI", url: "https://jesusvn1993mplvt3-ai.github.io/CIRINEO/", iconName: "tshirt" },
                { id: 'default-inventory', name: "INVENTARIO", url: "https://jesusvn1993mplvt3-ai.github.io/HILATURAS/", iconName: "boxes" },
                { id: 'default-sock', name: "CALCETÍN", url: "https://sweaters-liliana.github.io/MAES26/", iconName: "socks" },
                // ESTE ES EL ENLACE AL GENERADOR DE PAPELETAS (archivo 'generador de papeletas.html' que subiste)
                { id: 'default-generator', name: "PAPELETAS", url: "https://jesusvn1993mplvt3-ai.github.io/GENERADOR-DE-PAPELETAS/", iconName: "printer" }
            ]), []);

            // Carga inicial de datos
            useEffect(() => {
                // Solo órdenes activas (Status != ARCHIVADO) para el fondo de papeletas
                const u1 = db.collection('orders').where('status', '!=', 'ARCHIVADO').onSnapshot(s => setOrders(s.docs.map(d=>d.data()).filter(d=>d.progreso && d.progreso.length > 0)));
                
                // Suscripción a los enlaces
                const u2 = db.collection('dashboardLinks').onSnapshot(s => {
                    const dbLinks = s.docs.map(d => ({ id: d.id, ...d.data() }));
                    
                    const filteredDefaults = defaultLinks.filter(dLink => 
                        !dbLinks.some(dbLink => dbLink.url === dLink.url || dbLink.name === dLink.name)
                    );
                    
                    setLinks([...dbLinks, ...filteredDefaults]);
                });
                
                return () => { u1(); u2(); };
            }, [defaultLinks]);
            
            // Determina el número de columnas de la cuadrícula de enlaces
            const linkGridColumns = links.length <= 3 ? `grid-cols-1 sm:grid-cols-${links.length}` : 'grid-cols-2 md:grid-cols-3';

            return (
                <div className="relative">
                    
                    {/* --- FONDO DINÁMICO (Las "papeletas tiradas") --- */}
                    <PaperBackground orders={orders} />
                    
                    {/* --- CONTENIDO PRINCIPAL (Centrado y Limpio) --- */}
                    <div className={`main-container flex justify-center items-start ${theme.primaryBg}`}>
                        <div className={`w-full max-w-5xl mx-auto p-4 lg:p-10 rounded-2xl shadow-2xl ${theme.overlayBg} ${theme.textColor}`}>
                            
                            {/* --- HEADER --- */}
                            <header className="text-center mb-10">
                                <h1 className={`text-5xl lg:text-7xl font-extrabold ${theme.accentColor} mb-2 tracking-tighter`}>
                                    S. LILIANA
                                </h1>
                                <h2 className={`text-lg lg:text-xl font-bold ${theme.textColor} opacity-80`}>
                                    CENTRO DE CONTROL DE PRODUCCIÓN
                                </h2>
                            </header>
                            
                            {/* --- SECCIÓN DE ACCESOS DIRECTOS --- */}
                            <section className="mb-10">
                                <h3 className={`font-bold text-2xl mb-6 text-center ${theme.accentColor}`}>
                                    ACCESOS RÁPIDOS (APLICACIONES)
                                </h3>
                                <div className={`grid ${linkGridColumns} gap-6`}>
                                    {links.map((link, index) => (
                                        <NeonLinkButton 
                                            key={link.id}
                                            link={link}
                                            index={index}
                                        />
                                    ))}
                                </div>
                            </section>
                            
                            <hr className="border-t border-slate-700/50 my-10"/>

                            {/* --- GESTOR DE ENLACES --- */}
                            <section className="w-full max-w-lg mx-auto">
                                <LinkManager links={links} setLinks={setLinks} /> 
                            </section>

                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
