<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cirineo Ultimate - Generador & Papeletas (Fase Z)</title>
    
    <link rel="icon" href="https://raw.githubusercontent.com/jesusvn1993mplvt3-ai/CIRINEO/refs/heads/main/icon.ico">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.0/dist/JsBarcode.all.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <style>
        body { background-color: #f8fafc; font-family: system-ui, -apple-system, sans-serif; -webkit-print-color-adjust: exact; }
        .print-only { display: none; }
        
        @media print {
            .no-print { display: none !important; }
            .print-only { display: block !important; }
            body { background: white; }
            @page { margin: 0.5cm; size: auto; }
            .page-break { page-break-before: always; }
        }

        /* Animaciones */
        .fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // --- CONFIGURACIÓN FIREBASE (La misma de siempre) ---
        const firebaseConfig = {
            apiKey: "AIzaSyD...", // Reemplaza con tu API Key si es necesario, o usa la configuración existente del navegador
            authDomain: "cirineo-check.firebaseapp.com",
            projectId: "cirineo-check",
            storageBucket: "cirineo-check.appspot.com",
            messagingSenderId: "123456789",
            appId: "1:123456789:web:abcdef"
        };

        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const db = firebase.firestore();

        // --- COMPONENTES AUXILIARES ---
        const Icon = ({ name, size = 20, className = "" }) => {
            const LucideIcon = window.lucide.icons[name.replace(/-([a-z])/g, (g) => g[1].toUpperCase()).replace(/^([a-z])/, (g) => g.toUpperCase())];
            return LucideIcon ? <LucideIcon size={size} className={className} /> : null;
        };

        // Componente Inteligente de Imagen
        const SmartImage = ({ modelName, className }) => {
            const [src, setSrc] = React.useState(null);
            const [attempt, setAttempt] = React.useState(0);
            
            // Prioridad de extensiones: PNG -> WEBP -> JPG -> JPEG
            const extensions = ['png', 'webp', 'jpg', 'jpeg'];
            const baseUrl = "https://raw.githubusercontent.com/jesusvn1993mplvt3-ai/Planificador/refs/heads/main/Modelos/";

            React.useEffect(() => {
                setAttempt(0);
                setSrc(`${baseUrl}${modelName}.${extensions[0]}`);
            }, [modelName]);

            const handleError = () => {
                const nextAttempt = attempt + 1;
                if (nextAttempt < extensions.length) {
                    setAttempt(nextAttempt);
                    setSrc(`${baseUrl}${modelName}.${extensions[nextAttempt]}`);
                } else {
                    // Fallback final si no encuentra nada
                    setSrc("https://via.placeholder.com/300x300?text=SIN+IMAGEN"); 
                }
            };

            return <img src={src} onError={handleError} className={className} alt={modelName} />;
        };

        // --- APLICACIÓN PRINCIPAL ---
        const App = () => {
            // Estados del Formulario
            const [model, setModel] = React.useState("");
            const [client, setClient] = React.useState("");
            const [totalQty, setTotalQty] = React.useState("");
            
            // Estado de las Partes (Componentes del modelo)
            const [parts, setParts] = React.useState([
                { id: 1, name: "General", ratio: 1, machine: "1" } // Parte por defecto
            ]);

            // Estados de UI y Datos
            const [materials, setMaterials] = React.useState([]);
            const [selectedMaterial, setSelectedMaterial] = React.useState("");
            const [loading, setLoading] = React.useState(false);
            const [printData, setPrintData] = React.useState(null); // Datos listos para imprimir
            const [showSuccess, setShowSuccess] = React.useState(false);

            // Cargar Materiales (Inventario Real)
            React.useEffect(() => {
                const unsubscribe = db.collection('materiales').onSnapshot(snapshot => {
                    const docs = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                    setMaterials(docs);
                });
                return () => unsubscribe();
            }, []);

            // Añadir una parte al modelo
            const addPart = () => {
                setParts([...parts, { id: Date.now(), name: "", ratio: "", machine: "" }]);
            };

            // Eliminar una parte
            const removePart = (id) => {
                if(parts.length > 1) {
                    setParts(parts.filter(p => p.id !== id));
                }
            };

            // Actualizar dato de una parte
            const updatePart = (id, field, value) => {
                setParts(parts.map(p => p.id === id ? { ...p, [field]: value } : p));
            };

            // Guardar Orden
            const handleSave = async () => {
                if (!model || !totalQty || !client || !selectedMaterial) {
                    alert("Por favor completa todos los campos principales y selecciona material.");
                    return;
                }

                // Validar partes
                const invalidPart = parts.find(p => !p.name || !p.ratio || !p.machine);
                if (invalidPart) {
                    alert("Por favor completa la información de todas las partes (Nombre, Ratio, Máquina).");
                    return;
                }

                setLoading(true);

                try {
                    const qty = parseInt(totalQty);
                    
                    // 1. Generar estructura de partes con cálculo de bultos
                    const processedParts = parts.map(p => {
                        const ratio = parseFloat(p.ratio); // Piezas por lienzo
                        const bundlesNeeded = Math.ceil(qty / ratio);
                        return {
                            ...p,
                            ratio: ratio,
                            bundlesNeeded: bundlesNeeded,
                            // Generamos IDs únicos para cada bulto aquí mismo
                            bundles: Array.from({ length: bundlesNeeded }).map((_, i) => ({
                                bundleIndex: i + 1,
                                uid: Math.random().toString(36).substr(2, 9), // ID único corto
                                qtyInBundle: (i === bundlesNeeded - 1) ? (qty % ratio === 0 ? ratio : qty % ratio) : ratio
                            }))
                        };
                    });

                    const orderData = {
                        model: model.toUpperCase(),
                        client: client.toUpperCase(),
                        totalQty: qty,
                        materialId: selectedMaterial,
                        parts: processedParts,
                        status: "PENDIENTE",
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        generatedBy: "Z-SYSTEM"
                    };

                    // 2. Guardar en ZORDERS (Nueva colección)
                    const docRef = await db.collection('zorders').add(orderData);

                    // 3. Descontar Inventario (Colección MATERIALES original)
                    // Calculamos gasto aproximado (esto se puede refinar luego con pesos reales)
                    // Por ahora descontamos una cantidad simbólica o basada en peso si existe
                    const matRef = db.collection('materiales').doc(selectedMaterial);
                    await db.runTransaction(async (transaction) => {
                        const matDoc = await transaction.get(matRef);
                        if (!matDoc.exists) throw "Material no existe";
                        
                        const currentKilos = matDoc.data().kilos || 0;
                        // Supongamos 0.2kg por prenda promedio si no hay dato exacto, solo para que reste algo
                        const deduction = qty * 0.2; 
                        
                        transaction.update(matRef, { kilos: currentKilos - deduction });
                        
                        // Registrar movimiento en ZINV_MOVEMENTS
                        const moveRef = db.collection('zinv_movements').doc();
                        transaction.set(moveRef, {
                            materialId: selectedMaterial,
                            type: "SALIDA",
                            amount: deduction,
                            reason: `Orden ${model} - ${docRef.id}`,
                            date: firebase.firestore.FieldValue.serverTimestamp()
                        });
                    });

                    // 4. Preparar Impresión
                    setPrintData({ id: docRef.id, ...orderData });
                    setShowSuccess(true);
                    
                    // Reset parcial
                    setModel("");
                    setTotalQty("");
                    // No reseteamos partes para facilitar captura repetitiva del mismo estilo

                } catch (error) {
                    console.error("Error:", error);
                    alert("Error al guardar: " + error.message);
                } finally {
                    setLoading(false);
                }
            };

            const triggerPrint = () => {
                window.print();
            };

            return (
                <div className="min-h-screen">
                    
                    {/* --- INTERFAZ DE CAPTURA (NO IMPRIMIBLE) --- */}
                    <div className="no-print max-w-5xl mx-auto p-4 lg:p-8">
                        <header className="mb-8 flex justify-between items-center">
                            <div>
                                <h1 className="text-3xl font-black text-slate-800 tracking-tight">CIRINEO <span className="text-blue-600">Z</span></h1>
                                <p className="text-slate-500 font-medium">Generador de Órdenes Multi-Parte</p>
                            </div>
                            <div className="text-right">
                                <div className="text-xs font-bold bg-purple-100 text-purple-700 px-3 py-1 rounded-full inline-block mb-1">FASE BETA (Z)</div>
                                <p className="text-xs text-slate-400">Base de datos: zorders</p>
                            </div>
                        </header>

                        <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
                            
                            {/* Columna Izquierda: Datos Principales */}
                            <div className="space-y-6">
                                <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                                    <h2 className="font-bold text-slate-700 mb-4 flex items-center gap-2"><Icon name="package" /> Datos del Pedido</h2>
                                    
                                    <div className="space-y-4">
                                        <div>
                                            <label className="block text-xs font-bold text-slate-500 mb-1">MODELO</label>
                                            <input 
                                                type="text" 
                                                value={model}
                                                onChange={e => setModel(e.target.value.toUpperCase())}
                                                className="w-full text-2xl font-black text-slate-800 border-b-2 border-slate-200 focus:border-blue-600 outline-none py-2 uppercase bg-transparent"
                                                placeholder="Ej. M028"
                                            />
                                        </div>

                                        <div className="grid grid-cols-2 gap-4">
                                            <div>
                                                <label className="block text-xs font-bold text-slate-500 mb-1">CANTIDAD TOTAL</label>
                                                <input 
                                                    type="number" 
                                                    value={totalQty}
                                                    onChange={e => setTotalQty(e.target.value)}
                                                    className="w-full font-bold text-slate-800 border rounded-lg p-2"
                                                    placeholder="0"
                                                />
                                            </div>
                                            <div>
                                                <label className="block text-xs font-bold text-slate-500 mb-1">CLIENTE</label>
                                                <input 
                                                    type="text" 
                                                    value={client}
                                                    onChange={e => setClient(e.target.value)}
                                                    className="w-full font-bold text-slate-800 border rounded-lg p-2"
                                                    placeholder="Nombre"
                                                />
                                            </div>
                                        </div>

                                        <div>
                                            <label className="block text-xs font-bold text-slate-500 mb-1">MATERIAL (Inventario Actual)</label>
                                            <select 
                                                value={selectedMaterial}
                                                onChange={e => setSelectedMaterial(e.target.value)}
                                                className="w-full p-2 border rounded-lg bg-slate-50 text-sm font-medium"
                                            >
                                                <option value="">Seleccionar tela...</option>
                                                {materials.map(m => (
                                                    <option key={m.id} value={m.id}>
                                                        {m.nombre} - {m.color} ({m.kilos?.toFixed(1)}kg disp)
                                                    </option>
                                                ))}
                                            </select>
                                        </div>
                                    </div>
                                </div>

                                {/* Previsualización de Imagen */}
                                {model && (
                                    <div className="bg-white p-4 rounded-2xl shadow-sm border border-slate-200 flex flex-col items-center">
                                        <p className="text-xs font-bold text-slate-400 mb-2">VISTA PREVIA MODELO</p>
                                        <div className="w-32 h-32 rounded-lg overflow-hidden bg-slate-100 border border-slate-200">
                                            <SmartImage modelName={model} className="w-full h-full object-cover" />
                                        </div>
                                    </div>
                                )}
                            </div>

                            {/* Columna Central: Configuración de Partes */}
                            <div className="lg:col-span-2 space-y-6">
                                <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-200 h-full flex flex-col">
                                    <div className="flex justify-between items-center mb-6">
                                        <h2 className="font-bold text-slate-700 flex items-center gap-2">
                                            <Icon name="layers" /> Configuración de Partes
                                        </h2>
                                        <button onClick={addPart} className="text-xs bg-blue-50 text-blue-600 font-bold px-3 py-1 rounded-full hover:bg-blue-100 transition">
                                            + AGREGAR PARTE
                                        </button>
                                    </div>

                                    <div className="flex-1 space-y-3 overflow-y-auto pr-2 max-h-[500px]">
                                        {parts.map((part, index) => (
                                            <div key={part.id} className="bg-slate-50 p-4 rounded-xl border border-slate-200 flex flex-wrap gap-4 items-end animate-fadeIn">
                                                <div className="flex-1 min-w-[150px]">
                                                    <label className="text-[10px] font-bold text-slate-400 uppercase">Nombre Parte</label>
                                                    <input 
                                                        type="text" 
                                                        value={part.name}
                                                        onChange={e => updatePart(part.id, 'name', e.target.value)}
                                                        className="w-full font-bold text-slate-700 bg-white border border-slate-200 rounded p-2 text-sm"
                                                        placeholder="Ej. Manga, Cuerpo"
                                                    />
                                                </div>
                                                
                                                <div className="w-32">
                                                    <label className="text-[10px] font-bold text-slate-400 uppercase">Piezas x Lienzo</label>
                                                    <input 
                                                        type="number" 
                                                        value={part.ratio}
                                                        onChange={e => updatePart(part.id, 'ratio', e.target.value)}
                                                        className="w-full font-bold text-blue-600 bg-white border border-slate-200 rounded p-2 text-sm text-center"
                                                        placeholder="1"
                                                    />
                                                </div>

                                                <div className="w-24">
                                                    <label className="text-[10px] font-bold text-slate-400 uppercase">Máquina</label>
                                                    <input 
                                                        type="text" 
                                                        value={part.machine}
                                                        onChange={e => updatePart(part.id, 'machine', e.target.value)}
                                                        className="w-full font-black text-slate-800 bg-white border border-slate-200 rounded p-2 text-sm text-center"
                                                        placeholder="#"
                                                    />
                                                </div>

                                                <div className="w-24 bg-slate-200 rounded p-2 text-center opacity-70">
                                                    <label className="text-[10px] font-bold text-slate-500 uppercase">Lienzos</label>
                                                    <div className="font-bold text-slate-700 text-sm">
                                                        {totalQty && part.ratio ? Math.ceil(parseInt(totalQty) / parseFloat(part.ratio)) : '-'}
                                                    </div>
                                                </div>

                                                {parts.length > 1 && (
                                                    <button onClick={() => removePart(part.id)} className="p-2 text-red-400 hover:text-red-600 hover:bg-red-50 rounded transition">
                                                        <Icon name="trash-2" size={18} />
                                                    </button>
                                                )}
                                            </div>
                                        ))}
                                    </div>

                                    <div className="mt-6 pt-6 border-t border-slate-100">
                                        {showSuccess ? (
                                            <div className="flex gap-4">
                                                <button onClick={triggerPrint} className="flex-1 bg-green-600 text-white font-bold py-3 rounded-xl shadow-lg shadow-green-200 flex justify-center items-center gap-2 hover:bg-green-700 transition">
                                                    <Icon name="printer" /> IMPRIMIR PAPELETAS
                                                </button>
                                                <button onClick={() => setShowSuccess(false)} className="px-6 bg-slate-100 text-slate-500 font-bold rounded-xl hover:bg-slate-200">
                                                    NUEVO
                                                </button>
                                            </div>
                                        ) : (
                                            <button 
                                                onClick={handleSave} 
                                                disabled={loading}
                                                className={`w-full bg-blue-600 text-white font-bold py-4 rounded-xl shadow-lg shadow-blue-200 flex justify-center items-center gap-2 text-lg hover:bg-blue-700 transition ${loading ? 'opacity-50 cursor-not-allowed' : ''}`}
                                            >
                                                {loading ? <span className="animate-spin"><Icon name="loader" /></span> : <Icon name="save" />}
                                                GENERAR ORDEN
                                            </button>
                                        )}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* --- DISEÑO DE IMPRESIÓN (PAPELETAS) --- */}
                    {printData && (
                        <div className="print-only">
                            {/* 1. HOJA MAESTRA (Resumen Visual) */}
                            <div className="page-break w-full h-full border-4 border-black p-4 box-border">
                                <div className="flex justify-between items-start border-b-4 border-black pb-4 mb-4">
                                    <div className="flex items-center gap-4">
                                        <div className="w-24 h-24 border-2 border-black overflow-hidden">
                                            <SmartImage modelName={printData.model} className="w-full h-full object-contain filter grayscale contrast-125" />
                                        </div>
                                        <div>
                                            <h1 className="text-6xl font-black">{printData.model}</h1>
                                            <p className="text-xl font-bold uppercase">{printData.client}</p>
                                        </div>
                                    </div>
                                    <div className="text-right">
                                        <div className="text-4xl font-black">{printData.totalQty} <span className="text-lg">PZS</span></div>
                                        <p className="font-mono text-sm">{new Date().toLocaleDateString()}</p>
                                        <div className="mt-2 text-sm font-bold border border-black px-2 py-1 inline-block">ID: {printData.id.slice(0,6)}</div>
                                    </div>
                                </div>

                                <div className="mb-6">
                                    <h3 className="text-lg font-black bg-black text-white px-2 py-1 inline-block mb-2 uppercase">Desglose de Producción</h3>
                                    <table className="w-full border-collapse border border-black text-sm">
                                        <thead>
                                            <tr className="bg-gray-200">
                                                <th className="border border-black p-2 text-left">COMPONENTE</th>
                                                <th className="border border-black p-2 text-center">MÁQUINA</th>
                                                <th className="border border-black p-2 text-center">RATIO (Pzs/Lienzo)</th>
                                                <th className="border border-black p-2 text-center">LIENZOS TOTALES</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {printData.parts.map((part, i) => (
                                                <tr key={i}>
                                                    <td className="border border-black p-2 font-bold uppercase">{part.name}</td>
                                                    <td className="border border-black p-2 text-center font-bold text-xl">{part.machine}</td>
                                                    <td className="border border-black p-2 text-center">{part.ratio}</td>
                                                    <td className="border border-black p-2 text-center font-black">{part.bundlesNeeded}</td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>

                                {/* Generación de Etiquetas Recortables en la misma hoja o siguientes */}
                                <div className="mt-8">
                                    <h3 className="text-lg font-black bg-black text-white px-2 py-1 inline-block mb-4 uppercase">Etiquetas de Rastreo (Recortar)</h3>
                                    
                                    <div className="grid grid-cols-2 gap-4">
                                        {printData.parts.flatMap(part => 
                                            part.bundles.map(bundle => ({ ...bundle, partName: part.name, machine: part.machine, ratio: part.ratio }))
                                        ).map((ticket, idx) => (
                                            <TicketCard 
                                                key={idx} 
                                                orderId={printData.id} 
                                                model={printData.model} 
                                                part={ticket.partName} 
                                                machine={ticket.machine}
                                                bundleIndex={ticket.bundleIndex}
                                                uid={ticket.uid}
                                                qty={ticket.qtyInBundle}
                                            />
                                        ))}
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // Sub-componente para cada etiqueta individual (QR)
        const TicketCard = ({ orderId, model, part, machine, bundleIndex, uid, qty }) => {
            const canvasRef = React.useRef(null);

            React.useEffect(() => {
                if (canvasRef.current) {
                    // El código QR contiene: ID_ORDEN | ID_UNICO_BULTO
                    // Esto permite al escáner saber exactamente qué bulto es.
                    // Formato: Z-ORDENID-UID
                    JsBarcode(canvasRef.current, `Z-${orderId}-${uid}`, {
                        format: "CODE128",
                        height: 40,
                        displayValue: false,
                        margin: 0
                    });
                }
            }, [uid]);

            return (
                <div className="border-2 border-dashed border-gray-400 p-2 flex gap-2 break-inside-avoid">
                    <div className="flex-1">
                        <div className="flex justify-between items-start mb-1">
                            <span className="font-black text-2xl">{model}</span>
                            <span className="font-bold text-sm bg-black text-white px-1">{part}</span>
                        </div>
                        <div className="text-xs font-mono mb-1">MAQUINA <span className="text-xl font-black">{machine}</span></div>
                        <div className="text-xs">Lienzo {bundleIndex} | Cont: <b>{qty}</b> pzs</div>
                    </div>
                    <div className="flex flex-col items-center justify-center w-32">
                        <canvas ref={canvasRef} className="w-full"></canvas>
                        <span className="text-[10px] font-mono">{uid}</span>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>