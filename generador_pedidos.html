<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sistema Integral de Pedidos - Cirineo</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <style>
        body { background-color: #0f172a; color: white; -webkit-tap-highlight-color: transparent; font-family: sans-serif; }
        
        /* SOLUCIÓN AL SCROLL DE MENÚS DESPLEGABLES */
        .accordion-content {
            transition: max-height 0.3s ease-out, opacity 0.3s ease-out;
            overflow: hidden;
        }
        .accordion-closed { max-height: 0; opacity: 0; }
        .accordion-open { max-height: 1000px; opacity: 1; }

        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        .custom-scroll::-webkit-scrollbar { width: 4px; }
        .custom-scroll::-webkit-scrollbar-track { background: transparent; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }

        @keyframes pulse-soft {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        .loading-pulse { animation: pulse-soft 2s infinite; }
        
        .kit-mode-active {
            border: 2px solid #eab308 !important;
            background: rgba(234, 179, 8, 0.05);
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const firebaseConfig = {
            apiKey: "AIzaSyCngQL1pdqghv2vbjkPycT1Xf0C46f7jYs",
            authDomain: "cirineo-cec21.firebaseapp.com",
            projectId: "cirineo-cec21",
            storageBucket: "cirineo-cec21.firebasestorage.app",
            messagingSenderId: "620210618284",
            appId: "1:620210618284:web:482bab9bf74650fff18409"
        };

        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        const Icon = ({ name, size = 18, className = "" }) => {
            const r = useRef(null);
            useEffect(() => {
                if (r.current && lucide.icons[name]) {
                    r.current.innerHTML = lucide.icons[name].toSvg({
                        width: size,
                        height: size,
                        'stroke-width': 2.5
                    });
                }
            }, [name, size]);
            return <div ref={r} className={`inline-block ${className}`} style={{ width: size, height: size }}></div>;
        };

        const OrderGeneratorModal = ({ mode, initialData, onClose, onSaveSuccess }) => {
            const [formData, setFormData] = useState({
                cliente: '',
                codigo: '',
                partida: '',
                maquina: '',
                paquetes: 1,
                cantidadPorPaquete: 12,
                esKit: false
            });
            const [loading, setLoading] = useState(false);

            useEffect(() => {
                if (initialData) {
                    setFormData({
                        cliente: initialData.cliente || '',
                        codigo: initialData.codigo || '',
                        partida: initialData.partida || '',
                        maquina: initialData.maquina || '',
                        paquetes: initialData.progreso?.length || 1,
                        cantidadPorPaquete: initialData.progreso?.[0]?.cantidadPaquete || 12,
                        esKit: initialData.subPiecesData?.length > 0 || false,
                        // IMPORTANTE: Preservamos datos de inventario si existen
                        materiales: initialData.materiales || null
                    });
                }
            }, [initialData]);

            const handleSave = async () => {
                if (!formData.cliente || !formData.codigo || !formData.partida) {
                    alert("Faltan campos obligatorios");
                    return;
                }

                setLoading(true);
                try {
                    const progreso = [];
                    for(let i = 1; i <= formData.paquetes; i++) {
                        const labelType = formData.esKit ? "KIT" : "PZ";
                        progreso.push({
                            codigoUnico: `${formData.partida.toUpperCase()}_${labelType}_${i}_${formData.paquetes}`,
                            paqueteNum: i,
                            paquetesDePieza: formData.paquetes,
                            cantidadPaquete: formData.cantidadPorPaquete,
                            maquina: formData.maquina || '?',
                            timestamp: new Date().toISOString(),
                            finalizado: false
                        });
                    }

                    const payload = {
                        cliente: formData.cliente.toUpperCase(),
                        codigo: formData.codigo.toUpperCase(),
                        partida: formData.partida.toUpperCase(),
                        maquina: formData.maquina,
                        totalPiezas: formData.paquetes * formData.cantidadPorPaquete,
                        status: 'PENDIENTE',
                        createdAt: new Date().toISOString(),
                        progreso: progreso,
                        // El inventario de hilo se basa en el 'codigo' y 'totalPiezas'
                        // Preservamos el objeto de materiales para no romper el stock
                        materiales: formData.materiales || {},
                        subPiecesData: formData.esKit ? [{pieza: 'P1'}, {pieza: 'P2'}] : []
                    };

                    await db.collection('orders').add(payload);
                    onSaveSuccess();
                } catch (error) {
                    alert("Error al guardar: " + error.message);
                } finally {
                    setLoading(false);
                }
            };

            return (
                <div className="fixed inset-0 bg-black/90 backdrop-blur-md z-50 flex items-end sm:items-center justify-center p-0 sm:p-4">
                    <div className={`bg-slate-900 w-full max-w-lg rounded-t-[3rem] sm:rounded-[3rem] border-t sm:border border-slate-700 p-8 pb-12 sm:pb-8 transition-all ${formData.esKit ? 'kit-mode-active ring-2 ring-yellow-500' : ''}`}>
                        <div className="flex justify-between items-center mb-8">
                            <h2 className="text-2xl font-black italic tracking-tighter uppercase">
                                {mode === 'CREAR' ? 'Nuevo Pedido' : 'Copiar Pedido'}
                            </h2>
                            <button onClick={onClose} className="bg-slate-800 p-3 rounded-full text-slate-400">
                                <Icon name="x" size={20}/>
                            </button>
                        </div>

                        <div className="space-y-6">
                            <div className="grid grid-cols-2 gap-4">
                                <div className="col-span-2">
                                    <label className="text-[10px] font-bold text-slate-500 ml-4 mb-1 block uppercase tracking-widest">Cliente</label>
                                    <input 
                                        value={formData.cliente} 
                                        onChange={e => setFormData({...formData, cliente: e.target.value})}
                                        className="w-full bg-slate-800 border-none rounded-[1.5rem] p-4 text-white font-bold focus:ring-2 ring-blue-500 transition-all" 
                                        placeholder="EJ: CLIENTE MAYOREO"
                                    />
                                </div>
                                <div>
                                    <label className="text-[10px] font-bold text-slate-500 ml-4 mb-1 block uppercase tracking-widest">Modelo</label>
                                    <input 
                                        value={formData.codigo} 
                                        onChange={e => setFormData({...formData, codigo: e.target.value})}
                                        className="w-full bg-slate-800 border-none rounded-[1.5rem] p-4 font-bold" 
                                        placeholder="M001"
                                    />
                                </div>
                                <div>
                                    <label className="text-[10px] font-bold text-slate-500 ml-4 mb-1 block uppercase tracking-widest">Partida</label>
                                    <input 
                                        value={formData.partida} 
                                        onChange={e => setFormData({...formData, partida: e.target.value})}
                                        className="w-full bg-slate-800 border-none rounded-[1.5rem] p-4 font-bold" 
                                        placeholder="ENE01"
                                    />
                                </div>
                            </div>

                            <div 
                                onClick={() => setFormData({...formData, esKit: !formData.esKit})}
                                className={`p-4 rounded-[1.5rem] border transition-all cursor-pointer flex justify-between items-center ${formData.esKit ? 'bg-yellow-500/10 border-yellow-500 text-yellow-500' : 'bg-slate-800 border-transparent text-slate-400'}`}
                            >
                                <div className="flex items-center gap-3">
                                    <Icon name="package" size={20}/>
                                    <span className="font-bold text-sm uppercase">¿Es un Kit de varias piezas?</span>
                                </div>
                                <div className={`w-10 h-6 rounded-full relative transition-colors ${formData.esKit ? 'bg-yellow-500' : 'bg-slate-600'}`}>
                                    <div className={`absolute top-1 w-4 h-4 bg-white rounded-full transition-all ${formData.esKit ? 'left-5' : 'left-1'}`}></div>
                                </div>
                            </div>

                            <div className="grid grid-cols-3 gap-4">
                                <div className="bg-slate-800 p-4 rounded-[2rem] text-center border border-slate-700">
                                    <span className="text-[9px] font-bold text-slate-500 block mb-1 uppercase">Bultos</span>
                                    <input type="number" value={formData.paquetes} onChange={e => setFormData({...formData, paquetes: parseInt(e.target.value) || 1})} className="w-full bg-transparent text-center text-2xl font-black outline-none" />
                                </div>
                                <div className="bg-slate-800 p-4 rounded-[2rem] text-center border border-slate-700">
                                    <span className="text-[9px] font-bold text-slate-500 block mb-1 uppercase">Pz / Bulto</span>
                                    <input type="number" value={formData.cantidadPorPaquete} onChange={e => setFormData({...formData, cantidadPorPaquete: parseInt(e.target.value) || 1})} className="w-full bg-transparent text-center text-2xl font-black outline-none" />
                                </div>
                                <div className="bg-slate-800 p-4 rounded-[2rem] text-center border border-blue-500/40">
                                    <span className="text-[9px] font-bold text-blue-400 block mb-1 uppercase">Máquina</span>
                                    <input value={formData.maquina} onChange={e => setFormData({...formData, maquina: e.target.value})} className="w-full bg-transparent text-center text-2xl font-black outline-none text-blue-400" placeholder="?" />
                                </div>
                            </div>

                            <button 
                                onClick={handleSave}
                                disabled={loading}
                                className={`w-full py-5 rounded-[2.2rem] font-black text-lg shadow-2xl active:scale-95 transition-all flex items-center justify-center gap-3 ${formData.esKit ? 'bg-yellow-500 text-black' : 'bg-blue-600 text-white'}`}
                            >
                                {loading ? 'GUARDANDO...' : 'CONFIRMAR PEDIDO'}
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        const App = () => {
            const [orders, setOrders] = useState([]);
            const [editor, setEditor] = useState({ isOpen: false, mode: 'CREAR', data: null });
            const [isHistoryOpen, setIsHistoryOpen] = useState(false);

            useEffect(() => {
                const unsub = db.collection('orders').orderBy('createdAt', 'desc').onSnapshot(snap => {
                    setOrders(snap.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                });
                return () => unsub();
            }, []);

            const toggleArchive = async (order) => {
                await db.collection('orders').doc(order.id).update({
                    status: order.status === 'ARCHIVADO' ? 'PENDIENTE' : 'ARCHIVADO'
                });
            };

            const activeOrders = orders.filter(o => o.status !== 'ARCHIVADO');
            const archivedOrders = orders.filter(o => o.status === 'ARCHIVADO');

            return (
                <div className="max-w-xl mx-auto min-h-screen flex flex-col p-6">
                    <header className="flex justify-between items-center py-8">
                        <h1 className="text-3xl font-black italic tracking-tighter leading-none">CIRINEO <span className="text-blue-500">PRO</span></h1>
                        <button onClick={() => setEditor({ isOpen: true, mode: 'CREAR', data: null })} className="w-14 h-14 bg-white text-black rounded-full flex items-center justify-center shadow-2xl active:scale-90 transition-all">
                            <Icon name="plus" size={28}/>
                        </button>
                    </header>

                    <div className="flex-grow space-y-4">
                        <div className="flex items-center gap-3 mb-4">
                            <div className="h-[2px] flex-grow bg-slate-800"></div>
                            <span className="text-[10px] font-black text-slate-500 tracking-widest uppercase">Órdenes Activas ({activeOrders.length})</span>
                            <div className="h-[2px] flex-grow bg-slate-800"></div>
                        </div>

                        {activeOrders.map(o => (
                            <div key={o.id} className="bg-slate-900 p-6 rounded-[2.5rem] border border-slate-800 flex justify-between items-center group relative overflow-hidden">
                                {o.subPiecesData?.length > 0 && <div className="absolute top-0 right-0 bg-yellow-500 text-black text-[9px] font-black px-4 py-1 rounded-bl-xl">MODO KIT</div>}
                                <div>
                                    <div className="text-[10px] font-bold text-slate-500 mb-1 uppercase tracking-widest">{o.cliente}</div>
                                    <div className="text-2xl font-black uppercase leading-none mb-2">{o.codigo}</div>
                                    <div className="flex items-center gap-3 font-bold text-slate-400">
                                        <span className="text-blue-500 font-mono text-xs">{o.partida}</span>
                                        <span>•</span>
                                        <span className="text-xs">{o.totalPiezas} PZ</span>
                                    </div>
                                </div>
                                <div className="flex gap-2">
                                    <button onClick={() => setEditor({ isOpen: true, mode: 'COPIAR', data: o })} className="w-12 h-12 bg-slate-800 rounded-2xl flex items-center justify-center text-blue-400"><Icon name="copy" size={20}/></button>
                                    <button onClick={() => toggleArchive(o)} className="w-12 h-12 bg-slate-800 rounded-2xl flex items-center justify-center text-slate-500 hover:text-red-400"><Icon name="archive" size={20}/></button>
                                </div>
                            </div>
                        ))}
                    </div>

                    {/* ACORDEÓN DE HISTORIAL ORIGINAL */}
                    <div className="mt-12">
                        <button 
                            onClick={() => setIsHistoryOpen(!isHistoryOpen)}
                            className="w-full bg-slate-800/50 p-6 rounded-[2rem] flex justify-between items-center border border-slate-800"
                        >
                            <span className="font-bold text-slate-400 flex items-center gap-3 italic"><Icon name="history"/> VER HISTORIAL ARCHIVADO</span>
                            <Icon name={isHistoryOpen ? "chevron-up" : "chevron-down"} className="text-slate-500" />
                        </button>
                        
                        <div className={`accordion-content ${isHistoryOpen ? 'accordion-open' : 'accordion-closed'}`}>
                            <div className="pt-4 space-y-3">
                                {archivedOrders.map(o => (
                                    <div key={o.id} className="bg-slate-900/50 p-5 rounded-[2rem] border border-slate-800/50 flex justify-between items-center opacity-60 grayscale hover:grayscale-0 hover:opacity-100 transition-all">
                                        <div>
                                            <div className="font-bold text-slate-400 text-lg uppercase tracking-tight">{o.codigo}</div>
                                            <div className="text-[10px] font-bold text-slate-600">{o.partida} • {o.cliente}</div>
                                        </div>
                                        <div className="flex gap-2">
                                            <button onClick={() => setEditor({ isOpen: true, mode: 'COPIAR', data: o })} className="p-3 bg-slate-800 rounded-xl text-blue-400"><Icon name="copy"/></button>
                                            <button onClick={() => toggleArchive(o)} className="p-3 bg-slate-800 rounded-xl text-green-400"><Icon name="rotate-ccw"/></button>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    </div>

                    {editor.isOpen && (
                        <OrderGeneratorModal 
                            mode={editor.mode} 
                            initialData={editor.data} 
                            onClose={() => setEditor({ isOpen: false, mode: 'CREAR', data: null })} 
                            onSaveSuccess={() => setEditor({ isOpen: false, mode: 'CREAR', data: null })} 
                        />
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>